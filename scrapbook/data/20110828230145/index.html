<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <title>保护模式 对CPL，RPL，DPL的总结 - w5543081的专栏 - 博客频道 - CSDN.NET</title>
    
    <meta name="description" content="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 学习过程中遇到一个对保护模式总结很好的Blog，转来分享一下。先说下特权级的概念,在保护模式下,系统依靠特权级来实施代码和数据的保护,相当于权限啦。特权级共有4个级别,0,1,2,3,数字越小表示权限越高。如图:较为核心的代码和数据放在较高(靠内)的层级中,处理器用此来防止较低特权的任务在不被允许的情况下访问处于高特权级的段。为了防止概念混淆，我们不用特权级大小来说明，改为内层(高)，外层(低)来讲。特权级有3种：CPL,DPL和RP">
    
    
    
    
    <link id="RSSLink" title="RSS" type="application/rss+xml" rel="alternate" href="http://blog.csdn.net/w5543081/rss/list">
    <link rel="shortcut icon" href="favicon.ico">
    
    
    

<link rel="stylesheet" type="text/css" href="index.css" media="all">
</head>
<body>
    
<div class="nav_top_2011">
<p><span style="color: red;">您还未登录！</span>|<a href="http://passport.csdn.net/UserLogin.aspx">登录</a>|<a href="http://passport.csdn.net/CSDNUserRegister.aspx">注册</a>|<a href="http://passport.csdn.net/help/faq">帮助</a></p><ul>
<li><a href="http://www.csdn.net/" target="_top">CSDN首页</a></li>
<li><a href="http://news.csdn.net/" target="_top">资讯</a></li>
<li><a href="http://bbs.csdn.net/" target="_top">论坛</a></li>
<li><a href="http://blog.csdn.net/" target="_top">博客</a></li>
<li><a href="http://download.csdn.net/" target="_top">下载</a></li>
<li><a href="http://so.csdn.net/" target="_top">搜索</a></li>
<li class="more"><h2 id="topnav_btnmore"><a href="javascript:void(0);">更多</a></h2>
<ul id="topnav_hidlist">
<li><a href="http://cto.csdn.net/" target="_top">CTO俱乐部</a></li>
<li><a href="http://student.csdn.net/" target="_top">学生大本营</a></li>
<li><a href="http://edu.csdn.net/" target="_top">培训充电</a></li>
<li><a href="http://mobile.csdn.net/" target="_top">移动开发</a></li>
<li><a href="http://sd.csdn.net/" target="_top">软件研发</a></li>
<li><a href="http://cloud.csdn.net/" target="_top">云计算</a></li>
<li><a href="http://www.programmer.com.cn/" target="_top">程序员</a></li>
<li><a href="http://tup.csdn.net/" target="_top">TUP</a></li>
</ul>
</li>
</ul>
</div>


    <div id="container">
        <div id="header">
    <div class="header">
        <div id="blog_title">
            <h1>
                <a href="http://blog.csdn.net/w5543081">w5543081的专栏</a></h1>
            <h2></h2>
            <div class="clear">
            </div>
        </div>
        <div class="clear">
        </div>
    </div>
</div>
<div id="navigator">
    <div class="navigator_bg">
    </div>
    <div class="navigator">
        <ul>
            <!--<li id="btnHome"><a href="/w5543081"><span><img src="http://static.blog.csdn.net/images/ico_home.gif">我的首页</span></a></li>-->
            <li id="btnContents"><a href="http://blog.csdn.net/w5543081?viewmode=contents"><span><img src="ico_list.gif">目录视图</span></a></li>
            <li id="btnView"><a href="http://blog.csdn.net/w5543081?viewmode=list"><span><img src="ico_summary.gif">摘要视图</span></a></li>
            <li id="btnRss"><a href="http://blog.csdn.net/w5543081/rss/list"><span><img src="ico_rss.gif">订阅</span></a></li>
</ul>
    </div>
</div>

        
        <div id="body">
            <div id="main">
                <div class="main">
                <div class="notice"><font size="2">
<a href="http://blog.csdn.net/blogdevteam/article/details/6714855" target="_top"><font color="red">CSDN&amp;ITeye招贤榜</font></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<a href="http://blog.csdn.net/csdnproduct/article/details/6702483" target="_top"><font color="red">新版下载频道用户权限及积分规则详解</font></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<a href="http://g.csdn.net/5193964" target="_top"><font color="red">bShare分享，迅速提升10倍流量</font></a>
</font></div>
                

<div id="article_details" class="details">
    <div class="article_title">
    <span class="ico ico_type_Repost"></span>
    <h3>
        <span class="link_title"><a href="http://blog.csdn.net/w5543081/article/details/3278008" title="[置顶]保护模式 对CPL，RPL，DPL的总结">[置顶]保护模式 对CPL，RPL，DPL的总结</a></span>
        
    </h3>
</div>

        
    <div class="article_manage">
    <span class="link_postdate">2008-11-11 17:18</span>
    <span class="link_view" title="阅读次数">1495人阅读</span>
    <span class="link_comments" title="评论次数"><a href="#comments">评论</a>(1)</span>
    <span class="link_collect"><a href="javascript:void(0);" onclick="javascript:collectArticle('[置顶]保护模式 对CPL，RPL，DPL的总结','3278008');return false;" title="收藏">收藏</a></span>
    <span class="link_report"><a href="#report" onclick="javascript:report(3278008,2);return false;" title="举报">举报</a></span>
    
</div>

    
<div class="article_content">
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 学习过程中遇到一个对保护模式总结很好的Blog，转来分享一下。</p>
<p>先说下特权级的概念,在保护模式下,系统依靠特权级来实施代码和数据的保护,相当于权限啦。特权级共有4个级别,0,1,2,3,数字越小表示权限越高。如图:<br></p>
<div forimg="1"><img class="blogimg" src="cba527ca1738fa94c81768da.jpg" small="0" border="0" height="241" width="344"><br>较为核心的代码和数据放在较高(靠内)的层级中,处理器用此来防止较低特权的任务在不被允许的情况下访问处于高特权级的段。为了防止概念混淆，我们不用特权级大小来说明，改为内层(高)，外层(低)来讲。</div>
<p><strong><font size="4">特权级有3种</font></strong>：<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>,<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>和<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>，每个都是有4个等级。<br><font color="#008080"><strong>我对他们的<a name="baidusnap5"></a><b style="color: white; background-color: rgb(136, 0, 0);">关系</b>理解是这样：一般来说，<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>代表当前代码段的权限，如果它想要去访问一个段或门，首先要看看对方的权限如何，也就是检查对方的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>，如果满足当前的权限比要访问的权限高，则有可能允许去访问，有些情况我们还要检查<br>选择子的权限，即<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>,因为我们通过选择子:偏移量的方式去访问一个段，这算是一个访问请求动作，因此<br>称为请求访问权限<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>(Requst Privilege Level)。当请求权限也满足条件，那么访问就被允许了。</strong></font><br><br><font size="4"><strong><b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>(Current Privilege Level)<br><font size="2"><b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>是当前执行的任务的特权等级，它存储在CS和SS的第0位和第1位上。(两位表示0~3四个等级)<br>通常情况下，<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>等于代码所在段的特权等级，当程序转移到不同的代码段时，处理器将改变<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>。<br>注意:在遇到<a name="baidusnap0"></a><b style="color: black; background-color: rgb(255, 255, 102);">一致代码</b>段时，情况特殊，<b style="color: black; background-color: rgb(255, 255, 102);">一致代码</b>段的特点是：可以被<font color="#ff0000">等级相同或者更低特权级</font>的代码访问，当处理器访问一个与当前代码段<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>特权级不同的<b style="color: black; background-color: rgb(255, 255, 102);">一致代码</b>段时，<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>不会改变。<br></font></strong></font><font size="4"><strong><font size="2"><br><font size="4"><b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>(Descriptor Privilege Level)</font><br>表示门或者段的特权级，存储在门或者段的描述符的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>字段中。正如上面说的那样，当当前代码段试图访问一个段或者门时，其<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>将会和当前特权级<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>以及段或门的选择子比较，根据段或者门的类型不同，<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>的含义不同：<br>&nbsp;&nbsp;&nbsp; 1.数据段的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>：规定了访问此段的最低权限。比如一个数据段的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>是1，那么只有运行在<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>为0或1的程序才可能访问它。为什么说可能呢？因为还有一个比较的因素是<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>。访问数据段要满足有<font color="#800000"><font color="#ff0000">效特权级别</font>（上述）</font>高于数据段的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>.<br>&nbsp;&nbsp;&nbsp; 2.非<b style="color: black; background-color: rgb(255, 255, 102);">一致代码</b>段的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>(不使用调用门的情况)：<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>规定访问此段的特权，只有<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>与之相等才有可能访问。<br>&nbsp;&nbsp;&nbsp; 3.调用门的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>，规定了程序或任务访问该门的最低权限。与数据段同。<br>&nbsp;&nbsp;&nbsp; 4.<b style="color: black; background-color: rgb(255, 255, 102);">一致代码</b>段和通过调用门访问的非<b style="color: black; background-color: rgb(255, 255, 102);">一致代码</b>段，<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>规定访问此段的最高权限。<br>&nbsp;&nbsp;&nbsp;&nbsp; 比如一个段的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>为2，那么<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>为0或者1的程序都无法访问。<br>&nbsp;&nbsp; 5. TSS的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>，同数据段。<br><font size="4"><br><b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>（Rquest Privilege Level）</font><br><b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>是通过选择子的低两位来表现出来的(<font color="#339966">这么说来，CS和SS也是存放选择子的，同时<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>存放在CS和SS的低两位上，那么对CS和SS来说，选择子的<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>=当前段的<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b></font>)。处理器通过检查<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>和<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>来确认一个访问是否合法。即提出访问的段除了有足够的特权级<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>，如果<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>不够也是不行的(有些情况会忽略<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>检查)。<br><font style="background-color: rgb(255, 255, 255);" color="#3366ff" size="4">为什么要有<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>？</font><br>操作系统往往通过设置<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>的方法来避免低特权级的应用程序访问高特权级的内层数据。<br><font color="#3366ff">例子情景：调用者调用操作系统的某过程去访问一个段。<br>当操作系统(被调用过程)从应用程序(调用者)接受一个选择子时，会把选择子的<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>设置称调用者的权限等级，于是操作系统用这个选择子去访问相应的段时(这时<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>为操作系统的等级,因为正在运行操作系统的代码)，处理器会使用调用者的特权级去进行特权级检查，而不是正在实施访问动作的操作系统的特权级(<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>)，这样操作系统就不用以自己的身份去访问(就防止了应用去访问需要高权限的内层数据,除非应用程序本身的权限就足够高)。<br>那么<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>的作用就比较明显了：因为同一时刻只能有一个<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>，而当低权限的应用去调用拥有至高权限的操作系统的功能来访问一个目标段时，进入操作系统代码段时<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>变成了操作系统的<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>，如果没有<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>，那么权限检查的时候就会用<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>，而这个<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>权限比应用程序高，也就可能去访问需要高权限才能访问的数据，这就不安全了。所以引入<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>，让它去代表访问权限，因此在检查<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>的同时，也会检查<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>.一般来说如果<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>的数字比<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>大(权限比<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>的低)，那么<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>会起决定性作用。<br></font>说这么多不明白都不行啦~真累<br><font size="5">下面是引用的一个超棒的关于权限控制的总结：<br><a href="http://blog.chinaunix.net/u/11773/showart.php?id=368316" target="_top"><u><font color="#0000ff">引用地址</font></u></a><br>还有一篇文章<a href="http://bbs.gd-emb.org/archive/?/t-8890.html" target="_top"><u><font color="#0000ff">在此</font></u></a>。<br></font></font></strong></font></p>
<div>■ 数据访问时的权限check</div>
<div><br>一、 访问data segment时（ds、es、fs 及gs）<br>1、 程序指令要访问数据时，data segment selector 被加载进 data segment register（ds、es、fs 和 gs）前，处理器会进行一系列的权限检查，通过了才能被加载进入segment register。处理器分为两步进行检查：<br>★ <b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>（当前程序运行的权限级别）与<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>（位于selector中的 <b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>）作比较，并设置有效权限级别为低权限的一个。<br>★ 得出的有效权限级别与<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>（segment descriptor 中的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>）作比较，有效权限级别高于<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>，那么就通过。低于就不允许访问。</div>
<div></div>
<div>2、举个例子：<br>如果：<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> = 3、<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> = 2、<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b> = 2。那么</div>
<div>
<table style="border-collapse: collapse;" bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" width="95%">
<tbody>
<tr>
<td><code><span style="color: rgb(0, 0, 0);">
<div>EPL = <b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &gt; <b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> ? <b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> : <b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>;<br>if (EPL &lt;= <b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>) {<br>/* 允许访问 */<br>} else {<br>/* 失败，#GP 异常生产，执行异常 */</div>
<div>}</div>
<div></div>
<div>或者：<br>if ((<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &lt;= <b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>) &amp;&amp; (<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> &lt;= <b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>)) {<br>/* 允许访问 */<br>} else {<br>/* 失败，#GP 异常生产，执行异常 */<br>}</div></span></code></td></tr></tbody></table></div>
<p>&nbsp;&nbsp; 也就是要访问目标data segment，那么必须要有足够的权限，这个足够的权限就是：当前运行的权限级别及选择子的请求权限级别要高于等于目标data segment的权限级别。</p>
<p></p>
<p>二、 访问stack segment时<br>1、 该问stack 时的权限检查更严格，<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>、<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>及<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>三者必须相等才能通过该问请求。</p>
<p>2、 举个例子：</p>
<p></p>
<p>
</p><table style="border-collapse: collapse;" bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" width="95%">
<tbody>
<tr>
<td><code><span style="color: rgb(0, 0, 0);">
<div>if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> == <b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> &amp;&amp; <b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> == <b style="color: black; background-color: rgb(255, 102, 255);">DPL</b> &amp;&amp; <b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> == <b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 允许访问 */<br>} else {<br>&nbsp;&nbsp;&nbsp;&nbsp; /* 失败，#GP 异常生产，执行异常 */<br>}</div></span></code></td></tr></tbody></table><p></p>
<p><font size="2">也就是说每个权限级别有相对应的statck segment。不能越权访问，即使高权限访问低权限也是被拒绝的</font></p>
<p></p>
<p></p>
<p></p>
<p>■ 控制权的转移及权限检查。</p>
<p>&nbsp;&nbsp; 权限检查的4个要素:</p>
<p>★ <b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>：处理器当前运行的级别，也就是：当前 CS 的级别，在 CS 的 BIT0 ~ Bit1</p>
<p>★ <b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>：访问目标代码段所需的级别。定义在 segment descriptor 的 <b style="color: black; background-color: rgb(255, 102, 255);">DPL</b> 域中</p>
<p>★ <b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>: 通过 selector 进行访问时，selector 内定义的级别。</p>
<p>★ conforming/nonconforming：目标代码属于 nonconforming 还是 conforming 定义在segment descritptor 的 C 标志位中</p>
<p><font color="#ff0000"><strong>x86 的各方面检查依赖于目标代码段是 nonconforming(不一致) 还是 conforming</strong>(一致)</font> 类型</p>
<p><br>一、 直接转移（far call 及 far jmp）<br>&nbsp;&nbsp;&nbsp; 1、 直接转移定义为不带gate selector或 taskselector的远调用。当执行一条 call cs:eip 或 jmp cs:eip 指令时，cs 是目标代码段的selector，处理器在加载指令操作数中的cs进cs register前，要进行一系列的权限检查，控制权的转移权限分两部分，根据目标代码段descriptor定义的两种情况：<br>1）、nonconforming target code segment<br>★ 直接转移后的权限级别是不能必改变的。因此，<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> 必须要等于目标代码段的 <b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>。<br>★ 要有足够的请求权限进行访问。因此，目标代码段选择子的<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> &lt;= <b style="color: black; background-color: rgb(153, 255, 153);">CPL</b></p>
<p>2）、conforming target code segment<br>★ conforming code segment 允许访问高权限级别的代码。这里只需检查 <b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &gt;= <b style="color: black; background-color: rgb(255, 102, 255);">DPL</b> 即可，<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> 忽略不检查。<br>★ 转移后<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>不会改变。</p>
<p>&nbsp;&nbsp; 2、 以上两步通过后，处理器加载目标代码段的CS 进入CS register，但权限级别不改变，继而<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>被忽略。</p>
<p>★ 处理器根据CS selector在相应的descriptor table 找到 code segment descriptor。CS 的Bit2（TI域） 指示在哪个descriptor table 表查找，CS.TI = 0 时在GDT查找，CS.TI = 1时在LDT 查找。<br>★ CS的Bit15~Bit3 是selector index 值，处理器基于GDT或LDT来查找segment descriptor。具体是：GDTR.base 或 LDTR.base + CS.SI × 8 得出code segment descritpro。<br>★ 处理器自动加载code segment descriptor 的 base address、segment limit及attribute 域进入 CS register的相应的隐藏域。<br>★ 转到CS.base + eip 处执行指令</p>
<p>总结：用代码形式来说明直接转移 call cs:eip 这条指令<br>例： call 1a:804304c （即cs = 1a, eip = 804304c）</p>
<p></p>
<p>
</p><table style="border-collapse: collapse;" bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" width="95%">
<tbody>
<tr>
<td><code><span style="color: rgb(0, 0, 0);">
<div>target_cs = 1a;<br>target_eip = 0x0804304c;<br><b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> = CS.<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 当前执行的代码段的权限级别就是<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> */<br><b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> = target_cs.<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>;&nbsp;&nbsp;&nbsp;&nbsp; /* 目标段 selector 的低3位是<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> */<br>target_si = target_cs.SI;&nbsp;&nbsp;&nbsp; /* 目标段 selector 的索引是Bit15~Bit3 */<br>target_ti = target_cs.TI;&nbsp;&nbsp;&nbsp; /* 目标段selector的描述符表索引是Bit2 */</div>
<div>CODESEG_DESCRIPTOR target_descriptor;</div>
<div><br>if (target_ti == 0) { /* target_cs.TI为0 就是参考到 GDT（全局描述符表） */<br>/* 以GDTR寄存器的base 为基地址加上selector的索引乘以8即得出目标<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 段描述符，目标描述符的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>就是目标段所需的访问权限 */<br>&nbsp;&nbsp;&nbsp; target_descriptor = GDTR.base + target_si * 8</div>
<div><br>} else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 否则就是参考 LDT （局部描述符表）*/<br>&nbsp;&nbsp;&nbsp; /* 以 LDTR寄存器的base 为基地址得出目标段描述符 */</div>
<div><br>target_descriptor = LDTR.base + target_si * 8;<br>}</div>
<div></div>
<div><b style="color: black; background-color: rgb(255, 102, 255);">DPL</b> = target_descriptor.<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>;&nbsp;&nbsp;&nbsp;&nbsp; /* 获取<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b> */</div>
<div></div>
<div>if (target_descriptor.type &amp; 0x06) { /* conforming */<br>if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &gt;= <b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>) {&nbsp;&nbsp; /* 允许执行高权限代码 */<br>&nbsp;&nbsp;&nbsp;&nbsp; /* go ahead */<br>&nbsp;&nbsp;&nbsp; } else {<br>&nbsp;&nbsp;&nbsp;&nbsp; /* 引发 #GP 异常 */<br>&nbsp;&nbsp;&nbsp; goto DO_GP_EXCEPTION;<br>}<br><br>} else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* nonconforming */<br>&nbsp;&nbsp;&nbsp; if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> == <b style="color: black; background-color: rgb(255, 102, 255);">DPL</b> &amp;&amp; <b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> &lt;= <b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>) {&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* go ahead */<br>&nbsp;&nbsp;&nbsp; } else {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 引发 #GP 异常 */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto DO_GP_EXCEPTION;<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp; <br>}</div>
<div></div>
<div>/****** go ahead … …******/<br>CS = target_cs; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; /* 加载目标段CS 进入 CS 寄存器 */<br>EIP = target_eip;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 加载目标指令EIP 进入 EIP 寄存器 */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 当前执行权限 <b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> 不改变 */</div>
<div><br>goto target_descriptor.base + target_eip; /* 跳转到目标地址执行 */</div>
<div></div>
<div><br>DO_GP_EXCEPTION:&nbsp;&nbsp;&nbsp;&nbsp; /* 执行 #GP异常点 */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; … …</div></span></code></td></tr></tbody></table><p></p>
<p></p>
<p></p>
<p>二、 使用call gate 进行控制权的转移<br>使用call gate进行转移控制，目的是建立一个利用gate进行向高权限代码转移的一种保护机制。gate符相当一个进入高权限代码的一个通道。</p>
<p><br>对于指令 call cs:eip 来说：<br>★ 目标代码的selector是一个门符的选择子。用来获取门描述符。<br>★ 门描述符含目标代码段的selector及目标代码的偏移量。<br>★ 目标代码的ip值被忽略。因为门符已经提供了目标代码的偏移量。<br><br>1、 权限的检查<br>★ 首先，必须要有足够的权限来访问gate符，所以：<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &lt;= DPLg（门符的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>）且：<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> &lt;= DPLg<br>★ 进前代码向高权限代码转移，所以，对于conforming类型的代码段来说，必须<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &gt;= DPLs（目标代码段的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>）<br>★ 对于nonconforming类型代码段来说，必须<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> = DPLs<br>★ call 指令改变当前权限，而jmp指令不改变当前权限。</p>
<p>总结:</p>
<p></p>
<p>
</p><table style="border-collapse: collapse;" bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" width="95%">
<tbody>
<tr>
<td><code><span style="color: rgb(0, 0, 0);">
<div>if ((<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &lt;= DPLg) &amp;&amp; (<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> &lt;= DPLg)) { /* 足够的权限访问门符 */<br>if (target.C == CONFORMING) {&nbsp;&nbsp; /* 目标代码属于 conforming类型 */<br>&nbsp;&nbsp;&nbsp; /* 向高权限级别代码转移控制 */<br>&nbsp;&nbsp;&nbsp; if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &gt;= DPLs) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 通过访问 */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 失败，#Gp异常发生 */<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; } else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 目标代码属于 nonconforming 类型 */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 平级转移 */<br>&nbsp;&nbsp;&nbsp; if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> == DPLs) {<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; /* 通过访问 */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 失败，#GP 异常发生 */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>}</div>
<div><br>} else {&nbsp;&nbsp; /* 没有足够权限访问门符 */<br>/* #GP 异常发生 */<br>}</div></span></code></td></tr></tbody></table><p></p>
<p></p>
<p><font size="2">2、 控制权的转移<br>指令：call 1a:804304c （其中1a是call gate selector）</font></p>
<p></p>
<p>
</p><table style="border-collapse: collapse;" bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" width="95%">
<tbody>
<tr>
<td><code><span style="color: rgb(0, 0, 0);">
<div>gate_selector = 0x1a;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* call gate selector */<br><b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> = gate_selector.<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 门符选择子<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> */<br><b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> = CS.<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 当前代码段低3位是<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>*/</div>
<div>CALLGATE_DESCRIPTOR call_gate_descriptor;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 门符的描述符 */<br>CODESEG_DESCRIPTOR target_cs_descritpor;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 目标代码段的描述符 */</div>
<div>call_gate_si = gate_selector.SI;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 门符 selector 的索引 */<br>call_gate_ti = gate_selector.TI;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 门符selector的描述符表索引 */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>/* 获取call gate descriptor */<br>if (call_gate_ti == 0) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* TI为0 就是参考到 GDT（全局描述符表） */<br>/* 以GDTR寄存器的base 为基地址加上selector的索引乘以8即得出门符的描述符，门符的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>就是门符的访问权限 */<br>&nbsp;&nbsp;&nbsp; call_gate_descriptor = GDTR.base + call_gate_si * 8;<br>} else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 否则就是参考 LDT （局部描述符表）*/<br>&nbsp;&nbsp;&nbsp;&nbsp; /* 以 LDTR寄存器的base 为基地址得出目标段描述符 */<br>call_gate_descriptor = LDTR.base + call_gate_si * 8;<br>}</div>
<div><br>/* 获取 target code segment descriptor */</div>
<div>target_cs = call_gate_descriptor.selector;&nbsp;&nbsp;&nbsp; /* 获取门符的目标代码段选择子 */<br>target_cs_si = target_cs.SI; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 目标代码段的索引 */<br>target_cs_ti = target_cs.TI;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 目标代码描述符表索引 */</div>
<div>if (target_cs_ti == 0) <br>&nbsp;&nbsp;&nbsp; target_cs_descriptor = GDTR.base + target_cs_si * 8;<br>else <br>&nbsp;&nbsp;&nbsp; target_cs_descriptor = LDTR.base + target_cs_si * 8;</div>
<div><br>DPLg = call_gate_descriptor.<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>;&nbsp;&nbsp;&nbsp;&nbsp; /* 获取门符的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b> */<br>DPLs = target_cs_descriptor.<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>;&nbsp;&nbsp;&nbsp;&nbsp; /* 获取目标代码段的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b> */</div>
<div><br>if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &lt;= DPLg &amp;&amp; <b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> &lt;= DPLg) {&nbsp;&nbsp; /* 有足够权限访问门符 */<br>&nbsp;&nbsp;&nbsp;&nbsp; if (target_cs_descriptor.type &amp; 0x06) { /* conforming */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &gt;= DPLs) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 允许访问目标代码段 */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* #GP 异常产生 */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; } else if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> == DPLs) { /* nonconforming */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 允许访问目标代码段 */<br>&nbsp;&nbsp;&nbsp;&nbsp; } else {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 拒绝访问，#GP 异常发生 */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto DO_GP_EXCEPTION;<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>} else { /* 无权限访问门符 */<br>&nbsp;&nbsp;&nbsp;&nbsp; /* 拒绝访问， #GP异常发生 */<br>&nbsp;&nbsp;&nbsp;&nbsp; goto DO_GP_EXCEPTION;<br>}</div>
<div></div>
<div>/* 允许访问 */<br>current_CS = target_cs;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 加载目标代码段进入CS 寄存器 */<br>current_CS.<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> = DPLs;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 改变当前执行段权限 */<br>current_EIP = call_gate_descriptor.offset;&nbsp;&nbsp; /* 加载EIP */</div>
<div></div>
<div>/* 跳转到目标代码执行 */<br>/* goto current_CS:current_EIP */<br>goto target_cs_descriptor.base + call_gate_descriptor.offset;</div>
<div></div>
<div>return;</div>
<div></div>
<div>DO_GP_EXCEPTION:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 执行异常 */</div></span></code></td></tr></tbody></table><p></p>
<p></p>
<p></p>
<p>三、 使用中断门或陷井门进行转移<br>&nbsp;&nbsp; 中断门符及陷井门必须存放在IDT中，IDT表也可以存放call gate。</p>
<p>1、 中断调用时的权限检查<br>&nbsp;&nbsp; 用中断门符进行转移时，所作的权限检查同call gate相同，区别在于intterrupt gate 转移不需要检查<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>，因为，没有<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>需要检查。<br>★ 必须有足够的权限访问门符，<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &lt;= DPLg<br>★ 向同级权限代码转移时，<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> == DPLs，向高权限代码转移时，<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &gt; DPLs</p>
<p>总结</p>
<p></p>
<p>
</p><table style="border-collapse: collapse;" bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" width="95%">
<tbody>
<tr>
<td><code><span style="color: rgb(0, 0, 0);">
<div>if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &lt;= DPLg) { /* 有足够权限访问门符 */<br>&nbsp;&nbsp;&nbsp; if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &gt;= DPLs) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 允许访问目标代码头 */<br>&nbsp;&nbsp;&nbsp; } else {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 失败，#GP异常发生 */<br>&nbsp;&nbsp;&nbsp; }</div>
<div><br>} else {<br>/* 失败，#GP异常发生 */<br>}</div></span></code></td></tr></tbody></table><p></p>
<p>2、 控制权的转移<br>&nbsp;&nbsp; 发生异常或中断调用时<br>★ 用中断向量在中断描述符表查找描述符：中断向量×8，然后加上IDT表基址得出描述符表。<br>★ 从查找到的描述符中得到目标代码段选择子，并在相应的GDT或LDT中获取目标代码段描述符。<br>★ 目标代码段描述符的基址加上门符中的offset，确定最终执行入口点。</p>
<p><br>中断或陷井门符转移的总结：<br>例： int 0x80 指令发生的情况</p>
<p></p>
<p>
</p><table style="border-collapse: collapse;" bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" width="95%">
<tbody>
<tr>
<td><code><span style="color: rgb(0, 0, 0);">
<div>vector = 0x80;<br>INTGATE_DESCRIPTOR gate_descriptor = IDTR.base + vector * 8;<br>CODESEG_DESCRIPTOR target_descriptor;<br>TSS tss = TR.base;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 得到TSS 内存块 */<br>DPLg = gate_descriptor.<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>;<br>target_cs = gate_descriptor.selector;</div>
<div></div>
<div>if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &lt;= DPLg) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 允许访问门符 */</div>
<div><br>if (target_cs.TI == 0) {&nbsp;&nbsp; /* index on GDT */<br>&nbsp;&nbsp;&nbsp; target_descriptor = GDTR.base + target_cs.SI * 8;<br>} else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* index on LDT */<br>target_descriptor = LDTR.base + target_cs.SI * 8;<br>&nbsp;&nbsp;&nbsp; }</div>
<div><br>DPLs = target_descriptor.<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>;<br><br><br>if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> &gt; DPLs) {&nbsp;&nbsp;&nbsp;&nbsp; /* 向高权限代码转移 */<br><br>&nbsp;&nbsp;&nbsp; /* 根据目标代码段的<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>值来选取相应权限的stack结构 */<br>&nbsp;&nbsp;&nbsp; switch (DPLs) {<br>&nbsp;&nbsp;&nbsp; case 0 :&nbsp;&nbsp;&nbsp;&nbsp; /* 假如目标代码处理0级，则选0级的stack结构 */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SS = tss.ss0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ESP = tss.esp0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case 1:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SS = tss.ss1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ESP = tss.esp1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case 2: <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SS = tss.ss2;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ESP = tss.esp2;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp; }</div>
<div><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 以下必须保护旧的stack结构，以便返回 */<br>&nbsp;&nbsp;&nbsp; *--esp = SS;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 将当前SS入栈保护 */<br>&nbsp;&nbsp;&nbsp; *--esp = ESP;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 将当前ESP入栈保护 */<br><br>} else if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> == DPLs) {<br>&nbsp;&nbsp;&nbsp;&nbsp; /* 同级转移，继续向下执行 */<br>} else {<br>&nbsp;&nbsp;&nbsp; /* 失败，＃GP异常产生，转去处理异常 */<br>}<br><br><br>*--esp = EFLAGS;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* eflags 寄存器入栈 */<br><br>&nbsp;&nbsp;&nbsp;&nbsp; /* 分别将 NT、NT、RF及VM标志位清0 */<br>EFLAGS.TF = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>EFLAGS.NT = 0;<br>EFLAGS.RF = 0;<br>EFLAGS.VM = 0;<br><br>if (gate_descriptor.type == I_GATE32) { /* 假如是中断门符 */<br>EFLAGS.IF = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; /* 也将IF标志位清0，屏蔽响应中断 */<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp; *--esp = CS;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 当前段选择子入栈 */<br>&nbsp;&nbsp;&nbsp;&nbsp; *--esp = EIP;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 当前EIP 入栈 */</div>
<div>　　CS = target_selector;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 加载目标代码段 */<br>CS.<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> = DPLs;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 改变当前执行权限级别 */<br>EIP = gate_descriptor.offset; /* 加载进入EIP　*/<br><br>/* 执行中断例程 */<br>goto target_descritptor.base + gate_descriptor.offset;　<br><br>} else {<br>/* 失败，#GP 异常产生，转去处理异常 */<br>}</div></span></code></td></tr></tbody></table><p></p>
<p></p>
<p></p>
<p>■ 堆栈的切换</p>
<p><br>控制权发生转移后，处理器自动进行相应的堆栈切换。<br>1、 当转向到同权限级别的代码时，不会进行堆栈级别的调整，也就是不进行堆栈切换。<br>2、 当转向高权限级别时，将发生相应级别的堆栈切换。从TSS块获取相应级别的stack结构。</p>
<p>例：假如当前运行级别<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>为2时，发生了向0级代码转移时：</p>
<p></p>
<p>
</p><table style="border-collapse: collapse;" bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" width="95%">
<tbody>
<tr>
<td><code><span style="color: rgb(0, 0, 0);">
<div>TSS tss = TR.base;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 从TR寄存器中获取TSS 块 */<br><b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> = 2;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 当前运行级别为2 级*/<br><b style="color: black; background-color: rgb(255, 102, 255);">DPL</b> = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 目标代码需要级别为 0 级 */</div>
<div><br>/* 根据目标代码需要的级别进行选取相应的权限级别的stack结构 */<br>switch (<b style="color: black; background-color: rgb(255, 102, 255);">DPL</b>) { <br>case 0:<br>&nbsp;&nbsp;&nbsp;&nbsp; SS = tss.ss0;<br>&nbsp;&nbsp;&nbsp;&nbsp; ESP = tss.esp0;<br>&nbsp;&nbsp;&nbsp;&nbsp; break;<br>case 1:<br>&nbsp;&nbsp;&nbsp;&nbsp; SS = tss.ss1;<br>&nbsp;&nbsp;&nbsp;&nbsp; ESP = tss.esp1;<br>&nbsp;&nbsp;&nbsp;&nbsp; break;<br>case 2:<br>&nbsp;&nbsp;&nbsp;&nbsp; SS = tss.ss2;<br>&nbsp;&nbsp;&nbsp;&nbsp; ESP = tss.esp2;<br>&nbsp;&nbsp;&nbsp;&nbsp; break;<br>}</div>
<div></div>
<div>*--esp = SS;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 保存旧的stack结构 */<br>*--esp = ESP;</div>
<div></div>
<div>/* 然后再作相当的保存工作，如保存参数等 */</div>
<div>*--esp = CS;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 最后保存返回地址 */<br>*--esp = EIP;</div></span></code></td></tr></tbody></table><p></p>
<p></p>
<p></p>
<p></p>
<p>■ 控制权的返回</p>
<p><br>当目标代码执行完毕，需要返回控制权给原代码时，将产生返回控制权行为。返回控制权行为，比转移控制权行为简单得多。因为，一切条件已经在交出控制权之前准备完毕，返回时仅需出栈就行了。</p>
<p>1、 near call 的返回<br>近调用情况下，段不改变，即CS不改变，权限级别不改变。仅需从栈中pop返回地址就可以了。</p>
<p><br>2、 直接控制权转移的返回（far call或far jmp）<br>&nbsp;&nbsp; 直接控制权的转移是一种不改变当前运行级别的行为。只是发生跨段的转移。这时，CS被从栈中pop出来的CS值加载进去，处理器会检查<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>与这个pop出来的选择子中的<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>进行检查，相符则返回。不相符则发生 #GP异常。<br>&nbsp;&nbsp; <br>总结：假如当前运行的目标代码执行完毕后，将要返回。这时<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>为2</p>
<p></p>
<p>
</p><table style="border-collapse: collapse;" bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" width="95%">
<tbody>
<tr>
<td><code><span style="color: rgb(0, 0, 0);">
<div><b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> = 2；&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 当前代码运行级别为 2 */<br>… …<br>EIP = *esp++;&nbsp;&nbsp; /* pop出原EIP 值 */<br>CS = *esp++;&nbsp;&nbsp;&nbsp; /* pop出原CS值 */</div>
<div></div>
<div>if (<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> == CS.<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b>) {&nbsp;&nbsp; <br>/* CS.<b style="color: black; background-color: rgb(255, 153, 153);">RPL</b> 代表是原来的运行级别，与<b style="color: black; background-color: rgb(153, 255, 153);">CPL</b>相符则返回 */<br>return ;<br>} else {<br>/* #GP异常产生，执行异常处理 */<br>}</div></span></code></td></tr></tbody></table><p></p>
<p></p>
<p>3、 利用各种门符进行向高权限代码转移后的返回<br>从高权限代码返回低权限代码，须从stack中pop出原来的stack结构。这个stack结构属于低权限代码的stack结构。然后直接pop 出原返回地址就可以了。<br><br>总结：</p><code><span style="color: rgb(0, 0, 0);">
<div><b style="color: black; background-color: rgb(153, 255, 153);">CPL</b> = 0；&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 当前运行级别为 0 级 */<br>… …<br>EIP = *esp++;&nbsp;&nbsp;&nbsp; /* 恢复原地址 */<br>CS = *esp++;&nbsp;&nbsp;&nbsp;&nbsp; /* 恢复原地址及运行级别 */</div>
<div><br>ESP = *esp ++;&nbsp;&nbsp;&nbsp;&nbsp; /* 恢复原stack结构 */<br>SS = *esp++;&nbsp;&nbsp;&nbsp;&nbsp; /* 恢复原stack 结构，同时恢复了原stack访问级别 */</div>
<div></div>
<div>return ;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 返回 */</div></span></code>
</div>
<div class="share_buttons" id="sharePanel"><span>分享到：</span> <a name="sina" class="share_sina" title="分享到新浪微博"></a><a name="qq" class="share_qq" title="分享到腾讯微博"></a></div>

<div class="article_next_prev">
        <li class="prev_article">
            <span>上一篇：</span><a href="http://blog.csdn.net/w5543081/article/details/2980310">发展方向</a></li>
        <li class="next_article">
            <span>下一篇：</span><a href="http://blog.csdn.net/w5543081/article/details/3284406">寄存器组基础知识</a></li>
</div>


</div>

<div id="ad_cen"><iframe src="index_1.html" style="border-width: 0px; overflow: hidden; width: 732px; height: 92px;" id="ad_frm_0" frameborder="0" scrolling="no"></iframe></div>


<div class="panel_head">查看评论<a name="comments"></a>
</div>
<div id="comment_list"><dl class="comment_item comment_topic" id="comment_item_1286093"><dt class="comment_head" floor="1">1楼 <span class="user"><a class="username" href="http://blog.csdn.net/gt1983" target="_top">gt1983</a> 2010-03-03 19:05发表  <a href="#reply" class="cmt_btn reply" title="回复">[回复]</a> <span class="comment_manage" style="display: none;" commentid="1286093" username="gt1983"> <a href="#quote" class="cmt_btn quote" title="引用">[引用]</a> <a href="#report" class="cmt_btn report" title="举报">[举报]</a></span></span></dt><dd class="comment_userface"><a href="http://blog.csdn.net/gt1983" target="_top"><img src="3_gt1983.jpg" height="40" width="40"></a></dd><dd class="comment_body"><img src="e01.gif">不错。。</dd></dl><div class="clear"></div></div>
<div style="display: none;" id="comment_bar"></div>
<div id="comment_form"><div class="guest_link">您还没有登录,请<a href="http://passport.csdn.net/Account/Login?from=http%3A%2F%2Fblog.csdn.net%2Fw5543081%2Farticle%2Fdetails%2F3278008">[登录]</a>或<a href="http://passport.csdn.net/Account/Register?from=http%3A%2F%2Fblog.csdn.net%2Fw5543081%2Farticle%2Fdetails%2F3278008">[注册]</a></div></div>
<div class="announce">* 以上用户言论只代表其个人观点，不代表CSDN网站的观点或立场</div>



<div id="ad_bot"><iframe src="index_2.html" style="border-width: 0px; overflow: hidden; width: 732px; height: 170px;" id="ad_frm_1" frameborder="0" scrolling="no"></iframe></div>

<div id="report_dialog"></div>
                <div class="clear"></div>
                </div>
            </div>
            <div id="side">
    <div class="side">
<div id="panel_Profile" class="panel">
    <ul class="panel_head"><span>个人资料</span></ul>
    <ul class="panel_body profile">
        <div id="blog_userface">
            <a href="http://blog.csdn.net/w5543081" title="我的博客主页">
            <img src="1_w5543081.jpg" style="max-width: 90%;">
            </a>
            <br>
            <span>w5543081</span>
        </div>
        <div id="blog_medal">
        </div>
        <ul id="blog_rank">
            <li>访问：<span>3764次</span></li>
            <li>积分：<span>92分</span></li>
            <li>排名：<span>千里之外</span></li>
        </ul>
        <ul id="blog_statistics">
            <li>原创：<span>3篇</span></li>
            <li>转载：<span>8篇</span></li>
            <li>译文：<span>0篇</span></li>
            <li>评论：<span>5条</span></li>
        </ul>
    </ul>
</div><div class="panel" id="panel_Search">
    <ul class="panel_head"><span>文章搜索</span></ul>
    <ul class="panel_body">
        <form id="frmSearch" action="http://so.csdn.net/search" class="form_search" target="_blank">
        <span><input value="" id="inputSearch" class="blogsearch" title="请输入关键字" type="text"></span>
        <input id="btnSubmit" value="搜索" title="search in blog" type="submit">
        <input name="q" id="inputQ" type="hidden">
        <input name="t" value="blog" type="hidden">
        <a id="btnSearchBlog" target="_blank"></a>
        </form>
    </ul>
</div><div id="panel_Archive" class="panel">
    <ul class="panel_head"><span>文章存档</span></ul>
    <ul class="panel_body">
        <div id="archive_list">
        <!--归档统计-->
        <li><a href="http://blog.csdn.net/w5543081/article/month/2010/05">2010年05月</a>(2)</li><li><a href="http://blog.csdn.net/w5543081/article/month/2008/12">2008年12月</a>(5)</li><li><a href="http://blog.csdn.net/w5543081/article/month/2008/11">2008年11月</a>(3)</li><li><a href="http://blog.csdn.net/w5543081/article/month/2008/09">2008年09月</a>(1)</li>
        </div>
    </ul>
</div>
<div id="hotarticls" class="panel">
    <ul class="panel_head"><span>阅读排行</span></ul>
    <ul class="panel_body">
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3278008" title="保护模式 对CPL，RPL，DPL的总结">保护模式 对CPL，RPL，DPL的总结</a> (1495)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3519133" title="汇编指令: LAHF、LAR、LDS、LES、LSS、LFS、LGS、LEA、LEA、LEAVE ">汇编指令: LAHF、LAR、LDS、L...</a> (1073)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3325858" title="汇编常用命令">汇编常用命令</a> (734)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3552089" title="写时复制">写时复制</a> (224)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3284406" title="寄存器组基础知识">寄存器组基础知识</a> (169)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/2980310" title="发展方向">发展方向</a> (104)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3552323" title="fork（）函数的学习">fork（）函数的学习</a> (56)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3436280" title="ELF文件格式">ELF文件格式</a> (54)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3604942" title="只能在保护模式下执行的指令">只能在保护模式下执行的指令</a> (48)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/5588622" title="备份">备份</a> (45)
        </li>
    </ul>
</div>
<div id="hotarticls" class="panel">
    <ul class="panel_head"><span>评论排行</span></ul>
    <ul class="panel_body">
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/2980310" title="发展方向">发展方向</a> (4)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3278008" title="保护模式 对CPL，RPL，DPL的总结">保护模式 对CPL，RPL，DPL的总结</a> (1)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/5588622" title="备份">备份</a> (0)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3604942" title="只能在保护模式下执行的指令">只能在保护模式下执行的指令</a> (0)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3552323" title="fork（）函数的学习">fork（）函数的学习</a> (0)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3552089" title="写时复制">写时复制</a> (0)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3519133" title="汇编指令: LAHF、LAR、LDS、LES、LSS、LFS、LGS、LEA、LEA、LEAVE ">汇编指令: LAHF、LAR、LDS、L...</a> (0)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3436280" title="ELF文件格式">ELF文件格式</a> (0)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3325858" title="汇编常用命令">汇编常用命令</a> (0)
        </li>
        <li>
            <a href="http://blog.csdn.net/w5543081/article/details/3284406" title="寄存器组基础知识">寄存器组基础知识</a> (0)
        </li>
    </ul>
</div>
<div id="newcomments" class="panel">
    <ul class="panel_head"><span>最新评论</span></ul>
    <ul class="panel_body">
           <li><a href="http://blog.csdn.net/w5543081/article/details/2980310#comments" title="个人看法：嵌入式也分很多种，譬如网络设备、家电之类的，譬如手机、iPad之类的。无论做那种，要看重其地位——如果你觉得一个公司不错，愿意在这个公司发展的话，要观察公司对哪一方面最看重，就去做哪一方面。说到这里吧。每个人的发展，自有其命运左右。天意难测啊，哈哈">个人看法：嵌入式也分很多种，譬...</a></li>
           <li><a href="http://blog.csdn.net/w5543081/article/details/3278008#comments">不错。。</a></li>
           <li><a href="http://blog.csdn.net/w5543081/article/details/2980310#comments" title="如果是自己，你们会怎么选择呢？
为什么这么选择呢？">如果是自己，你们会怎么选择呢？...</a></li>
           <li><a href="http://blog.csdn.net/w5543081/article/details/2980310#comments">只要追逐自己的梦就行！</a></li>
           <li><a href="http://blog.csdn.net/w5543081/article/details/2980310#comments">都一样,你想一下,做什么的人没...</a></li>
    </ul>
</div>    </div>
    <div class="clear">
    </div>
</div>

            <div class="clear">
            </div>
        </div>
            

<img src="pv.aspx" border="0" height="0" width="0">
<img src="visitlog.php" alt="" border="0" height="1" width="1"><iframe id="myframe" name="myframe" border="0" src="index_4.html" frameborder="no" height="0" scrolling="no" width="0"></iframe>
<div class="pub_footerall"><dl><dt></dt> <dd><a href="http://www.csdn.net/company/about.html" target="_top">公司简介</a>|<a href="http://www.csdn.net/company/recruit.html" target="_top">招贤纳士</a>|<a href="http://www.csdn.net/company/marketing.html" target="_top">广告服务</a>|<a href="http://www.csdn.net/company/account.html" target="_top">银行汇款帐号</a>|<a href="http://www.csdn.net/company/contact.html" target="_top">联系方式</a>|<a href="http://www.csdn.net/company/statement.html" target="_top">版权声明</a>|<a href="http://www.csdn.net/company/layer.html" target="_top">法律顾问</a>|<a href="mailto:webmaster@csdn.net">问题报告</a></dd><dd>北京创新乐知信息技术有限公司 版权所有,&nbsp;京&nbsp;ICP&nbsp;证&nbsp;070598&nbsp;号</dd><dd>世纪乐知(北京)网络技术有限公司 提供技术支持</dd><dd>江苏乐知网络技术有限公司 提供商务支持</dd><dd><img src="pic_email.gif" alt="" title=""> Email:webmaster@csdn.net</dd><dd>Copyright © 1999-2011, CSDN.NET, All Rights Reserved</dd><dd><a href="http://www.hd315.gov.cn/beian/view.asp?bianhao=010202001032100010" target="_top"><img src="gongshang_logos.gif" alt="GongshangLogo" title=""></a></dd></dl></div>
    </div>

</body>
</html>
