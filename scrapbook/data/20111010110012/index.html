<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">






<link rel="stylesheet" type="text/css" href="index.css" media="all">
</head>
<body id="bbscsdn_wrap"><div id="bd_snap">
    <div id="bd_snap_head">
        <a href="http://www.baidu.com/" id="bd_snap_logo" title="到百度首页"></a>
        <div id="bd_snap_search">
        <form action="http://www.baidu.com/s"><input name="cl" value="3" type="hidden"><input value="" name="wd" id="bd_snap_kw" maxlength="100"><span id="bd_snap_btn_wr"><input id="bd_snap_su" value="百度一下" class="bd_snap_btn" onmousedown="this.className='bd_snap_btn bd_snap_btn_h'" type="submit"></span></form>
    	</div>
    </div>
    <div id="bd_snap_txt">您查询的关键词是：<span><a style="color: black; background-color: rgb(255, 255, 102); padding: 0pt 3px; font-weight: bold;" href="http://cache.baidu.com/c?m=9f65cb4a8c8507ed4fece76310508a24420597634b86914323c3933fcf331d5c017be3b925241306d3c3616401b2485ae0f73374301420c0c18ed714c9fecf687987626f2c5ed71250c419de9804679f6bc401b7e94ea7&amp;p=9736d215d9c346ec0fbe9b7a5b55&amp;user=baidu&amp;fm=sc&amp;query=winpcap+ApplyFilter&amp;qid=cb3c2b3233a653d4&amp;p1=1#baidusnap0">winpcap</a><a style="color: black; background-color: rgb(160, 255, 255); padding: 0pt 3px; font-weight: bold;" href="http://cache.baidu.com/c?m=9f65cb4a8c8507ed4fece76310508a24420597634b86914323c3933fcf331d5c017be3b925241306d3c3616401b2485ae0f73374301420c0c18ed714c9fecf687987626f2c5ed71250c419de9804679f6bc401b7e94ea7&amp;p=9736d215d9c346ec0fbe9b7a5b55&amp;user=baidu&amp;fm=sc&amp;query=winpcap+ApplyFilter&amp;qid=cb3c2b3233a653d4&amp;p1=1#baidusnap1">applyfilter</a></span> 。如果打开速度慢，可以尝试<a href="http://cache.baidu.com/c?m=9f65cb4a8c8507ed4fece76310508a24420597634b86914323c3933fcf331d5c017be3b925241306d3c3616401b2485ae0f73374301420c0c18ed714c9fecf687987626f2c5ed71250c419de9804679f6bc401b7e94ea7&amp;p=9736d215d9c346ec0fbe9b7a5b55&amp;user=baidu&amp;fm=sc&amp;query=winpcap+ApplyFilter&amp;qid=cb3c2b3233a653d4&amp;p1=1&amp;fast=y">快速版</a>；如果想保存快照，可以<a onclick="window.open('http://cang.baidu.com/do/add?it='+encodeURIComponent(document.title)+'&amp;iu='+encodeURIComponent(location.href)+'&amp;fr=ps#nw=1','_s','scrollbars=no,width=600,height=450,right=75,top=20,status=no,resizable=yes'); return false;" href="http://cang.baidu.com/do/add" target="_top">添加到搜藏</a>；如果想更新或删除快照，可以<a href="http://tousu.baidu.com/webmaster/add" target="">投诉快照</a>。</div>
    <div id="bd_snap_note">(百度和网页<a href="http://topic.csdn.net/t/20041024/12/3485745.html">http://topic.csdn.net/t/20041024/12/3485745.html</a>的作者无关，不对其内容负责。百度快照谨为网络故障时之索引，不代表被搜索网站的即时页面。)</div>
</div>
<div id="bd_snap_ln"></div>
<div style="position: relative;">





<meta content="tcp VC/MFC 网络编程" name="Keywords">
<meta content="代码凌乱 见谅 清大虾指点一二 include pcap h include Winsock2 h include iphlpapi h pragma comment lib define the tcp flags define TCP_FIN 0x01 define TCP_SYN 0x02 define TCP_RST 0x04 define TCP_PSH 0x08 define TCP_" name="description">
<title>在winpcap中，我的pcap_next_ex返回值是0 - VC/MFC / 网络编程</title>

<link href="favicon.ico" rel="SHORTCUT ICON">







<div class="tad">
    <iframe id="Topic_Top" marginwidth="0" marginheight="0" src="index_1.html" frameborder="0" height="0" scrolling="no" width="100%"></iframe>
</div>
<div class="nav">
    <a href="#">
        <img class="logo" alt="" src="pic_logo.gif">
    </a>
    <ul class="searchpanel">
        <li>
            <input id="search_key" name="key" onkeyup="GoKeyDown(event);" onblur="if(!this.value)this.value='这里也许就有你要的答案... ';return true;" onfocus="if(this.value=='这里也许就有你要的答案... ')this.value='';return true;" value="这里也许就有你要的答案... " size="25" type="text">
            <input class="btn" onclick="Search(event,'');return false;" src="search_btn.jpg" type="image">
        </li>
    </ul>
</div>
<input id="hf_cardUrl" value="http://forum.csdn.net/PointForum/UserCard.ashx?user=" type="hidden">





<div class="bbs_top_ad">
	<div class="area_1">
		<h3></h3>
		<ul>
		
		</ul>
	</div>
	<div class="area_2">
		<h3></h3>
		<div id="scrollDiv">
			
		</div>
		<button id="btn1">&lt;&lt;</button>
		<button id="btn2">&gt;&gt;</button>
	</div>
	<div class="area_3">
		<dl>
		<dt>
			
			
		</dt>
		
		</dl>
	</div>
</div>
<div class="loc">
	<p>
<!-- a href="http://wz.csdn.net/rxsg/index.aspx" target="_blank" onclick='LogClickCount(this,117);'><img src="http://c.csdn.net/bbs/t/5/i/rxsg.jpg" alt="热血三国" /></a -->

		<a href="http://www.csdn.net/" target="_top">CSDN</a>-<a href="http://community.csdn.net/" target="_top">CSDN社区</a>-<a href="http://forum.csdn.net/BList/VC/" target="_top">VC/MFC</a>-<a href="http://forum.csdn.net/SList/VC_Network//" target="_top">网络编程</a>
	</p>
</div>

<div class="fm">
	<ul class="menu">
	<li class="bt1"><a href="javascript:;" class="bt1">管理菜单<!--[if IE 7]><!--></a><!--<![endif]-->
	<!--[if lte IE 6]><table><tr><td><![endif]-->
		<ul>
			<li><a id="a_head_recreate" href="http://forum.csdn.net/PointForum/BuildTopic.aspx?topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;return=">生成帖子</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/Tops/InsertTop.aspx?topicUrl=http://topic.csdn.net/t/20041024/12/3485745.html&amp;text=%e5%9c%a8winpcap%e4%b8%ad%ef%bc%8c%e6%88%91%e7%9a%84pcap_next_ex%e8%bf%94%e5%9b%9e%e5%80%bc%e6%98%af0&amp;sectionID=4269c85a-666c-44a6-84b0-8841db1e7f68',width:600,height:265,title:'置顶'});}catch(ex){}return false;">置顶</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/SetPrime.aspx?forumid=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicid=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13',width:400,height:255,title:'推荐'});}catch(ex){}return false;">推荐</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/SetNotPrime.aspx?topicid=00000000-0000-0000-0000-000003485745&amp;forumid=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13',width:400,height:255,title:'取消推荐'});}catch(ex){}return false;">取消推荐</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/LockTopic.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13',width:425,height:330,title:'锁定'});}catch(ex){}return false;">锁定</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/UnlockTopic.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13',width:425,height:330,title:'解锁'});}catch(ex){}return false;">解锁</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/MoveTopic.aspx?fid=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;tid=00000000-0000-0000-0000-000003485745&amp;date=2004-10-24+12%3a09%3a28',width:580,height:270,title:'移动'});}catch(ex){}return false;">移动</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/ModifyTopic.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13',width:670,height:655,title:'编辑'});}catch(ex){}return false;">编辑</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/DeleteTopic.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28',width:425,height:330,title:'删除'});}catch(ex){}return false;">删除</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Forum/TopicAddPoint.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;date=2004-10-24+12%3a09%3a28&amp;v=13',width:420,height:300,title:'帖子加分'});}catch(ex){}return false;">帖子加分</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/TitleStyle.aspx?topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;url=http://topic.csdn.net/t/20041024/12/3485745.html',width:670,height:307,title:'帖子高亮'});}catch(ex){}return false;">帖子高亮</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/RemoveTitleStyle.aspx?topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;url=http://topic.csdn.net/t/20041024/12/3485745.html',width:670,height:255,title:'取消高亮'});}catch(ex){}return false;">取消高亮</a></li>
		</ul>
	 <!--[if lte IE 6]></td></tr></table></a><![endif]-->
	</li>
	<li><a href="http://forum.csdn.net/PointForum/Manage/TopicManageView.aspx?forumID=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicID=00000000-0000-0000-0000-000003485745&amp;date=2004-10-24+12%3a09%3a28&amp;v=13" class="bt2">结&nbsp;&nbsp;帖</a></li>
	<li><a href="http://forum.csdn.net/PointForum/Forum/PostTopic.aspx?forumID=4269c85a-666c-44a6-84b0-8841db1e7f68" target="_top" class="bt3">发&nbsp;&nbsp;帖</a></li>
	<li><a href="#r_achor" class="bt4" onclick="try{ReplyBoxFocus();return false}catch(ex){}">回&nbsp;&nbsp;复</a></li>
	</ul>

</div>
<div class="tit">
<h1><dfn><a href="javascript:;" onclick="try{addToWZ();}catch(ex){}return false;">收藏</a></dfn>
<cite><select onchange="changeViewMode(this);"><option value="5">不显示删除回复</option><option value="0">显示所有回复</option><option value="1">显示星级回复</option><option value="3">显示得分回复</option></select></cite>
<span class="prime" csdnid="prime"></span><span class="lock" csdnid="lock"></span>
<a name="top"></a><span csdnid="titleStyle" style=""><!-- google_ad_section_start -->在<a name="baidusnap0"></a><b style="color: black; background-color: rgb(255, 255, 102);">winpcap</b>中，我的pcap_next_ex返回值是0<!-- google_ad_section_end --></span><em>[问题点数:<span csdnid="point">0</span>分<span csdnid="check">，结帖人:</span>]</em></h1>
</div>



<table class="mframe" cellpadding="0" cellspacing="0">
  <tbody><tr>
	<td rowspan="2" class="lf"><div class="df">
	<ul>
		<li class="center"><a href="http://hi.csdn.net/cugblue" target="_top" onclick="LogClickCount(this,111);"><img src="2_cugblue.jpg"></a></li>
		<li title="总技术分：162；总技术排名：84651"><dfn><a href="http://hi.csdn.net/cugblue" target="_top" onclick="LogClickCount(this,111);">cugblue</a></dfn></li>
		<li title="总技术分：162；总技术排名：84651">(Blue)</li>
		<li class="honor"></li>
		<li title="总技术分：162；总技术排名：84651">等　级：<img class="grade user2" alt="" src="blank.gif"> </li>
		<li>结帖率：<label>94.12%</label></li>
		<li></li>
	</ul>
	</div></td>
	<td class="rw">
		<div class="fbart"><em>楼主</em>发表于：2004-10-24 12:09:28</div>
		<table class="mtxt" cellpadding="0" cellspacing="0">
			<tbody><tr><td csdnid="body" id="body"><!-- google_ad_section_start --><div class="msgfont">代码凌乱，见谅。清大虾指点一二。 <br> #include &nbsp;  &lt;pcap.h&gt;  <br> #include &nbsp;  &lt;Winsock2.h&gt;  <br> #include &nbsp;  &lt;iphlpapi.h&gt;  <br> //#pragma &nbsp; comment(lib, " ") <br> // &nbsp;  &nbsp; define &nbsp; the &nbsp; tcp &nbsp; flags.... <br> #define &nbsp;  &nbsp;  &nbsp; TCP_FIN &nbsp;  &nbsp;  &nbsp; 0x01 <br> #define &nbsp;  &nbsp;  &nbsp; TCP_SYN &nbsp;  &nbsp;  &nbsp; 0x02 <br> #define &nbsp;  &nbsp;  &nbsp; TCP_RST &nbsp;  &nbsp;  &nbsp; 0x04 <br> #define &nbsp;  &nbsp;  &nbsp; TCP_PSH &nbsp;  &nbsp;  &nbsp; 0x08 <br> #define &nbsp;  &nbsp;  &nbsp; TCP_ACK &nbsp;  &nbsp;  &nbsp; 0x10 <br> #define &nbsp;  &nbsp;  &nbsp; TCP_URG &nbsp;  &nbsp;  &nbsp; 0x20 <br> #define &nbsp;  &nbsp;  &nbsp; TCP_ACE &nbsp;  &nbsp;  &nbsp; 0x40 <br> #define &nbsp;  &nbsp;  &nbsp; TCP_CWR &nbsp;  &nbsp;  &nbsp; 0x80 <br> //define &nbsp; header &nbsp; lengths <br> #define &nbsp; ETHER_LENGTH &nbsp;  &nbsp; 14 <br> #define &nbsp; IP_LENGTH &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; 20 <br> #define &nbsp; TCP_LENGTH &nbsp;  &nbsp;  &nbsp;  &nbsp; 20 <br> #define &nbsp; UDP_LENGTH &nbsp;  &nbsp;  &nbsp;  &nbsp; 8 <br> #define &nbsp; ICMP_LENGTH &nbsp;  &nbsp;  &nbsp; 8 <br> #define &nbsp; ARP_LENGTH &nbsp;  &nbsp;  &nbsp;  &nbsp; 28 <br> #define &nbsp; PSEUDO_LENGTH &nbsp; 12 <br> #define &nbsp; DATA_LENGTH &nbsp;  &nbsp;  &nbsp; 32 <br> //Protocol <br> #define &nbsp; PROTO_ICMP &nbsp;  &nbsp;  &nbsp;  &nbsp; 1 <br> #define &nbsp; PROTO_IGMP &nbsp;  &nbsp;  &nbsp;  &nbsp; 2 <br> #define &nbsp; PROTO_TCP &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; 6 <br> #define &nbsp; PROTO_UDP &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; 17 <br> struct &nbsp; eth_header &nbsp;  &nbsp;  &nbsp; // &nbsp; 14 &nbsp; bytes <br> { <br> 	u_char &nbsp; dhost[6]; &nbsp; //destination &nbsp; mac &nbsp; address <br> 	u_char &nbsp; shost[6]; &nbsp; //source &nbsp; mac &nbsp; address <br> 	u_short &nbsp; type; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; //IP &nbsp; ,ARP &nbsp; , &nbsp; RARP <br> }; <br> // &nbsp; 4 &nbsp; byte &nbsp; ip &nbsp; address <br> struct &nbsp; ip_address <br> { <br> 	u_char &nbsp; byte1; <br> 	u_char &nbsp; byte2; <br> 	u_char &nbsp; byte3; <br> 	u_char &nbsp; byte4; <br> }; <br> /* &nbsp; IPv4 &nbsp; header &nbsp; */ <br> struct &nbsp; ip_header <br> { <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; u_char &nbsp;  &nbsp; ver_ihl; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Version &nbsp; (4 &nbsp; bits) &nbsp; + &nbsp; Internet &nbsp; header &nbsp; length &nbsp; (4 &nbsp; bits) <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; u_char &nbsp;  &nbsp; tos; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Type &nbsp; of &nbsp; service &nbsp;  <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; u_short &nbsp; tlen; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Total &nbsp; length &nbsp; (16 &nbsp; bits) <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; u_short &nbsp; identification; &nbsp; // &nbsp; Identification &nbsp; (16 &nbsp; bits) <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; u_short &nbsp; flags_fo; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Flags &nbsp; (3 &nbsp; bits) &nbsp; + &nbsp; Fragment &nbsp; offset &nbsp; (13 &nbsp; bits) <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; u_char &nbsp;  &nbsp; ttl; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Time &nbsp; to &nbsp; live &nbsp; (8 &nbsp; bits) <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; u_char &nbsp;  &nbsp; proto; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Protocol &nbsp; (8 &nbsp; bits) <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; u_short &nbsp; crc; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Header &nbsp; checksum &nbsp; (16 &nbsp; bits) <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; ip_address &nbsp;  &nbsp; saddr; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Source &nbsp; address &nbsp; (32 &nbsp; bits) <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; ip_address &nbsp;  &nbsp; daddr; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Destination &nbsp; address &nbsp; (32 &nbsp; bits) <br> 	 <br> 	// &nbsp; u_int &nbsp;  &nbsp;  &nbsp; op_pad; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Option &nbsp; + &nbsp; Padding <br> }; <br> struct &nbsp; arp_header &nbsp;  &nbsp;  &nbsp; //28 &nbsp; bytes <br> { <br> 	u_short &nbsp; hrd; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; //hardware &nbsp; address &nbsp; space=0x0001 <br> 	u_short &nbsp; eth_type; &nbsp;  &nbsp; //Ethernet &nbsp; type &nbsp; ....=0x0800 <br> 	u_char &nbsp; maclen; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; //Length &nbsp; of &nbsp; mac &nbsp; address=6 <br> 	u_char &nbsp; iplen; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; //Length &nbsp; of &nbsp; ip &nbsp; addres=4 <br> 	u_short &nbsp; opcode; &nbsp;  &nbsp;  &nbsp;  &nbsp; //Request &nbsp; =1 &nbsp; Reply=2 &nbsp; (highbyte) <br> 	u_char &nbsp; smac[6]; &nbsp;  &nbsp;  &nbsp;  &nbsp; //source &nbsp; mac &nbsp; address <br> 	ip_address &nbsp; saddr; &nbsp;  &nbsp; //Source &nbsp; ip &nbsp; address <br> 	u_char &nbsp; dmac[6]; &nbsp;  &nbsp;  &nbsp;  &nbsp; //Destination &nbsp; mac &nbsp; address <br> 	ip_address &nbsp; daddr; &nbsp;  &nbsp; //Destination &nbsp; ip &nbsp; address <br> }; <br> struct &nbsp; udp_header &nbsp;  &nbsp;  &nbsp; //8 &nbsp; bytes <br> { <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; u_short &nbsp; sport; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Source &nbsp; port <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; u_short &nbsp; dport; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Destination &nbsp; port <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; u_short &nbsp; len; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Datagram &nbsp; length <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; u_short &nbsp; crc; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Checksum <br> }; <br> struct &nbsp; tcp_header &nbsp;  &nbsp; //20 &nbsp; bytes <br> { <br> 	u_short &nbsp; sport; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; //Source &nbsp; port <br> 	u_short &nbsp; dport; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; //Destination &nbsp; port <br> 	u_long &nbsp; seqno; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; //Sequence &nbsp; no <br> 	u_long &nbsp; ackno; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; //Ack &nbsp; no <br> 	u_char &nbsp; offset; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; //Higher &nbsp; level &nbsp; 4 &nbsp; bit &nbsp; indicates &nbsp; data &nbsp; offset <br> 	u_char &nbsp; flag; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; //Message &nbsp; flag <br> 	//FIN &nbsp; - &nbsp; 0x01 <br> 	//SYN &nbsp; - &nbsp; 0x02 <br> 	//RST &nbsp; - &nbsp; 0x04 &nbsp;  <br> 	//PUSH- &nbsp; 0x08 <br> 	//ACK- &nbsp; 0x10 <br> 	//URG- &nbsp; 0x20 <br> 	//ACE- &nbsp; 0x40 <br> 	//CWR- &nbsp; 0x80 <br> 	 <br> 	u_short &nbsp; win; &nbsp;  &nbsp;  &nbsp; //the &nbsp; size &nbsp; of &nbsp; window &nbsp; (16 &nbsp; bits) <br> 	u_short &nbsp; checksum; <br> 	u_short &nbsp; uptr; &nbsp;  &nbsp; //urgent &nbsp; pointer <br> }; <br> struct &nbsp; icmp_header <br> { <br> 	u_char &nbsp; type; <br> 	u_char &nbsp; code; <br> 	u_short &nbsp; checksum; <br> 	u_short &nbsp; id; <br> 	u_short &nbsp; seqno; <br> }; <br> //For &nbsp; checksum &nbsp; calculation &nbsp; purpose <br> struct &nbsp; pseudo_header &nbsp;  &nbsp; //12 &nbsp; bytes &nbsp;  <br> { <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; ip_address &nbsp;  &nbsp; saddr; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Source &nbsp; address <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; ip_address &nbsp;  &nbsp; daddr; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Destination &nbsp; address <br> 	u_char &nbsp; zero; <br> 	u_char &nbsp;  &nbsp; proto; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; Protocol <br> 	u_short &nbsp; tcp_len; <br> 	tcp_header &nbsp; tcp; <br> }; <br> pcap_if_t &nbsp; *curdev; <br> pcap_t &nbsp; *hdev; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; //Descriptor &nbsp; of &nbsp; an &nbsp; open &nbsp; capture &nbsp; instance. &nbsp;  <br> BYTE &nbsp; hostmac[6],hostip[4],destmac[6],destip[4],srcip[4]; <br> u_short &nbsp; ComputeChecksum(u_short &nbsp; *data,int &nbsp; size) <br> { <br> 	register &nbsp; int &nbsp; nleft=size; <br> 	register &nbsp; u_short &nbsp; *w=data; <br> 	register &nbsp; int &nbsp; sum=0; <br> 	u_short &nbsp; answer &nbsp; =0; <br>  <br> 	while(nleft&gt; 1) <br> 	{ <br> 	sum+=*w++; <br> 	nleft-=2; <br> 	} <br> 	if(nleft==1) <br> 	{ <br>  <br> 		*(u_char*) &nbsp; (&amp;answer) &nbsp; = &nbsp; *(u_char*)w; <br> 		sum+=answer; <br> 	} <br> 	sum= &nbsp; (sum&gt; &gt; 16 &nbsp; )+ &nbsp; (sum &nbsp; &amp; &nbsp; 0xffff); <br> 	sum+=(sum&gt; &gt; 16); <br> 	answer=~sum; <br> 	return &nbsp; (answer); <br>  <br> } <br> LRESULT &nbsp; <a name="baidusnap1"></a><b style="color: black; background-color: rgb(160, 255, 255);">ApplyFilter</b>(char &nbsp; *filter) <br> { <br> 	u_int &nbsp; netmask; <br> 	int &nbsp; retvalue; <br> 	struct &nbsp; bpf_program &nbsp; fcode; <br>  <br> 	if(curdev-&gt; addresses!=NULL) <br> 	netmask=((struct &nbsp; sockaddr_in &nbsp; *)(curdev-&gt; addresses-&gt; netmask))-&gt; sin_addr.S_un.S_addr; <br> 	else <br> 	netmask=0xffffffff; <br> 	//compile &nbsp; the &nbsp; filter <br> 	retvalue=pcap_compile(hdev,&amp;fcode,filter,1,netmask);	 <br> 	if(retvalue &lt;0) <br> 	{ <br> 	printf( "\n &nbsp; Unable &nbsp; to &nbsp; compile &nbsp; the &nbsp; filter "); <br> 	return &nbsp; FALSE; <br> 	} <br> 	//Set &nbsp; the &nbsp; filter <br> 	retvalue=pcap_setfilter(hdev,&amp;fcode);	 <br> 	if(retvalue &lt;0) <br> 	{ <br> 	printf( "\n &nbsp; Unable &nbsp; to &nbsp; set &nbsp; the &nbsp; filter "); <br> 	return &nbsp; FALSE; <br> 	}	 <br> return &nbsp; TRUE; <br> } <br> BOOL &nbsp; GetDestMacAddress() <br> { <br> 	 <br> 	eth_header &nbsp; eh,*peh; <br> 	arp_header &nbsp; arph,*parph; <br> 	struct &nbsp; pcap_pkthdr &nbsp; *header; &nbsp;  &nbsp; //Header &nbsp; of &nbsp; a &nbsp; packet &nbsp;  <br> 	u_char &nbsp; *pkt_data; <br> 	int &nbsp; retvalue; <br> 	u_char &nbsp; frame[200]; <br> 	char &nbsp; str[100],filter[200]; <br> 	destip[0]=211,destip[1]=69,destip[2]=196,destip[3]=250;	 <br> 	// &nbsp; Apply &nbsp; filter &nbsp; to &nbsp; receive &nbsp; only &nbsp; ARP &nbsp; reply &nbsp; packet... <br> 	sprintf(str, "%d.%d.%d.%d ",destip[0],destip[1],destip[2],destip[3]);	 <br> 	sprintf(filter, "arp &nbsp; src &nbsp; net &nbsp; %s ",str); <br> 	<b style="color: black; background-color: rgb(160, 255, 255);">ApplyFilter</b>(filter);	 <br> 	// &nbsp; Prepare &nbsp; ARP &nbsp; request &nbsp; packet	 <br> 	/******************* &nbsp;  &nbsp; Ethernet &nbsp; Header &nbsp; ******************/ <br> 	memset(&amp;eh,0,sizeof(eh));	 <br> 	// &nbsp; Source &nbsp; Mac &nbsp; address <br> 	memcpy(eh.shost,hostmac,6); <br> 	// &nbsp; Destination &nbsp; MAC &nbsp; address &nbsp; ; &nbsp; make &nbsp; it &nbsp; all &nbsp; 0xff <br> 	memset(eh.dhost,0xff,6);	 <br> 	eh.type=htons(0x0806); &nbsp; //IP &nbsp; Frames <br> 	memcpy(&amp;frame,&amp;eh,ETHER_LENGTH); <br> 	/******************* &nbsp;  &nbsp; ARP &nbsp; Header &nbsp; ******************/	 <br> 	arph.eth_type=htons(0x0800);	 <br> 	memcpy(arph.smac,eh.shost,6); <br> 	memset(arph.dmac,0,6); <br> 	memcpy(&amp;arph.daddr,destip,4); <br> 	memcpy(&amp;arph.saddr,hostip,4); <br> 	arph.hrd=htons(0x0001); <br> 	arph.iplen=4; <br> 	arph.maclen=6;	 <br> 	arph.opcode=0x0100; &nbsp;  &nbsp; //Request &nbsp; ARP &nbsp; packet	 <br> 	memcpy(&amp;frame[ETHER_LENGTH],&amp;arph,ARP_LENGTH);	 <br> 	//Send &nbsp; the &nbsp; ARP &nbsp; request &nbsp; packet <br> 	pcap_sendpacket(hdev,frame,ETHER_LENGTH+ARP_LENGTH);	 <br> 	//Now &nbsp; wait &nbsp; ARP &nbsp; reply &nbsp; packet <br> 	int &nbsp; count=0;	 <br> 	while(true) <br> 	{ <br> 		 <br> 		retvalue=pcap_next_ex(hdev,&amp;header,&amp;pkt_data);			 <br> 		if(retvalue &lt;0) <br> 		{			 <br> 			return &nbsp; FALSE; <br> 		} <br> 		 <br> 		if(header-&gt; caplen==0) <br> 		{ <br> 			return &nbsp; FALSE; <br> 		} <br> 		 <br> 		//Now &nbsp; this &nbsp; packet &nbsp; is &nbsp; the &nbsp; required &nbsp; packet.. <br> 		//So &nbsp; take &nbsp; a &nbsp; break &nbsp; and &nbsp; check &nbsp; it &nbsp; out....		 <br> 		//check &nbsp; for &nbsp; ARP &nbsp; packet &nbsp; IP &nbsp; address &nbsp; checking &nbsp; is &nbsp; better		 <br> 		//Get &nbsp; the &nbsp; Ethernet &nbsp; Header... <br> 		peh=(eth_header*)pkt_data;		 <br> 		if(ntohs(peh-&gt; type)==0x0806)	 <br> 		{ <br> 			// &nbsp; Get &nbsp; the &nbsp; ARP &nbsp; Header <br> 			parph=(arp_header*)(pkt_data+ETHER_LENGTH); <br> 			 <br> 			//check &nbsp; if &nbsp; it &nbsp; is &nbsp; Reply <br> 			if(parph-&gt; opcode==0x0200) <br> 			{ <br> 				memcpy(destmac,parph-&gt; smac,6); <br> 				return &nbsp; TRUE; <br> 			} <br> 			 <br> 		} <br> 				 <br> 	} <br> 	return &nbsp; FALSE; <br> }</div><!-- google_ad_section_end --><!--End_body//--></td></tr>
			<tr><td csdnid="link"></td></tr>
			<tr><td csdnid="modify"></td></tr>
		</tbody></table>
	</td>
  </tr>
  <tr>
	<td class="rb">
	<iframe id="tad2" marginwidth="0" marginheight="0" src="index_2.html" frameborder="0" height="0" scrolling="no" width="100%"></iframe>
	<div class="fbarb">
		<ul>
		<li><a href="javascript:;" class="dr nob" onclick="try{Estimate(this,'http://forum.csdn.net/PointForum/Forum/EstimateTopic.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;type=0&amp;v=13');LogClickCount(this,113);}catch(ex){}return false;">对我有用</a>[<span csdnid="acount" title="该帖子被0个用户给予好评">0</span>]</li>
		<li><a href="javascript:;" class="gr nob" onclick="try{Estimate(this,'http://forum.csdn.net/PointForum/Forum/EstimateTopic.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;type=1&amp;v=13');LogClickCount(this,114);}catch(ex){}return false;">丢个板砖</a>[<span csdnid="ucount" title="该帖子被0个用户给予差评">0</span>]</li>
		<li><a href="javascript:;" class="gr" onclick="try{Quote(0);}catch(ex){};return false">引用</a></li>
		<li><a href="javascript:;" class="dr" onclick="try{report(0);}catch(ex){}return false;">举报</a></li>
		<li><a href="javascript:;" class="gr" onmousemove="try{showMenu(this,'http://forum.csdn.net/PointForum/Manage/ModifyTopic.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13','http://forum.csdn.net/PointForum/Manage/DeleteTopic.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28');return false}catch(ex){}">管理</a></li>
		<li><a href="#top" class="nob">TOP</a></li>
		</ul>
		回复次数：<span csdnid="rcount" title="该帖回复数为2">2</span><!-- | 
		浏览次数：<span csdnid="vcount" title="该帖阅读数为66">66</span>-->
	</div>
	</td>
	</tr>
</tbody></table>	
<div class="clear"></div>

<iframe id="Iframe1" marginwidth="0" marginheight="0" src="index_3.html" frameborder="0" height="0" scrolling="no" width="100%"></iframe>

<!-- google_ad_section_start(weight=ignore) -->

<table csdnid="rt_25052652" class="mframe" cellpadding="0" cellspacing="0"><tbody><tr><td rowspan="2" class="lf"><div class="df">
	<ul>
		<li class="center"><a href="http://hi.csdn.net/cugblue" target="_top" onclick="LogClickCount(this,111);"><img src="2_cugblue.jpg" title="cugblue用户自定义头像" alt="cugblue用户头像"></a></li>
		<li title="截至2011-01-29 10:08:59，用户的总技术分为：162；截至2011-01-23日，用户的总技术分排名为：84651"><dfn><a href="http://hi.csdn.net/cugblue" target="_top" onclick="LogClickCount(this,111);">cugblue</a></dfn></li>
		<li title="截至2011-01-29 10:08:59，用户的总技术分为：162；截至2011-01-23日，用户的总技术分排名为：84651">(Blue)</li>
		<li class="honor"></li>
		<li title="截至2011-01-29 10:08:59，用户的总技术分为：162；截至2011-01-23日，用户的总技术分排名为：84651">等　级：<img alt="" src="blank_001.gif" class="grade user2"></li>
		<li></li>
	</ul>
</div></td><td class="rw">
	<div class="fbart"><dfn>#1楼 得分：0</dfn>回复于：2004-10-24 12:10:45</div>
<a name="r_25052652"></a>
	<table class="mtxt" cellpadding="0" cellspacing="0"><tbody><tr><td csdnid="rbody_25052652" id="rbody_25052652">
<div class="msgfont">上 <br> BOOL &nbsp; main(int &nbsp; argc, &nbsp; char &nbsp; **argv) &nbsp; { <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp;  <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; pcap_if_t &nbsp; *alldevs; <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; u_int &nbsp; inum, &nbsp; i=0; <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; char &nbsp; errbuf[PCAP_ERRBUF_SIZE]; &nbsp;  &nbsp;  &nbsp;  &nbsp;  <br> 	int &nbsp; retvalue; <br>  <br> 	/* &nbsp; The &nbsp; user &nbsp; didn 't &nbsp; provide &nbsp; a &nbsp; packet &nbsp; source: &nbsp; Retrieve &nbsp; the &nbsp; device &nbsp; list &nbsp; */ <br> 	if &nbsp; (pcap_findalldevs(&amp;alldevs, &nbsp; errbuf) &nbsp; == &nbsp; -1) <br> 	{ <br> 		printf( "Error &nbsp; in &nbsp; pcap_findalldevs: &nbsp; %s\n ", &nbsp; errbuf); <br> 		return &nbsp; false; <br> 	}	 <br> 	/* &nbsp; Print &nbsp; the &nbsp; list &nbsp; */ <br> 	for(curdev=alldevs; &nbsp; curdev; &nbsp; curdev=curdev-&gt; next) <br> 	{ <br> 		printf( "%d. &nbsp; %s ", &nbsp; ++i, &nbsp; curdev-&gt; name); <br> 		if &nbsp; (curdev-&gt; description) <br> 			printf( " &nbsp; (%s)\n ", &nbsp; curdev-&gt; description); <br> 		else <br> 			printf( " &nbsp; (No &nbsp; description &nbsp; available)\n "); <br> 	}	 <br> 	if(i==0) <br> 	{ <br> 		printf( "\nNo &nbsp; interfaces &nbsp; found! &nbsp; Make &nbsp; sure &nbsp; <b style="color: black; background-color: rgb(255, 255, 102);">WinPcap</b> &nbsp; is &nbsp; installed.\n "); <br> 		return &nbsp; false; <br> 	} <br> 	printf( "Enter &nbsp; the &nbsp; interface &nbsp; number &nbsp; (1-%d): ",i); <br> 	scanf( "%d ", &nbsp; &amp;inum); <br> 	 <br> 	if(inum &nbsp;  &lt; &nbsp; 1 &nbsp; || &nbsp; inum &nbsp; &gt;  &nbsp; i) <br> 	{ <br> 		printf( "\nInterface &nbsp; number &nbsp; out &nbsp; of &nbsp; range.\n "); <br> 		/* &nbsp; Free &nbsp; the &nbsp; device &nbsp; list &nbsp; */ <br> 		pcap_freealldevs(alldevs); <br> 		return &nbsp; false; <br> 	}	 <br> 	/* &nbsp; Jump &nbsp; to &nbsp; the &nbsp; selected &nbsp; adapter &nbsp; */ <br> 	for(curdev=alldevs, &nbsp; i=0; &nbsp; i &lt; &nbsp; inum-1 &nbsp; ;curdev=curdev-&gt; next, &nbsp; i++); <br> 	 <br> 	/* &nbsp; Open &nbsp; the &nbsp; device &nbsp; */ <br> 	if &nbsp; ( &nbsp; (hdev= &nbsp; pcap_open_live(curdev-&gt; name, &nbsp; 100, &nbsp; 1, &nbsp; 2000, &nbsp; errbuf) &nbsp; ) &nbsp; == &nbsp; NULL) <br> 	{ <br> 		printf( "\nError &nbsp; opening &nbsp; adapter\n "); <br> 		return &nbsp; false; <br> 	}	 <br> 	u_long &nbsp; ip; <br> 	ip=ntohl(((struct &nbsp; sockaddr_in &nbsp; *)(curdev-&gt; addresses-&gt; addr))-&gt; sin_addr.S_un.S_addr); <br> 	IP_ADAPTER_INFO &nbsp; adapter[5]; &nbsp;  &nbsp; //Maximum &nbsp; 5 &nbsp; adapters <br> 	DWORD &nbsp; buflen=sizeof(adapter); <br> 	DWORD &nbsp; status=GetAdaptersInfo(adapter,&amp;buflen); <br> 	if(status==ERROR_SUCCESS) <br> 	{ <br> 	PIP_ADAPTER_INFO &nbsp; painfo=adapter; <br>  &nbsp;  &nbsp;  &nbsp;  &nbsp; memcpy(hostmac,painfo-&gt; Address,6); <br> 	} <br> 	else &nbsp; {return &nbsp; false;} <br> 	memcpy(hostip,&amp;ip,4); <br>  <br> 		if &nbsp; (!GetDestMacAddress()) &nbsp; { <br> 			printf( "Error &nbsp; in &nbsp; pcap_getmac: &nbsp; %s\n ", &nbsp; errbuf); <br> 			exit(1); <br> 		} <br> 	 <br> 	char &nbsp; destaddr[100],str[100]; <br> 	sprintf(destaddr, "%d.%d.%d.%d ",destip[0],destip[1],destip[2],destip[3]); <br> 	sprintf(str, "src &nbsp; net &nbsp; %s &nbsp; and &nbsp; tcp &nbsp; port &nbsp; 6000 ",destaddr); <br> 	<b style="color: black; background-color: rgb(160, 255, 255);">ApplyFilter</b>(str); <br>  <br> 	eth_header &nbsp; eh; &nbsp;  &nbsp;  &nbsp;  &nbsp;  <br> 	ip_header &nbsp; ih,*rih; <br> 	tcp_header &nbsp; th,*rth; <br> 	pseudo_header &nbsp; psh; <br> 	u_char &nbsp; frame[200]; <br>  <br> 	// &nbsp; Prepare &nbsp; Ethernet &nbsp; Header &nbsp; , &nbsp; IP &nbsp; Header &nbsp; and &nbsp; TCP &nbsp; Header &nbsp; in &nbsp; Advance <br> 	/******************* &nbsp;  &nbsp; Ethernet &nbsp; Header &nbsp; ******************/ <br> 	memset(&amp;eh,0,sizeof(eh)); <br> 	//Source &nbsp; MAC &nbsp; address <br> 	memcpy(eh.shost,hostmac,6); <br> 	//Destination &nbsp; MAC &nbsp; address <br> 	memcpy(eh.dhost,destmac,6); <br> 	eh.type=htons(0x0800); &nbsp; //IP &nbsp; Frames <br> 	memcpy(&amp;frame,&amp;eh,ETHER_LENGTH); <br> 	/******************* &nbsp;  &nbsp; IP &nbsp; Header &nbsp; ******************/ <br> 	memset(&amp;ih,0,sizeof(ih)); <br> 	//source &nbsp; address <br> 	memcpy(&amp;ih.saddr,hostip,4); <br> 	//destination &nbsp; address <br> 	memcpy(&amp;ih.daddr,destip,4); <br> 	ih.proto=PROTO_TCP; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  <br> 	ih.flags_fo=htons(0x4000);			//For &nbsp; TCP &nbsp; Flag &nbsp; fixed <br> //	ih.flags_fo=htons(0x0000);			//For &nbsp; ICMP &nbsp; Flag &nbsp; fixed <br> 	ih.identification=htons(0x0150); &nbsp;  &nbsp;  &nbsp;  &nbsp; //Any &nbsp; number <br> 	ih.tlen=htons(IP_LENGTH+TCP_LENGTH); &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; //Depends &nbsp; upon &nbsp; data &nbsp; and &nbsp; tcp &nbsp; protocol <br> 	ih.tos=0; <br> 	ih.ttl=32; <br> 	ih.ver_ihl=0x45; &nbsp;  &nbsp; //Version &nbsp; (v4) &nbsp; and &nbsp;  &nbsp; header &nbsp; length(5 &nbsp; nibbles) <br> 	ih.crc=0; <br> 	ih.crc=ComputeChecksum((u_short &nbsp; *)&amp;ih,IP_LENGTH); <br> 	memcpy(&amp;frame[ETHER_LENGTH],&amp;ih,IP_LENGTH);		 <br> 	/*************** &nbsp;  &nbsp; TCP &nbsp; Header &nbsp; ****************************/ <br> 	memset(&amp;th,0,sizeof(th)); <br> 	th.sport=htons(6000); &nbsp;  &nbsp;  &nbsp; // &nbsp; source &nbsp; port <br> 	th.dport=htons(139); &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; dest &nbsp; port &nbsp; changes &nbsp; dynamically <br> 	th.ackno=htonl(0); <br> 	th.seqno=htonl(5555l); <br> 	th.flag=TCP_SYN; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; SYN &nbsp; packet <br> 	th.offset=0x50; &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp;  &nbsp; // &nbsp; data &nbsp; offset <br> 	th.uptr=0; <br> 	th.win=htons(512) &nbsp; ; <br> 	th.checksum=0;		 <br> 	//set &nbsp; up &nbsp; the &nbsp; pseudo &nbsp; header &nbsp;  <br> 	memset(&amp;psh,0,sizeof(psh)); <br> 	psh.saddr=ih.saddr; <br> 	psh.daddr=ih.daddr; <br> 	psh.proto=ih.proto; <br> 	psh.zero=0; <br> 	psh.tcp_len=htons(TCP_LENGTH);				//Length &nbsp; of &nbsp; Tcp &nbsp; header &nbsp; + &nbsp; Data &nbsp; in &nbsp; OCTATES <br> 	memcpy(&amp;psh.tcp,&amp;th,TCP_LENGTH); <br> 	 <br> 	th.checksum=ComputeChecksum((u_short*)&amp;psh,TCP_LENGTH+PSEUDO_LENGTH); <br> 	 <br> 	//Copy &nbsp; TCP &nbsp; Header &nbsp; into &nbsp; the &nbsp; frame &nbsp; at &nbsp; the &nbsp; end &nbsp; of &nbsp; IP &nbsp; Packet <br> 	memcpy(&amp;frame[ETHER_LENGTH+IP_LENGTH],&amp;th,TCP_LENGTH); <br> 	 <br> 	//Send &nbsp; the &nbsp; packet <br> 	if &nbsp; ((retvalue=pcap_sendpacket(hdev,frame,ETHER_LENGTH+IP_LENGTH+TCP_LENGTH))==-1) &nbsp; { <br> 		printf( "send &nbsp; packet &nbsp; failed.\n "); <br> 		return &nbsp; false; <br> 	} <br> 	//Wait &nbsp; for &nbsp; the &nbsp; SYN &nbsp; - &nbsp; ACK &nbsp; or &nbsp; RST-ACK &nbsp; packet <br> 	//If &nbsp; any &nbsp; other &nbsp; packet &nbsp; comes &nbsp; then &nbsp; ignore &nbsp; it....	 <br> 	//If &nbsp; no &nbsp; packet &nbsp; comes &nbsp; after &nbsp; trying &nbsp; 5 &nbsp; times &nbsp; then &nbsp; stop &nbsp; the &nbsp; scan &nbsp; and &nbsp; exit <br> 	//Since &nbsp; target &nbsp; machine &nbsp; might &nbsp; have &nbsp; shut &nbsp; down...or &nbsp; it &nbsp; may &nbsp; be &nbsp; sleeping..!!!	 <br> 	struct &nbsp; pcap_pkthdr &nbsp; *header; &nbsp;  &nbsp; //Header &nbsp; of &nbsp; a &nbsp; packet &nbsp;  <br> 	u_char &nbsp; *pkt_data; <br> 	while(true) <br> 	{		 <br> 		// &nbsp; Wait &nbsp; for &nbsp; next &nbsp; packet <br> 		retvalue=pcap_next_ex(hdev,&amp;header,&amp;pkt_data); <br> 		if &nbsp; (retvalue==0) &nbsp; { <br> 			continue; <br> 		} <br> 		if(retvalue &lt;0) <br> 		{ <br> 			return &nbsp; FALSE; <br> 		} <br> 		 <br> 		if(header-&gt; caplen==0) <br> 		{ <br> 			return &nbsp; FALSE; <br> 		}		 <br> 		 <br> 		//Get &nbsp; the &nbsp; IP &nbsp; Header... <br> 		rih=(ip_header*)(pkt_data+ETHER_LENGTH);		 <br> 		 <br> 		//Cross &nbsp; check &nbsp; the &nbsp; incoming &nbsp; packet		 <br> 		if(rih-&gt; proto==PROTO_TCP) &nbsp;  &nbsp; //check &nbsp; for &nbsp; tcp &nbsp; protocol <br> 		{ <br> 			 <br> 			//Get &nbsp; the &nbsp; TCP &nbsp; Header <br> 			rth=(tcp_header*)((u_char*)rih+ &nbsp; (rih-&gt; ver_ihl &nbsp; &amp; &nbsp; 0x0f)*4); <br> 			 <br> 			//Convert &nbsp; network &nbsp; byte &nbsp; order &nbsp; to &nbsp; host &nbsp; byte &nbsp; order <br> 			u_short	sport=ntohs(rth-&gt; sport); <br> 			 <br> 			//Check &nbsp; if &nbsp; the &nbsp; response &nbsp; is &nbsp; for &nbsp; the &nbsp; current &nbsp; port &nbsp; number <br> 			if(sport==139) &nbsp;  <br> 			{ <br> 				 <br> 				// &nbsp; Check &nbsp; if &nbsp; it &nbsp; is &nbsp; SYN+ACK &nbsp; packet... <br> 				if((rth-&gt; flag &nbsp; &amp; &nbsp; TCP_SYN) &nbsp; &amp;&amp; &nbsp; (rth-&gt; flag &nbsp; &amp; &nbsp; TCP_ACK) &nbsp; ) <br> 				{ <br> 					printf( "port:%d &nbsp; open\n ",sport);					 <br> 					break; <br> 				} <br> 				else &nbsp; // &nbsp; Check &nbsp; if &nbsp; it &nbsp; is &nbsp; RST+ACK &nbsp; packet <br> 				if((rth-&gt; flag &nbsp; &amp; &nbsp; TCP_RST) &nbsp; &amp;&amp; &nbsp; (rth-&gt; flag &nbsp; &amp; &nbsp; TCP_ACK) &nbsp; ) <br> 					{ <br> 						printf( "port:%d &nbsp; closed\n ",sport);						 <br> 						break; <br> 					} <br> 			} <br> 			 <br> 		}	 <br> 		 <br> 	} &nbsp;  <br> 	return &nbsp; true;	 <br> } <br> </div>
<!--End_rbody_25052652//--></td></tr>
	<tr><td csdnid="rmodify_25052652"></td></tr></tbody></table>
</td></tr><tr><td class="rb">
	<div class="fbarb">
	   <ul>
		<li><a href="javascript:;" class="dr nob" onclick="try{Estimate(this,'http://forum.csdn.net/PointForum/Forum/EstimateReply.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;replyId=25052652&amp;type=0&amp;v=13');LogClickCount(this,113);}catch(ex){}return false;">对我有用</a>[<span csdnid="racount_25052652" title="该回复被0个用户给予好评">0</span>]</li>
		<li><a href="javascript:;" class="gr nob" onclick="try{Estimate(this,'http://forum.csdn.net/PointForum/Forum/EstimateReply.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;replyId=25052652&amp;type=1&amp;v=13');LogClickCount(this,114);}catch(ex){}return false;">丢个板砖</a>[<span csdnid="rucount_25052652" title="该回复被0个用户给予差评">0</span>]</li>
		<li><a href="javascript:;" class="gr" onclick="try{Quote(1);}catch(ex){};return false">引用</a></li>
		<li><a href="javascript:;" class="dr" onclick="try{report(1);}catch(ex){}return false;">举报</a></li>
		<li><a href="javascript:;" class="gr" onmousemove="try{showMenu(this,'http://forum.csdn.net/PointForum/Manage/ModifyReply.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;replyId=25052652&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13','http://forum.csdn.net/PointForum/Manage/DeleteReply.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;replyId=25052652&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13');return false}catch(ex){}">管理</a></li>
		<li><a href="#top" class="nob">TOP</a></li>
		</ul>
		<div class="rt"></div>
	</div>
</td></tr></tbody></table>
<div class="clear"></div>
<table csdnid="rt_25060376" class="mframe" cellpadding="0" cellspacing="0"><tbody><tr><td rowspan="2" class="lf"><div class="df">
	<ul>
		<li class="center"><a href="http://hi.csdn.net/cugblue" target="_top" onclick="LogClickCount(this,111);"><img src="2_cugblue.jpg" title="cugblue用户自定义头像" alt="cugblue用户头像"></a></li>
		<li title="截至2011-01-29 10:08:59，用户的总技术分为：162；截至2011-01-23日，用户的总技术分排名为：84651"><dfn><a href="http://hi.csdn.net/cugblue" target="_top" onclick="LogClickCount(this,111);">cugblue</a></dfn></li>
		<li title="截至2011-01-29 10:08:59，用户的总技术分为：162；截至2011-01-23日，用户的总技术分排名为：84651">(Blue)</li>
		<li class="honor"></li>
		<li title="截至2011-01-29 10:08:59，用户的总技术分为：162；截至2011-01-23日，用户的总技术分排名为：84651">等　级：<img alt="" src="blank_001.gif" class="grade user2"></li>
		<li></li>
	</ul>
</div></td><td class="rw">
	<div class="fbart"><dfn>#2楼 得分：0</dfn>回复于：2004-10-24 21:04:53</div>
<a name="r_25060376"></a>
	<table class="mtxt" cellpadding="0" cellspacing="0"><tbody><tr><td csdnid="rbody_25060376" id="rbody_25060376">
<div class="msgfont">就是发送一个TCP包，发送似乎是成功的，接着用pcap_next_ex捕获回来的包。但pcap_next_ex返回0</div>
<!--End_rbody_25060376//--></td></tr>
	<tr><td csdnid="rmodify_25060376"></td></tr></tbody></table>
</td></tr><tr><td class="rb">
	<div class="fbarb">
	   <ul>
		<li><a href="javascript:;" class="dr nob" onclick="try{Estimate(this,'http://forum.csdn.net/PointForum/Forum/EstimateReply.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;replyId=25060376&amp;type=0&amp;v=13');LogClickCount(this,113);}catch(ex){}return false;">对我有用</a>[<span csdnid="racount_25060376" title="该回复被0个用户给予好评">0</span>]</li>
		<li><a href="javascript:;" class="gr nob" onclick="try{Estimate(this,'http://forum.csdn.net/PointForum/Forum/EstimateReply.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;replyId=25060376&amp;type=1&amp;v=13');LogClickCount(this,114);}catch(ex){}return false;">丢个板砖</a>[<span csdnid="rucount_25060376" title="该回复被0个用户给予差评">0</span>]</li>
		<li><a href="javascript:;" class="gr" onclick="try{Quote(2);}catch(ex){};return false">引用</a></li>
		<li><a href="javascript:;" class="dr" onclick="try{report(2);}catch(ex){}return false;">举报</a></li>
		<li><a href="javascript:;" class="gr" onmousemove="try{showMenu(this,'http://forum.csdn.net/PointForum/Manage/ModifyReply.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;replyId=25060376&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13','http://forum.csdn.net/PointForum/Manage/DeleteReply.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;replyId=25060376&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13');return false}catch(ex){}">管理</a></li>
		<li><a href="#top" class="nob">TOP</a></li>
		</ul>
		<div class="rt"></div>
	</div>
</td></tr></tbody></table>
<div class="clear"></div>

<!--append reply-->
<!-- google_ad_section_end -->


	<div class="fm">
	    <ul class="menu">
	    <li class="bt1"><a href="javascript:;" class="bt1">管理菜单<!--[if IE 7]><!--></a><!--<![endif]-->
	    <!--[if lte IE 6]><table><tr><td><![endif]-->
		<ul>
			<li><a id="a_head_recreate" href="http://forum.csdn.net/PointForum/BuildTopic.aspx?topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;return=">生成帖子</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/Tops/InsertTop.aspx?topicUrl=http://topic.csdn.net/t/20041024/12/3485745.html&amp;text=%e5%9c%a8winpcap%e4%b8%ad%ef%bc%8c%e6%88%91%e7%9a%84pcap_next_ex%e8%bf%94%e5%9b%9e%e5%80%bc%e6%98%af0&amp;sectionID=4269c85a-666c-44a6-84b0-8841db1e7f68',width:600,height:265,title:'置顶'});}catch(ex){}return false;">置顶</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/SetPrime.aspx?forumid=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicid=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13',width:400,height:255,title:'推荐'});}catch(ex){}return false;">推荐</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/SetNotPrime.aspx?topicid=00000000-0000-0000-0000-000003485745&amp;forumid=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13',width:400,height:255,title:'取消推荐'});}catch(ex){}return false;">取消推荐</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/LockTopic.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13',width:425,height:330,title:'锁定'});}catch(ex){}return false;">锁定</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/UnlockTopic.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13',width:425,height:330,title:'解锁'});}catch(ex){}return false;">解锁</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/MoveTopic.aspx?fid=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;tid=00000000-0000-0000-0000-000003485745&amp;date=2004-10-24+12%3a09%3a28',width:580,height:270,title:'移动'});}catch(ex){}return false;">移动</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/ModifyTopic.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;v=13',width:670,height:655,title:'编辑'});}catch(ex){}return false;">编辑</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/DeleteTopic.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28',width:425,height:330,title:'删除'});}catch(ex){}return false;">删除</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Forum/TopicAddPoint.aspx?forumId=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicId=00000000-0000-0000-0000-000003485745&amp;date=2004-10-24+12%3a09%3a28&amp;v=13',width:420,height:300,title:'帖子加分'});}catch(ex){}return false;">帖子加分</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/TitleStyle.aspx?topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;url=http://topic.csdn.net/t/20041024/12/3485745.html',width:670,height:307,title:'帖子高亮'});}catch(ex){}return false;">帖子高亮</a></li>
			<li><a href="javascript:;" onclick="try{showWindow({url:'http://forum.csdn.net/PointForum/Manage/RemoveTitleStyle.aspx?topicId=00000000-0000-0000-0000-000003485745&amp;postDate=2004-10-24+12%3a09%3a28&amp;url=http://topic.csdn.net/t/20041024/12/3485745.html',width:670,height:255,title:'取消高亮'});}catch(ex){}return false;">取消高亮</a></li>
		</ul>
         <!--[if lte IE 6]></td></tr></table></a><![endif]-->
	    </li>
		<li><a href="http://forum.csdn.net/PointForum/Manage/TopicManageView.aspx?forumID=4269c85a-666c-44a6-84b0-8841db1e7f68&amp;topicID=00000000-0000-0000-0000-000003485745&amp;date=2004-10-24+12%3a09%3a28&amp;v=13" class="bt2">结&nbsp;&nbsp;帖</a></li>
		<li><a href="http://forum.csdn.net/PointForum/Forum/PostTopic.aspx?forumID=4269c85a-666c-44a6-84b0-8841db1e7f68" target="_top" class="bt3">发&nbsp;&nbsp;帖</a></li>
		<li><a href="#r_achor" class="bt4" onclick="try{ReplyBoxFocus();return false}catch(ex){}">回&nbsp;&nbsp;复</a></li>
	    </ul>
	    
	</div>
	
	

<table class="comt" cellpadding="0" cellspacing="0"><tbody><tr><td style="width: 200px;">
<iframe id="Iframe1" marginwidth="0" marginheight="0" src="index_4.html" frameborder="0" height="415px" scrolling="no" width="200px"></iframe>
</td><td>
<iframe class="replyframe" id="replyframe" src="index_5.html" csdnid="rframe" frameborder="0" height="415px" scrolling="no" width="100%"></iframe>
</td></tr>
</tbody></table>



<img alt="" src="pv.aspx" style="display: none;" border="0" height="0" width="0">
<div></div>
<div id="ad_left" style="position: absolute; width: 120px; top: 184px; left: 10px; display: none;">
<a style="float: right;" href="#" onclick="javascript:this.parentNode.style.display='none';return false;">[关闭]</a>

</div>
<div id="ad_right" style="position: absolute; width: 120px; top: 184px; right: 10px; display: none;">
<a style="float: left;" href="#" onclick="javascript:this.parentNode.style.display='none';return false;">[关闭]</a>

</div>

 
</div>



</body>
</html>
