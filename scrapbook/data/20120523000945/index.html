<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="zh" xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta http-equiv="X-UA-Compatible" content="IE=8">
    
    <meta http-equiv="content-style-type" content="text/css">
    <meta http-equiv="content-script-type" content="text/javascript">
    <meta name="version" content="neblog-1.0">
    
<title>WinSock2编程之打造完整的SOCKET池 - 兵临天下的日志 - 网易博客</title>
<meta name="author" content="binyingcool,兵临天下">
<meta name="keywords" content="WinSock2编程之打造完整的SOCKET池,日志,兵临天下,binying酷酷,网易博客,网易,blog">
<meta name="description" content="WinSock2编程之打造完整的SOCKET池,兵临天下的网易博客,美丽的夜空 飞向你我,">
  
    
    
  <!--[if lte IE 6]>
  <style type="text/css">
    html,body,#blog-163-com-ie6body{height:100%;width:100%;overflow:hidden;}
    #blog-163-com-ie6body{overflow:auto;overflow-y:scroll;}
    #blog-163-com{background:none;}
  </style>
  <![endif]-->
  
  
  
  
  
  
<link rel="stylesheet" type="text/css" href="index.css" media="all">
</head>
<body id="blog-163-com" class="nb-body nb-inr nb-prv">
  <!--[if lte IE 6]><div id="blog-163-com-ie6bodywrap" class=""><![endif]-->
    <!--[if lte IE 6]><div id="blog-163-com-ie6body" class="nb-body"><![endif]-->



<div class="blogtoptips phide" id="blog-163-com-toptips">
 <div class="blogtoptipswrap">
    <div id="newbulletinstip" class="newbulletinstip phide">
    <a class="lnknews fc03 m2a tiptag phide" href="http://binyingcool.blog.163.com/blog/static/162073187201031503913440/" target="_top"></a><span class="txtnews tiptag phide"></span>&nbsp;&nbsp;&nbsp;<a class="fc03 ul nextorprevnews tiptag phide" href="http://binyingcool.blog.163.com/blog/static/162073187201031503913440/" hidefocus="true">显示下一条</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a class="fc03 ul close tiptag" href="http://binyingcool.blog.163.com/blog/static/162073187201031503913440/" hidefocus="true">关闭</a>
  </div>
 </div>
    <div id="$_faxiantip" class="faxiantip phide">
      <div>
	    <a class="m2a iblock" href="http://blog.163.com/public/explore/?fromblogbanner" target="_top"></a>
	    <span class="faxiantag m2a"></span>
      </div>
    </div>
    <div id="$_guanggaotip" class="guanggaotip phide">
      <div>
	    
	    <span class="guanggaotag m2a"></span>
      </div>
    </div>
    <div id="$_lofterInviteTip" class="lofterInviteTip phide">
      <div>
	    <a class="m2a iblock" href="http://www.lofter.com/invite/163blog/?email=" target="_top"></a>
	    <span class="lofterInviteTag m2a"></span>
      </div>
    </div>
</div>  <div class="nb-wrap wsy" id="blog-163-com-main"><div class="nb-are nb-top">
  
</div>  <div class="nb-are nb-smt"><div class="wkg h space"><div class="l h">&nbsp;</div><div class="r h">&nbsp;</div><div class="c h">&nbsp;</div></div></div>
  <div class="nb-are nb-cnt">
    <div class="wkg">
      <div class="c wc h clearfix " id="blog-163-com-container">
  <div class="nb-mdl lcr m-3 " id="-3">
  
    <div class="nb-mc lcr">
      <div class="c cc lcr nb-jsc">
<div class="nbw-ryt ztag clearfix ">
  <div class="right bdwl bds0 bdc0"></div>
  <div class="left">
     <div class="lcnt bdwr bds0 bdc0 ">   
       
     <div class="mcnt ztag"> 
      <div class="nbw-bitm bdwb bds2 bdc0 ">
        <div class="multicntwrap">
	      <div class="multicnt">
	      	<div>
		      <h3 class="title pre fs1"><span class="tcnt">WinSock2编程之打造完整的SOCKET池</span>&nbsp;&nbsp;<span class="bgc0 fc07 fw0 fs0"></span></h3>
		      
		    </div>
	      </div>
        </div>
        
        <div>
        
        </div>
        
        <div class="nbw-blog-start"></div>
        <div class="bct fc05 fc11 nbw-blog ztag js-fs2"><p style="text-indent: 2em;" align="center"><strong><font size="5">WinSock2编程之打造完整的SOCKET池</font></strong></p>  <p style="text-indent: 2em;"><a rel="nofollow" href="http://gamebabyrocksun.blog.163.com/blog/#m=0&amp;t=1&amp;c=fks_087074083081081068087084085095081081080070087082080064">IOCP编程</a>&nbsp;&nbsp;</p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>在Winodows平台上，网络编程的主要接口就是WinSock，目前大多数的Windows平台上的WinSock平台已经升级到2.0版，简称为WinSock2。在WinSock2中扩展了很多很有用的Windows味很浓的SOCKET专用API，为Windows平台用户提供高性能的网络编程支持。这些函数中的大多数已经不再是标准的“Berkeley”套接字模型的API了。使用这些函数的代价就是你不能再将你的网络程序轻松的移植到“尤里平台”（我给Unix +Linux平台的简称）下，反过来因为Windows平台支持标准的“Berkeley”套接字模型，所以你可以将大多数尤里平台下的网络应用移植到Windows平台下。</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>如果不考虑可移植性（或者所谓的跨平台性），而是着重于应用的性能时，尤其是注重服务器性能时，对于Windows的程序，都鼓励使用WinSock2扩展的一些API，更鼓励使用IOCP模型，因为这个模型是目前Windows平台上比较完美的一个高性能IO编程模型，它不但适用于SOCKET编程，还适用于读写硬盘文件，读写和管理命名管道、邮槽等等。如果再结合Windows线程池，IOCP几乎可以利用当今硬件所有可能的新特性（比如多核，DMA，高速总线等等），本身具有先天的扩展性和可用性。</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>今天讨论的重点就是SOCKET池。很多VC程序员也许对SOCKET池很陌生，也有些可能很熟悉，那么这里就先讨论下这个概念。</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>在Windows平台上SOCKET实际上被视作一个内核对象的句柄，很多Windows API在支持传统的HANDLE参数的同时也支持SOCKET，比如有名的CreateIoCompletionPort就支持将SOCKET句柄代替HANDLE参数传入并调用。熟悉Windows内核原理的读者，立刻就会发现，这样的话，我们创建和销毁一个SOCKET句柄，实际就是在系统内部创建了一个内核对象，对于Windows来说这牵扯到从Ring3层到Ring0层的耗时操作，再加上复杂的安全审核机制，实际创建和销毁一个SOCKET内核对象的成本还是蛮高的。尤其对于一些面向连接的SOCKET应用，服务端往往要管理n多个代表客户端通信的SOCKET对象，而且因为客户的变动性，主要面临的大量操作除了一般的收发数据，剩下的就是不断创建和销毁SOCKET句柄，对于一个频繁接入和断开的服务器应用来说，创建和销毁SOCKET的性能代价立刻就会体现出来，典型的例如WEB服务器程序，就是一个需要频繁创建和销毁SOCKET句柄的SOCKET应用。这种情况下我们通常都希望对于断开的SOCKET对象，不是简单的“销毁”了之（很多时候“断开”的含义不一定就等价于“销毁”，可以仔细思考一下），更多时候希望能够重用这个SOCKET对象，这样我们甚至可以事先创建一批SOCKET对象组成一个“池”，在需要的时候“重用”其中的SOCKET对象，不需要的时候将SOCKET对象重新丢入池中即可，这样就省去了频繁创建销毁SOCKET对象的性能损失。<span style="border-bottom: medium solid #33FF33;" class="linemarker-marked-line">在原始的“Berkeley”套接字模型中，想做到这点是没有什么办法的。</span>而幸运的是在Windows平台上，尤其是支持WinSock2的平台上，已经提供了一套完整的API接口用于支持SOCKET池。</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>对于符合以上要求的SOCKET池，首先需要做到的就是对SOCKET句柄的“回收”，因为创建函数无论在那个平台上都是现成的，而最早能够实现这个功能的WinSock函数就是TransmitFile，如果代替closesocket函数像下面这样调用就可以“回收”一个SOCKET句柄，而不是销毁：（注意“回收”这个功能对于TransmitFile函数来说只是个“副业”。）</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong><span style="border-bottom: medium solid #33FF33;" class="linemarker-marked-line">TransmitFile(hSocket,NULL,0,0,NULL,NULL,TF_DISCONNECT | TF_REUSE_SOCKET );</span></strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong><span style="border-bottom: medium solid #33FF33;" class="linemarker-marked-line">注意上面函数的最后一个参数，使用了标志TF_DISCONNECT和TF_REUSE_SOCKET，第一个值表示断开，第二个值则明确的表示“重用”实际上也就是回收这个SOCKET，经过这个处理的SOCKET句柄，就可以直接再用于connect等操作</span>，但是此时我们会发现，这个回收来的SOCKET似乎没什么用，因为其他套接字函数没法直接利用这个回收来的SOCKET句柄。</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>这时就要WinSock2的一组专用API上场了。我将它们按传统意义上的服务端和客户端分为两组：</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>一、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 服务端：</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>SOCKET WSASocket(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int af,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int type,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int protocol,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPWSAPROTOCOL_INFO lpProtocolInfo,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;GROUP g,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwFlags</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>BOOL AcceptEx(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCKET sListenSocket,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCKET sAcceptSocket,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PVOID lpOutputBuffer,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwReceiveDataLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwLocalAddressLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwRemoteAddressLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __out&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPDWORD lpdwBytesReceived,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPOVERLAPPED lpOverlapped</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>BOOL DisconnectEx(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCKET hSocket,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPOVERLAPPED lpOverlapped,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwFlags,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD reserved</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>二、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 客户端：</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>SOCKET WSASocket(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int af,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int type,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int protocol,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPWSAPROTOCOL_INFO lpProtocolInfo,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GROUP g,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwFlags</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>BOOL PASCAL ConnectEx(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCKET s,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const struct sockaddr* name,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int namelen,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in_opt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PVOID lpSendBuffer,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwSendDataLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __out&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPDWORD lpdwBytesSent,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPOVERLAPPED lpOverlapped</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>BOOL DisconnectEx(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCKET hSocket,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPOVERLAPPED lpOverlapped,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwFlags,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; __in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD reserved</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>注意观察这些函数，似乎和传统的“Berkeley”套接字模型中的一些函数“大同小异”，其实仔细观察他们的参数，就已经可以发现一些调用他们的“玄机”了。</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>首先我们来看AcceptEx函数，与accept函数不同，它需要两个SOCKET句柄作为参数，头一个参数的含义与accept函数的相同，而第二个参数的意思就是accept函数返回的那个代表与客户端通信的SOCKET句柄，在传统的accept内部，实际在返回那个代表客户端的SOCKET时，是在内部调用了一个SOCKET的创建动作，先创建这个SOCKET然后再“accept”让它变成代表客户端连接的SOCKET，而AcceptEx函数就在这里“扩展”（实际上是“阉割”才对）accept函数，省去了内部那个明显的创建SOCKET的动作，而将这个创建动作交给最终的调用者自己来实现。AcceptEx要求调用者创建好那个sAcceptSocket句柄然后传进去，这时我们立刻发现，我们回收的那个SOCKET是不是也可以传入呢？答案是肯定的，我们就是可以利用这个函数传入那个“回收”来的SOCKET句柄，最终实现服务端的SOCKET重用。</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>这里需要注意的就是，AcceptEx函数必须工作在非阻塞的IOCP模型下，同时即使AcceptEx函数返回了，也不代表客户端连接进来或者连接成功了，我们必须依靠它的“完成通知”才能知道这个事实，这也是AcceptEx函数区别于accept这个阻塞方式函数的最大之处。通常可以利用AcceptEx的非阻塞特性和IOCP模型的优点，一次可以“预先”发出成千上万个AcceptEx调用，“等待”客户端的连接。对于习惯了accept阻塞方式的程序员来说，理解AcceptEx的工作方式还是需要费一些周折的。下面的例子就演示了如何一次调用多个AcceptEx：</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>//批量创建SOCKET，并调用对应的AcceptEx</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>for(UINT i = 0; i &lt; 1000; i++)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{//调用1000次</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>//创建与客户端通讯的SOCKET，注意SOCKET的创建方式</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>skAccept = ::WSASocket(AF_INET,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCK_STREAM,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IPPROTO_TCP, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NULL, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WSA_FLAG_OVERLAPPED);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>if (INVALID_SOCKET == skAccept) </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; &nbsp; throw CGRSException((DWORD)WSAGetLastError());</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>//创建一个自定义的OVERLAPPED扩展结构，使用IOCP方式调用</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>pAcceptOL = new CGRSOverlappedData(GRS_OP_ACCEPT</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>,this,skAccept,NULL);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>pAddrBuf = pAcceptOL-&gt;GetAddrBuf();</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>//4、发出AcceptEx调用</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>//注意将AcceptEx函数接收连接数据缓冲的大小设定成了0，这将导致此函数立即返回，虽然与</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>//不设定成0的方式而言，这导致了一个较低下的效率，但是这样提高了安全性，所以这种效率</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>//牺牲是必须的</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>if(!AcceptEx(m_skServer, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; skAccept,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pAddrBuf-&gt;m_pBuf, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0,//将接收缓冲置为0,令AcceptEx直接返回,防止拒绝服务攻击</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GRS_ADDRBUF_SIZE, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GRS_ADDRBUF_SIZE, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NULL,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (LPOVERLAPPED)pAcceptOL))</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>int iError = WSAGetLastError();</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>if( ERROR_IO_PENDING != iError </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; &amp;&amp; WSAECONNRESET != iError )</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; if(INVALID_SOCKET != skAccept)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; {</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;::closesocket(skAccept);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;skAccept = INVALID_SOCKET;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; }</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; &nbsp;&nbsp; if( NULL != pAcceptOL)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; {</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GRS_ISVALID(pAcceptOL,sizeof(CGRSOverlappedData));</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>delete pAcceptOL;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; pAcceptOL = NULL;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; }</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; }</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>以上的例子只是简单的演示了AcceptEx的调用，还没有涉及到真正的“回收重用”这个主题，那么下面的例子就演示了如何重用一个SOCKET句柄：</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>if(INVALID_SOCKET == skClient)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>throw CGRSException(_T("SOCKET句柄是无效的！"));</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>On<wbr>PreDisconnected(skClient,pUseData,0);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>CGRSOverlappedData*pData</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>= new GRSOverlappedData(GRS_OP_DISCONNECTEX</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>,this,skClient,pUseData);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>//回收而不是关闭后再创建大大提高了服务器的性能</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>DisconnectEx(skClient,&amp;pData-&gt;m_ol,TF_REUSE_SOCKET,0);&nbsp; </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>......</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //在接收到DisconnectEx函数的完成通知之后，我们就可以重用这个SOCKET了</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>CGRSAddrbuf*pBuf = NULL;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>pNewOL = new CGRSOverlappedData(GRS_OP_ACCEPT</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>,this,skClient,pUseData);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>pBuf = pNewOL-&gt;GetAddrBuf();</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>//把这个回收的SOCKET重新丢进连接池</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>if(!AcceptEx(m_skServer,skClient,pBuf-&gt;m_pBuf, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0,//将接收缓冲置为0,令AcceptEx直接返回,防止拒绝服务攻击</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GRS_ADDRBUF_SIZE, GRS_ADDRBUF_SIZE, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NULL,(LPOVERLAPPED)pNewOL))</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>int iError = WSAGetLastError();</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp; &nbsp;if( ERROR_IO_PENDING != iError </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &amp;&amp; WSAECONNRESET != iError )</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp; &nbsp;{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; throw CGRSException((DWORD)iError);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp; &nbsp; }</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>//注意在这个SOCKET被重新利用后，重新与IOCP绑定一下，该操作会返回一个已设置的错误，这个错误直接被忽略即可</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>::BindIoCompletionCallback((HANDLE)skClient</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>,Server_IOCPThread, 0);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>至此回收重用SOCKET的工作也就结束了，以上的过程实际理解了IOCP之后就比较好理解了，例子的最后我们使用了BindIoCompletionCallback函数重新将SOCKET丢进了IOCP线程池中，实际还可以再次使用CreateIoCompletionPort函数达到同样的效果，这里列出这一步就是告诉大家，不要忘了再次绑定一下完成端口和SOCKET。</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp; &nbsp;对于客户端来说，可以使用ConnectEx函数来代替connect函数，与AcceptEx函数相同，ConnectEx函数也是以非阻塞的IOCP方式工作的，唯一要注意的就是在WSASocket调用之后，在ConnectEx之前要调用一下bind函数，将SOCKET提前绑定到一个本地地址端口上，当然回收重用之后，就无需再次绑定了，这也是ConnectEx较之connect函数高效的地方之一。</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp; 与AcceptEx函数类似，也可以一次发出成千上万个ConnectEx函数的调用，可以连接到不同的服务器，也可以连接到相同的服务器，连接到不同的服务器时，只需提供不同的sockaddr即可。</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp; &nbsp;通过上面的例子和讲解，大家应该对SOCKET池概念以及实际的应用有个大概的了解了，当然核心仍然是理解了IOCP模型，否则还是寸步难行。</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>在上面的例子中，回收SOCKET句柄主要使用了DisconnectEx函数，而不是之前介绍的TransmitFile函数，为什么呢？因为TransmitFile函数在一些情况下会造成死锁，无法正常回收SOCKET，毕竟不是专业的回收重用SOCKET函数，我就遇到过好几次死锁，最后偶然的发现了DisconnectEx函数这个专用的回收函数，调用之后发现比TransmitFile专业多了，而且不管怎样都不会死锁。</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>最后需要补充的就是这几个函数的调用方式，不能像传统的SOCKET API那样直接调用它们，而需要使用一种间接的方式来调用，尤其是AcceptEx和DisconnectEx函数，下面给出了一个例子类，用于演示如何动态载入这些函数并调用之：</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>class CGRSMsSockFun</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>public:</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>CGRSMsSockFun(SOCKET skTemp = INVALID_SOCKET)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; if( INVALID_SOCKET != skTemp )</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; {</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadAllFun(skTemp);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>public:</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>virtual ~CGRSMsSockFun(void)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>protected:</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>BOOL LoadWSAFun(SOCKET&amp; skTemp,GUID&amp;funGuid,void*&amp;pFun)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwBytes = 0;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; BOOL bRet = TRUE;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; pFun = NULL;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; BOOL bCreateSocket = FALSE;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; try</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; {</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(INVALID_SOCKET == skTemp)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; skTemp = ::WSASocket(AF_INET,SOCK_STREAM, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IPPROTO_TCP,NULL,0,WSA_FLAG_OVERLAPPED);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>bCreateSocket = (skTemp != INVALID_SOCKET);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>if(INVALID_SOCKET == skTemp)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw CGRSException((DWORD)WSAGetLastError());</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(SOCKET_ERROR == ::WSAIoctl(skTemp,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SIO_GET_EXTENSION_FUNCTION_POINTER, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;funGuid,sizeof(funGuid),</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;pFun,sizeof(pFun),&amp;dwBytes,NULL,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NULL))</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pFun = NULL;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw CGRSException((DWORD)WSAGetLastError());</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; }</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; catch(CGRSException&amp; e)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; {</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;if(bCreateSocket)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;::closesocket(skTemp);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; }</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; return NULL != pFun;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>protected:</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>LPFN_ACCEPTEX m_pfnAcceptEx;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>LPFN_CONNECTEX m_pfnConnectEx;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>LPFN_DISCONNECTEX m_pfnDisconnectEx;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>LPFN_GETACCEPTEXSOCKADDRS m_pfnGetAcceptExSockaddrs;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>LPFN_TRANSMITFILE m_pfnTransmitfile;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>LPFN_TRANSMITPACKETS m_pfnTransmitPackets;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>LPFN_WSARECVMSG m_pfnWSARecvMsg;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>protected:</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>BOOL LoadAcceptExFun(SOCKET &amp;skTemp)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GUID GuidAcceptEx = WSAID_ACCEPTEX;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return LoadWSAFun(skTemp,GuidAcceptEx</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>,(void*&amp;)m_pfnAcceptEx);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>BOOL LoadConnectExFun(SOCKET &amp;skTemp)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GUID GuidAcceptEx = WSAID_CONNECTEX;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return LoadWSAFun(skTemp,GuidAcceptEx</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>,(void*&amp;)m_pfnConnectEx);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>BOOL LoadDisconnectExFun(SOCKET&amp;skTemp)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GUID GuidDisconnectEx = WSAID_DISCONNECTEX;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return LoadWSAFun(skTemp,GuidDisconnectEx</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>,(void*&amp;)m_pfnDisconnectEx);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>BOOL LoadGetAcceptExSockaddrsFun(SOCKET &amp;skTemp)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GUID GuidGetAcceptExSockaddrs </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>= WSAID_GETACCEPTEXSOCKADDRS;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return LoadWSAFun(skTemp,GuidGetAcceptExSockaddrs</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>,(void*&amp;)m_pfnGetAcceptExSockaddrs);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>BOOL LoadTransmitFileFun(SOCKET&amp;skTemp)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GUID GuidTransmitFile = WSAID_TRANSMITFILE;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return LoadWSAFun(skTemp,GuidTransmitFile</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>,(void*&amp;)m_pfnTransmitfile);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>BOOL LoadTransmitPacketsFun(SOCKET&amp;skTemp)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GUID GuidTransmitPackets = WSAID_TRANSMITPACKETS;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return LoadWSAFun(skTemp,GuidTransmitPackets</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>,(void*&amp;)m_pfnTransmitPackets);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>BOOL LoadWSARecvMsgFun(SOCKET&amp;skTemp)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GUID GuidTransmitPackets = WSAID_TRANSMITPACKETS;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return LoadWSAFun(skTemp,GuidTransmitPackets</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>,(void*&amp;)m_pfnWSARecvMsg);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>public:</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>BOOL LoadAllFun(SOCKET skTemp)</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{//注意这个地方的调用顺序，是根据服务器的需要，并结合了表达式副作用</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; //而特意安排的调用顺序</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; return (LoadAcceptExFun(skTemp) &amp;&amp;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadGetAcceptExSockaddrsFun(skTemp) &amp;&amp;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadTransmitFileFun(skTemp) &amp;&amp;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadTransmitPacketsFun(skTemp) &amp;&amp;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadDisconnectExFun(skTemp) &amp;&amp;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadConnectExFun(skTemp) &amp;&amp; </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadWSARecvMsgFun(skTemp));</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>public:</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>GRS_FORCEINLINE BOOL AcceptEx (</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCKET sListenSocket,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCKET sAcceptSocket,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PVOID lpOutputBuffer,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwReceiveDataLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwLocalAddressLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwRemoteAddressLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPDWORD lpdwBytesReceived,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPOVERLAPPED lpOverlapped</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GRS_ASSERT(NULL != m_pfnAcceptEx);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return m_pfnAcceptEx(sListenSocket,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sAcceptSocket,lpOutputBuffer,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dwReceiveDataLength,dwLocalAddressLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dwRemoteAddressLength,lpdwBytesReceived,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lpOverlapped);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>GRS_FORCEINLINE BOOL ConnectEx(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCKET s,const struct sockaddr FAR *name,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int namelen,PVOID lpSendBuffer,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwSendDataLength,LPDWORD lpdwBytesSent,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPOVERLAPPED lpOverlapped</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GRS_ASSERT(NULL != m_pfnConnectEx);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return m_pfnConnectEx(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; s,name,namelen,lpSendBuffer,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dwSendDataLength,lpdwBytesSent,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lpOverlapped</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>GRS_FORCEINLINE BOOL DisconnectEx(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCKET s,LPOVERLAPPED lpOverlapped,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD&nbsp; dwFlags,DWORD&nbsp; dwReserved</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GRS_ASSERT(NULL != m_pfnDisconnectEx);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return m_pfnDisconnectEx(s,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lpOverlapped,dwFlags,dwReserved);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>GRS_FORCEINLINE VOID GetAcceptExSockaddrs (</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PVOID lpOutputBuffer,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwReceiveDataLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwLocalAddressLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwRemoteAddressLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sockaddr **LocalSockaddr,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPINT LocalSockaddrLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sockaddr **RemoteSockaddr,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPINT RemoteSockaddrLength</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GRS_ASSERT(NULL != m_pfnGetAcceptExSockaddrs);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return m_pfnGetAcceptExSockaddrs(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lpOutputBuffer,dwReceiveDataLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dwLocalAddressLength,dwRemoteAddressLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LocalSockaddr,LocalSockaddrLength,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RemoteSockaddr,RemoteSockaddrLength</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>GRS_FORCEINLINE BOOL TransmitFile(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; SOCKET hSocket,HANDLE hFile,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; DWORD nNumberOfBytesToWrite,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; DWORD nNumberOfBytesPerSend,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; LPOVERLAPPED lpOverlapped,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; LPTRANSMIT_FILE_BUFFERS lpTransmitBuffers,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwReserved</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; )</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GRS_ASSERT(NULL != m_pfnTransmitfile);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return m_pfnTransmitfile(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hSocket,hFile,nNumberOfBytesToWrite,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nNumberOfBytesPerSend,lpOverlapped,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lpTransmitBuffers,dwReserved</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>GRS_FORCEINLINE BOOL TransmitPackets(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; SOCKET hSocket,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; LPTRANSMIT_PACKETS_ELEMENT lpPacketArray,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; DWORD nElementCount,DWORD nSendSize,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; LPOVERLAPPED lpOverlapped,DWORD dwFlags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; )</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GRS_ASSERT(NULL != m_pfnTransmitPackets);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return m_pfnTransmitPackets(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hSocket,lpPacketArray,nElementCount,</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>nSendSize,lpOverlapped,dwFlags</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>GRS_FORCEINLINE INT WSARecvMsg(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCKET s,LPWSAMSG lpMsg, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPDWORD lpdwNumberOfBytesRecvd, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPWSAOVERLAPPED lpOverlapped, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LPWSAOVERLAPPED_COMPLETION_ROUTINE lpCompletionRoutine</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>{</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; GRS_ASSERT(NULL != m_pfnWSARecvMsg);</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp; return m_pfnWSARecvMsg(</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; s,lpMsg,lpdwNumberOfBytesRecvd, </strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lpOverlapped,lpCompletionRoutine</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>}</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>/*WSAID_ACCEPTEX</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; WSAID_CONNECTEX</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; WSAID_DISCONNECTEX</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; WSAID_GETACCEPTEXSOCKADDRS</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; WSAID_TRANSMITFILE</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; WSAID_TRANSMITPACKETS</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; WSAID_WSARECVMSG</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>&nbsp; WSAID_WSASENDMSG */</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>};</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>这个类的使用非常简单，只需要声明一个类的对象，然后调用其成员AcceptEx、DisconnectEx函数等即可，参数与这些函数的MSDN声明方式完全相同，除了本文中介绍的这些函数外，这个类还包含了很多其他的Winsock2函数，那么都应该按照这个类中演示的这样来动态载入后再行调用，如果无法载入通常说明你的环境中没有Winsock2函数库，或者是你初始化的不是2.0版的Winsock环境。</strong></font></p>  <p style="text-indent: 2em;"><font color="#0000ff" size="4"><strong>这个类是本人完整类库的一部分，如要使用需要自行修改一些地方，如果不知如何修改或遇到什么问题，可以直接跟帖说明，我会不定期回答大家的问题，这个类可以免费使用、分发、修改，可以用于任何商业目的，但是对于使用后引起的任何问题，本人概不负责，有问题请跟帖。关于AcceptEx以及其他一些函数，包括本文中没有介绍到得函数，我会在后续的一些专题文章中进行详细深入的介绍，敬请期待。如果你有什么疑问，或者想要了解什么也请跟帖说明，我会在后面的文章中尽量说明。</strong></font></p>  <p style="text-indent: 2em;"></p></div>
        <div class="nbw-blog-end"></div>

        <div>
		</div>
		
        <div>
		</div>
		
		<div>
      	  <div>
		  	<div class="wumii-hook"></div>
		  </div>
		</div>
		
        <div class="ptc phide ztag">
          <span class="ptcp">
            <span class="iblock bcmimg">&nbsp;</span>
            <span class="nbc-0 nbc-0-40 ptcmt ptcmt-2">评论这张</span>
          </span>
        </div>
		<div class="ptc phide ztag">
          <span class="ptcp">
            <span class="nbc-0 nbc-0-40 ptcmi">
              <img src="microblog.png">
            </span>
            <span class="nbc-0 nbc-0-40 ptcmt">转发至微博</span>
          </span>
        </div>
        <div style="left: 457px; top: 652px;" class="ptc ztag phide">
          <span class="ptcp">
            <span class="nbc-0 nbc-0-40 ptcmi">
              <img src="microblog.png">
            </span>
            <span class="nbc-0 nbc-0-40 ptcmt">转发至微博</span>
          </span>
        </div>
        
        
        
      </div>
      
      <div class="cite ztag fc03 phide"></div>
    </div>
   </div>
  </div>
</div>



</div>
      <div class="l cl h100">&nbsp;</div>
      <div class="r cr h100">&nbsp;</div>
    </div>
    <div class="nb-mb lcr bh space">
      <div class="l bl bh">&nbsp;</div>
      <div class="r br bh">&nbsp;</div>
      <div class="c bc bh lcr">&nbsp;</div>
    </div>
  </div>

</div>
      <div class="l wl g lg h100">&nbsp;</div>
      <div class="l wl t lt">&nbsp;</div>
      <div class="l wl b lb">&nbsp;</div>
      <div class="r wr g rg h100">&nbsp;</div>
      <div class="r wr t rt">&nbsp;</div>
      <div class="r wr b rb">&nbsp;</div>
    </div>
  </div>
  <div class="nb-are nb-smb"><div class="wkg h space"><div class="l h">&nbsp;</div><div class="r h">&nbsp;</div><div class="c h">&nbsp;</div></div></div>
<div class="nb-are nb-fot">
  
</div></div>
    <!--[if lte IE 6]></div><![endif]-->
  <!--[if lte IE 6]></div><![endif]-->
  <div class="nb-layer" id="blog-163-com-layer"></div>
  

     <div style="position: absolute; top: 0pt; right: 0pt; z-index: 999; width: 1px; height: 1px; overflow: hidden;"> <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="ntsstorage" codebase="http://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab" height="1" width="1"> <param name="movie" value="/common/storage.swf?t=1337702929086"> <param name="AllowScriptAccess" value="sameDomain"> <embed src="storage.swf" name="ntsstorage" allowscriptaccess="sameDomain" type="application/x-shockwave-flash" pluginspage="http://www.adobe.com/go/getflashplayer" height="1" width="1">  </object> </div><iframe src="index_2.html" id="api.blog.163.com" name="api.blog.163.com" style="display: none;" height="0" width="0"></iframe><iframe src="index_3.html" id="photo.163.com" name="photo.163.com" style="display: none;" height="0" width="0"></iframe><iframe src="index_4.html" id="ud.blog.163.com" name="ud.blog.163.com" style="display: none;" height="0" width="0"></iframe>
    <iframe style="display: none;" id="t.163.com" src="index_5.html" frameborder="0" height="0" width="0"></iframe>
  
  


    




</body></html>
