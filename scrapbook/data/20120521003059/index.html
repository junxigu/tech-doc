<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">






<link rel="stylesheet" type="text/css" href="index.css" media="all">
</head>
<body><div id="bd_snap">
    <div id="bd_snap_head">
        <a href="http://www.baidu.com/" id="bd_snap_logo" title="到百度首页"></a>
    </div>
    <div id="bd_snap_txt">您查询的关键词是：<span><a style="color: black; background-color: rgb(255, 255, 102); padding: 0pt 3px; font-weight: bold;" href="http://cache.baidu.com/c?m=9d78d513d9d437af4f9de4690c66c0161343f4672bd6a0502488c515d6254c413627beea7e755613d2b56b1705b83e5efd803065467437b6eb99d51681ecc36e3bcf676a7f46c00750c418dcd65b608465875a9efe45b7e4ad67d2b9d2a48e090cd70d532bc1a3d84753549b35ab5066fea69b4b154212baf03362e259762e9c2647b250f997682858df&amp;p=937fc54ad5c243ed0fa8c7710e168520&amp;user=baidu&amp;fm=sc&amp;query=%D2%BB%B8%F6windows+socket%B6%E0%B4%CEconnect&amp;qid=a094189516fd48d3&amp;p1=6#baidusnap0">一个</a><a style="color: black; background-color: rgb(153, 255, 153); padding: 0pt 3px; font-weight: bold;" href="http://cache.baidu.com/c?m=9d78d513d9d437af4f9de4690c66c0161343f4672bd6a0502488c515d6254c413627beea7e755613d2b56b1705b83e5efd803065467437b6eb99d51681ecc36e3bcf676a7f46c00750c418dcd65b608465875a9efe45b7e4ad67d2b9d2a48e090cd70d532bc1a3d84753549b35ab5066fea69b4b154212baf03362e259762e9c2647b250f997682858df&amp;p=937fc54ad5c243ed0fa8c7710e168520&amp;user=baidu&amp;fm=sc&amp;query=%D2%BB%B8%F6windows+socket%B6%E0%B4%CEconnect&amp;qid=a094189516fd48d3&amp;p1=6#baidusnap2">windows</a><a style="color: black; background-color: rgb(255, 153, 153); padding: 0pt 3px; font-weight: bold;" href="http://cache.baidu.com/c?m=9d78d513d9d437af4f9de4690c66c0161343f4672bd6a0502488c515d6254c413627beea7e755613d2b56b1705b83e5efd803065467437b6eb99d51681ecc36e3bcf676a7f46c00750c418dcd65b608465875a9efe45b7e4ad67d2b9d2a48e090cd70d532bc1a3d84753549b35ab5066fea69b4b154212baf03362e259762e9c2647b250f997682858df&amp;p=937fc54ad5c243ed0fa8c7710e168520&amp;user=baidu&amp;fm=sc&amp;query=%D2%BB%B8%F6windows+socket%B6%E0%B4%CEconnect&amp;qid=a094189516fd48d3&amp;p1=6#baidusnap3">socket</a><a style="color: black; background-color: rgb(255, 102, 255); padding: 0pt 3px; font-weight: bold;" href="http://cache.baidu.com/c?m=9d78d513d9d437af4f9de4690c66c0161343f4672bd6a0502488c515d6254c413627beea7e755613d2b56b1705b83e5efd803065467437b6eb99d51681ecc36e3bcf676a7f46c00750c418dcd65b608465875a9efe45b7e4ad67d2b9d2a48e090cd70d532bc1a3d84753549b35ab5066fea69b4b154212baf03362e259762e9c2647b250f997682858df&amp;p=937fc54ad5c243ed0fa8c7710e168520&amp;user=baidu&amp;fm=sc&amp;query=%D2%BB%B8%F6windows+socket%B6%E0%B4%CEconnect&amp;qid=a094189516fd48d3&amp;p1=6#baidusnap4">多次</a><a style="color: white; background-color: rgb(136, 0, 0); padding: 0pt 3px; font-weight: bold;" href="http://cache.baidu.com/c?m=9d78d513d9d437af4f9de4690c66c0161343f4672bd6a0502488c515d6254c413627beea7e755613d2b56b1705b83e5efd803065467437b6eb99d51681ecc36e3bcf676a7f46c00750c418dcd65b608465875a9efe45b7e4ad67d2b9d2a48e090cd70d532bc1a3d84753549b35ab5066fea69b4b154212baf03362e259762e9c2647b250f997682858df&amp;p=937fc54ad5c243ed0fa8c7710e168520&amp;user=baidu&amp;fm=sc&amp;query=%D2%BB%B8%F6windows+socket%B6%E0%B4%CEconnect&amp;qid=a094189516fd48d3&amp;p1=6#baidusnap5">connect</a></span> 。如果打开速度慢，可以尝试<a href="http://cache.baidu.com/c?m=9d78d513d9d437af4f9de4690c66c0161343f4672bd6a0502488c515d6254c413627beea7e755613d2b56b1705b83e5efd803065467437b6eb99d51681ecc36e3bcf676a7f46c00750c418dcd65b608465875a9efe45b7e4ad67d2b9d2a48e090cd70d532bc1a3d84753549b35ab5066fea69b4b154212baf03362e259762e9c2647b250f997682858df&amp;p=937fc54ad5c243ed0fa8c7710e168520&amp;user=baidu&amp;fm=sc&amp;query=%D2%BB%B8%F6windows+socket%B6%E0%B4%CEconnect&amp;qid=a094189516fd48d3&amp;p1=6&amp;fast=y">快速版</a>；如果想保存快照，可以<a onclick="window.open('http://cang.baidu.com/do/add?it='+encodeURIComponent(document.title)+'&amp;iu='+encodeURIComponent(location.href)+'&amp;fr=ps#nw=1','_s','scrollbars=no,width=600,height=450,right=75,top=20,status=no,resizable=yes'); return false;" href="http://cang.baidu.com/do/add" target="_top">添加到搜藏</a>；如果想更新或删除快照，可以<a href="http://tousu.baidu.com/webmaster/add?link=http%3A%2F%2Fcache.baidu.com%2Fc%3Fm%3D9d78d513d9d437af4f9de4690c66c0161343f4672bd6a0502488c515d6254c413627beea7e755613d2b56b1705b83e5efd803065467437b6eb99d51681ecc36e3bcf676a7f46c00750c418dcd65b608465875a9efe45b7e4ad67d2b9d2a48e090cd70d532bc1a3d84753549b35ab5066fea69b4b154212baf03362e259762e9c2647b250f997682858df%26p%3D937fc54ad5c243ed0fa8c7710e168520%26user%3Dbaidu%26fm%3Dsc%26query%3D%25D2%25BB%25B8%25F6windows%2Bsocket%25B6%25E0%25B4%25CEconnect%26qid%3Da094189516fd48d3%26p1%3D6" id="bd_tousu">投诉快照</a>。</div>

    <div id="bd_snap_note">(百度和网页<a href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html">http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html</a>的作者无关，不对其内容负责。百度快照谨为网络故障时之索引，不代表被搜索网站的即时页面。)</div>
</div>
<div id="bd_snap_search">
	<form action="http://www.baidu.com/s"><input name="cl" value="3" type="hidden"><input value="" name="wd" id="bd_snap_kw" maxlength="100"><span id="bd_snap_btn_wr"><input id="bd_snap_su" value="百度一下" class="bd_snap_btn" onmousedown="this.className='bd_snap_btn bd_snap_btn_h'" type="submit"></span></form>
</div>
<div id="bd_snap_ln"></div>
<div style="position: relative;">




<title>通用异步 Windows Socket TCP 客户端组件的设计与实现 - ~怪^_*兽~ - 博客园</title>
<meta name="keywords" content="c++,windows,socket,TCP,客户端">




<link title="RSS" type="application/rss+xml" rel="alternate" href="http://www.cnblogs.com/ldcsaa/rss">
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="http://www.cnblogs.com/ldcsaa/rsd.xml">
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="http://www.cnblogs.com/ldcsaa/wlwmanifest.xml">
  
 




<a name="top"></a>
<form method="post" action="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html" id="Form1">
<input name="__VIEWSTATE" id="__VIEWSTATE" value="" type="hidden">




    
<div id="top">
	
<h1><a id="Header1_HeaderTitle" class="headermaintitle" href="http://www.cnblogs.com/ldcsaa/">~怪^_*兽~</a></h1>
<p id="tagline">虚荣锁身躯 心灵给酒醉 脆弱人类 懒问何为对</p>
</div>
<div id="leftmenu" style="display: none;">
	
		
<h3>导航</h3>
<ul>
			<li><a id="MyLinks1_HomeLink" href="http://www.cnblogs.com/">博客园</a></li>
			<li><a id="MyLinks1_MyHomeLink" href="http://www.cnblogs.com/ldcsaa/">首页</a></li>
			<li><a id="MyLinks1_NewPostLink" rel="nofollow" href="http://www.cnblogs.com/ldcsaa/admin/EditPosts.aspx?opt=1">新随笔</a></li>
			<li><a id="MyLinks1_ContactLink" accesskey="9" rel="nofollow" href="http://space.cnblogs.com/msg/send/%7e%e6%80%aa%5e_*%e5%85%bd%7e">联系</a></li>
			<li><a id="MyLinks1_Syndication" href="http://www.cnblogs.com/ldcsaa/rss">订阅</a><a id="MyLinks1_XMLLink" href="http://www.cnblogs.com/ldcsaa/rss"><img src="xml.gif" alt="订阅"></a>
			</li><li><a id="MyLinks1_Admin" rel="nofollow" href="http://www.cnblogs.com/ldcsaa/admin/EditPosts.aspx">管理</a></li>
</ul>
		<table id="Calendar1_entryCal" class="Cal" title="Calendar" cellpadding="0" cellspacing="0">
	<tbody><tr><td colspan="7" bgcolor="Silver"><table class="CalTitle" cellspacing="0" width="100%">
		<tbody><tr><td class="CalNextPrev" width="15%"><a href="javascript:__doPostBack('Calendar1$entryCal','V4383')" style="color: Black;" title="Go to the previous month">&lt;</a></td><td align="center" width="70%">2012年2月</td><td class="CalNextPrev" align="right" width="15%"><a href="javascript:__doPostBack('Calendar1$entryCal','V4443')" style="color: Black;" title="Go to the next month">&gt;</a></td></tr>
	</tbody></table></td></tr><tr><th class="CalDayHeader" abbr="日" scope="col" align="center">日</th><th class="CalDayHeader" abbr="一" scope="col" align="center">一</th><th class="CalDayHeader" abbr="二" scope="col" align="center">二</th><th class="CalDayHeader" abbr="三" scope="col" align="center">三</th><th class="CalDayHeader" abbr="四" scope="col" align="center">四</th><th class="CalDayHeader" abbr="五" scope="col" align="center">五</th><th class="CalDayHeader" abbr="六" scope="col" align="center">六</th></tr><tr><td class="CalOtherMonthDay" align="center" width="14%">29</td><td class="CalOtherMonthDay" align="center" width="14%">30</td><td class="CalOtherMonthDay" align="center" width="14%">31</td><td align="center" width="14%">1</td><td align="center" width="14%">2</td><td align="center" width="14%">3</td><td class="CalWeekendDay" align="center" width="14%">4</td></tr><tr><td class="CalWeekendDay" align="center" width="14%">5</td><td align="center" width="14%">6</td><td align="center" width="14%">7</td><td align="center" width="14%">8</td><td align="center" width="14%">9</td><td align="center" width="14%">10</td><td class="CalWeekendDay" align="center" width="14%">11</td></tr><tr><td class="CalWeekendDay" align="center" width="14%"><a href="http://www.cnblogs.com/ldcsaa/archive/2012/2/12.html"><u>12</u></a></td><td align="center" width="14%"><a href="http://www.cnblogs.com/ldcsaa/archive/2012/2/13.html"><u>13</u></a></td><td align="center" width="14%"><a href="http://www.cnblogs.com/ldcsaa/archive/2012/2/14.html"><u>14</u></a></td><td align="center" width="14%"><a href="http://www.cnblogs.com/ldcsaa/archive/2012/2/15.html"><u>15</u></a></td><td align="center" width="14%"><a href="http://www.cnblogs.com/ldcsaa/archive/2012/2/16.html"><u>16</u></a></td><td align="center" width="14%">17</td><td class="CalWeekendDay" align="center" width="14%"><a href="http://www.cnblogs.com/ldcsaa/archive/2012/2/18.html"><u>18</u></a></td></tr><tr><td class="CalWeekendDay" align="center" width="14%">19</td><td align="center" width="14%"><a href="http://www.cnblogs.com/ldcsaa/archive/2012/2/20.html"><u>20</u></a></td><td align="center" width="14%">21</td><td align="center" width="14%">22</td><td align="center" width="14%"><a href="http://www.cnblogs.com/ldcsaa/archive/2012/2/23.html"><u>23</u></a></td><td align="center" width="14%">24</td><td class="CalWeekendDay" align="center" width="14%">25</td></tr><tr><td class="CalWeekendDay" align="center" width="14%"><a href="http://www.cnblogs.com/ldcsaa/archive/2012/2/26.html"><u>26</u></a></td><td align="center" width="14%"><a href="http://www.cnblogs.com/ldcsaa/archive/2012/2/27.html"><u>27</u></a></td><td align="center" width="14%"><a href="http://www.cnblogs.com/ldcsaa/archive/2012/2/28.html"><u>28</u></a></td><td align="center" width="14%">29</td><td class="CalOtherMonthDay" align="center" width="14%">1</td><td class="CalOtherMonthDay" align="center" width="14%">2</td><td class="CalOtherMonthDay" align="center" width="14%">3</td></tr><tr><td class="CalOtherMonthDay" align="center" width="14%">4</td><td class="CalOtherMonthDay" align="center" width="14%">5</td><td class="CalOtherMonthDay" align="center" width="14%">6</td><td class="CalOtherMonthDay" align="center" width="14%">7</td><td class="CalOtherMonthDay" align="center" width="14%">8</td><td class="CalOtherMonthDay" align="center" width="14%">9</td><td class="CalOtherMonthDay" align="center" width="14%">10</td></tr>
</tbody></table>

		
<h3>公告</h3>
	<div id="profile_block">昵称：<a href="http://home.cnblogs.com/u/ldcsaa/">~怪^_*兽~</a><br>园龄：<a href="http://home.cnblogs.com/u/ldcsaa/" title="入园时间：2012-02-09">2个月</a><br>粉丝：<a href="http://home.cnblogs.com/u/ldcsaa/followers/">100</a><br>关注：<a href="http://home.cnblogs.com/u/ldcsaa/followees/">0</a><div id="p_b_follow"></div></div>

		
		
		<h3>随笔分类<span style="font-size: 11px; font-weight: normal;">(99)</span></h3>
		
				<ul>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_0_Link_0" href="http://www.cnblogs.com/ldcsaa/category/353924.html">编程技术(26)</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_0_Link_1" href="http://www.cnblogs.com/ldcsaa/category/353925.html">操作系统(8)</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_0_Link_2" href="http://www.cnblogs.com/ldcsaa/category/353926.html">读书感悟(9)</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_0_Link_3" href="http://www.cnblogs.com/ldcsaa/category/353927.html">管理运营(9)</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_0_Link_4" href="http://www.cnblogs.com/ldcsaa/category/353928.html">互联网络(19)</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_0_Link_5" href="http://www.cnblogs.com/ldcsaa/category/353929.html">软件设计(26)</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_0_Link_6" href="http://www.cnblogs.com/ldcsaa/category/353930.html">随笔 &amp; 杂谈</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_0_Link_7" href="http://www.cnblogs.com/ldcsaa/category/353931.html">移动开发(2)</a> </li>
			
				</ul>
			
	
		<h3>文章分类</h3>
		
				<ul>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_1_Link_0" href="http://www.cnblogs.com/ldcsaa/category/353457.html">编程技术</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_1_Link_1" href="http://www.cnblogs.com/ldcsaa/category/353460.html">操作系统</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_1_Link_2" href="http://www.cnblogs.com/ldcsaa/category/353463.html">读书感悟</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_1_Link_3" href="http://www.cnblogs.com/ldcsaa/category/353462.html">管理运营</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_1_Link_4" href="http://www.cnblogs.com/ldcsaa/category/353459.html">互联网络</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_1_Link_5" href="http://www.cnblogs.com/ldcsaa/category/353461.html">软件设计</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_1_Link_6" href="http://www.cnblogs.com/ldcsaa/category/353464.html">随笔 &amp; 杂谈</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_1_Link_7" href="http://www.cnblogs.com/ldcsaa/category/353458.html">移动开发</a> </li>
			
				</ul>
			
	
		<h3>随笔档案<span style="font-size: 11px; font-weight: normal;">(35)</span></h3>
		
				<ul>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_2_Link_0" href="http://www.cnblogs.com/ldcsaa/archive/2012/04.html">2012年4月 (8)</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_2_Link_1" href="http://www.cnblogs.com/ldcsaa/archive/2012/03.html">2012年3月 (9)</a> </li>
			
				<li><a id="ArchiveLinks1_Categories_CatList_LinkList_2_Link_2" href="http://www.cnblogs.com/ldcsaa/archive/2012/02.html">2012年2月 (18)</a> </li>
			
				</ul>
			
	

		
<h3>阅读排行榜</h3>
<div class="RecentComment">
	<div id="TopViewPostsBlock"></div>
</div>

		
<h3>评论排行榜</h3>
<div class="RecentComment">
	<div id="TopFeedbackPostsBlock"></div>
</div>
		
	
</div>
<div id="rightmenu">
	
		
<h3 class="catListTitle">常用链接</h3>
<ul>

		<li><a id="BlogCustomControl1_rptMainLinks_lnkLinkItem_0" href="http://www.cnblogs.com/ldcsaa/MyPosts.html">我的随笔</a></li>
	
		<li><a id="BlogCustomControl1_rptMainLinks_lnkLinkItem_1" href="http://www.cnblogs.com/ldcsaa/MyComments.html">我的评论</a></li>
	
		<li><a id="BlogCustomControl1_rptMainLinks_lnkLinkItem_2" title="我发表过评论的随笔" href="http://www.cnblogs.com/ldcsaa/OtherPosts.html">我的参与</a></li>
	
		<li><a id="BlogCustomControl1_rptMainLinks_lnkLinkItem_3" href="http://www.cnblogs.com/ldcsaa/RecentComments.html">最新评论</a></li>
	
		<li><a id="BlogCustomControl1_rptMainLinks_lnkLinkItem_4" href="http://www.cnblogs.com/ldcsaa/tag/">我的标签</a></li>
	
</ul>
<div id="itemListLin_con" style="display: none;">

</div>
		
<h3>统计</h3>
	<ul>
		<li>随笔 - 35
		</li><li>文章 - 0
		</li><li>评论 - 229
		</li><li>引用 - 0
	</li>
</ul>
		
		

		
<h3>最新评论
	<a id="RecentComments1_RSSHyperlink1" href="http://www.cnblogs.com/ldcsaa/CommentsRSS.aspx"><img src="xml.gif" alt=""></a></h3>
<div class="RecentComment">
	<div id="RecentCommentsBlock"></div>
</div>
		
	
</div>
<div id="main">
	
				
	<div class="post">
		<h2>
			<a name="baidusnap2"></a><a name="baidusnap3"></a><a id="cb_post_title_url" href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html">通用异步 <b style="color: black; background-color: rgb(153, 255, 153);">Windows</b> <b style="color: black; background-color: rgb(255, 153, 153);">Socket</b> TCP 客户端组件的设计与实现</a>
		</h2>
		<div id="cnblogs_post_body"><p>　　编写 <b style="color: black; background-color: rgb(153, 255, 153);">Windows</b> <b style="color: black; background-color: rgb(255, 153, 153);">Socket</b> TCP 客户端其实并不困难，<b style="color: black; background-color: rgb(153, 255, 153);">Windows</b> 提供了6种&nbsp;I/O 通信模型供大家选择。但本座看过很多客户端程序都把 <b style="color: black; background-color: rgb(255, 153, 153);">Socket</b> 通信和业务逻辑混在一起，剪不断理还乱。每个程序都 Copy / Parse 类似的代码再进行修改，实在有点情何以堪。因此本座利用一些闲暇时光写了<a name="baidusnap0"></a><b style="color: black; background-color: rgb(255, 255, 102);">一个</b><strong><a href="http://www.cnblogs.com/ldcsaa/archive/2012/02/25/2367409.html" target="_top">基于 IOCP 的通用异步 <b style="color: black; background-color: rgb(153, 255, 153);">Windows</b> <b style="color: black; background-color: rgb(255, 153, 153);">Socket</b> TCP&nbsp;高性能服务端组件</a></strong>和<b style="color: black; background-color: rgb(255, 255, 102);">一个</b><strong>通用异步 <b style="color: black; background-color: rgb(153, 255, 153);">Windows</b> <b style="color: black; background-color: rgb(255, 153, 153);">Socket</b> TCP 客户端组件</strong>供各位看官参详参详，希望能激发下大家的灵感。本篇文章讲述客户端组件。闲话少说，我们现在步入正题。</p>
<ul>
<li>最重要的第<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>问题：如何才能达到通用？</li>
</ul>
<p>　　答：很简单。</p>
<p>　　　　1、限制组件的职能，说白了，<span style="color: rgb(0, 0, 255);">通信组件的唯一职责就是接受和发送字节流</span>，绝对不能参与上层协议解析等工作。不在其位不谋其政就是这个意思。</p>
<p>　　　　2、与上层使用者解耦、互不依赖，组件与使用者通过接口方法进行交互，组件实现 ISocketClient 接口为上层提供操作方法；使用者通过&nbsp;IClientSocketListener 接口把自己注册为组件的 Listener，接收组件通知。因此，任何使用者只要实现了 IClientSocketListener 接口都可以使用组件；另一方面，你甚至可以自己重新写<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>实现方式完全不同的组件实现给使用者调用，只要该组件遵从 ISocketClient 接口。这也是 DIP 设计原则的体现（<a href="http://www.cnblogs.com/ldcsaa/archive/2012/02/26/2368959.html" target="_top">若想了解更多关于设计原则的内容请猛击这里 ^_^</a>）。</p>
<p>&nbsp;</p>
<ul>
<li>最重要的第二个问题：可用性如何，也就是说使用起来是否是否方便？</li>
</ul>
<p>　　答：这个问题问得很好，可用性对所有通用组件都是至关重要的，如果太难用还不如自己重头写<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>来得方便。因此，ISocketClient 和 IClientSocketListener 接口设计得尽量简单易用（通俗来说就是“傻瓜化”），这两个接口的主要方法均不超过 5 个。</p>
<p>&nbsp;</p>
<ul>
<li>最重要的第三个问题：组件的性能如何？</li>
</ul>
<p>　　作为底层的通用组件，性能问题是必须考虑的，绝对不能成为系统的瓶颈。而另一方面，从实际出发，毕竟只是<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>客户端组件，它的并发性要求远没有服务端那么高。因此，组件在设计上充分考虑了性能、现实使用情景、可用性和实现复杂性等因素，确保满足性能要求的同时又不会写得太复杂。做出以下两点设计决策：</p>
<ol>
<li style="list-style-type: none;"><ol>
<li>在单独线程中实现 <b style="color: black; background-color: rgb(255, 153, 153);">Socket</b> 通信交互。这样可以避免与主线程或其他线程相互干扰。</li>
<li>I/O&nbsp;模型选择 WSAEventSelect。细说一下选择这种 I/O 模型的原因：（各种 I/O 模型的性能比较可以参考：《<b style="color: black; background-color: rgb(153, 255, 153);">Windows</b> 网络编程（中文第二版）》第 154 页）
<ul>
<li>阻塞模型：（不解析，你懂的^_^）</li>
<li>非阻塞模型：（性能太低）</li>
<li>WSAAsyncSelect：&nbsp;（两个原因：a、性能太低；b、对于纯 Console 程序还要背负 HWND 实在是伤不起呀！）</li>
<li>重叠 I/O：（有点复杂了）</li>
<li>完成端口：（何必呢？）</li>
</ul>
</li>
</ol></li>
</ol>
<p>&nbsp;</p>
<p>　　唉，理论的东西就先别吹那么多了，直接上代码吧，求你了 ！！</p>
<p>　　OK！先看看 <strong>ISocketClient</strong> 和 <strong>IClientSocketListener</strong> 的接口定义:</p>
<div class="cnblogs_code">
<pre><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 组件操作类型</span><span style="color: rgb(0, 128, 0);"><br></span><span style="color: rgb(0, 0, 255);">enum</span> EnSocketOperation<br>{<br>    SO_UNKNOWN    = <span style="color: rgb(128, 0, 128);">0</span>,<br>    SO_ACCEPT    = <span style="color: rgb(128, 0, 128);">1</span>,<br>    SO_<a name="baidusnap5"></a><b style="color: white; background-color: rgb(136, 0, 0);">CONNECT</b>    = <span style="color: rgb(128, 0, 128);">2</span>,<br>    SO_SEND        = <span style="color: rgb(128, 0, 128);">3</span>,<br>    SO_RECEIVE    = <span style="color: rgb(128, 0, 128);">4</span>,<br>};<br><br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 组件监听器基接口</span><span style="color: rgb(0, 128, 0);"><br></span><strong><span style="color: rgb(0, 0, 255);">class</span> ISocketListener</strong><br>{<br><span style="color: rgb(0, 0, 255);">public</span>:<br>    <span style="color: rgb(0, 0, 255);">enum</span> EnHandleResult<br>    {<br>        HR_OK        = <span style="color: rgb(128, 0, 128);">0</span>,<br>        HR_IGNORE    = <span style="color: rgb(128, 0, 128);">1</span>,<br>        HR_ERROR    = <span style="color: rgb(128, 0, 128);">2</span>,<br>    };<br><br><span style="color: rgb(0, 0, 255);">public</span>:<br><strong>　　<span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 已发出数据通知</span><span style="color: rgb(0, 128, 0);"><br></span>　　<span style="color: rgb(0, 0, 255);">virtual</span> EnHandleResult OnSend(DWORD dwConnectionID, <span style="color: rgb(0, 0, 255);">const</span> BYTE* pData, <span style="color: rgb(0, 0, 255);">int</span> iLength) = <span style="color: rgb(128, 0, 128);">0</span>;</strong><br><strong><span style="color: rgb(0, 128, 0);">　　//</span><span style="color: rgb(0, 128, 0);"> 已接收数据通知</span><span style="color: rgb(0, 128, 0);"><br></span>　　<span style="color: rgb(0, 0, 255);">virtual</span> EnHandleResult OnReceive(DWORD dwConnectionID, <span style="color: rgb(0, 0, 255);">const</span> BYTE* pData, <span style="color: rgb(0, 0, 255);">int</span> iLength) = <span style="color: rgb(128, 0, 128);">0</span>;</strong><br><strong><span style="color: rgb(0, 128, 0);">　　//</span><span style="color: rgb(0, 128, 0);"> 关闭连接通知</span><span style="color: rgb(0, 128, 0);"><br></span><span style="color: rgb(0, 0, 255);">　　virtual</span> EnHandleResult OnClose(DWORD dwConnectionID) = <span style="color: rgb(128, 0, 128);">0</span>;</strong><br><strong><span style="color: rgb(0, 128, 0);">　　//</span><span style="color: rgb(0, 128, 0);"> 通信错误通知</span><span style="color: rgb(0, 128, 0);"><br></span>　　<span style="color: rgb(0, 0, 255);">virtual</span> EnHandleResult OnError(DWORD dwConnectionID, EnSocketOperation enOperation, <span style="color: rgb(0, 0, 255);">int</span> iErrorCode) = <span style="color: rgb(128, 0, 128);">0</span>;</strong><br><br><span style="color: rgb(0, 0, 255);">public</span>:<br>    <span style="color: rgb(0, 0, 255);">virtual</span> ~ISocketListener() {}<br>};<br><br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 服务端组件监听器接口（暂时无视之）</span><span style="color: rgb(0, 128, 0);"><br></span><span style="color: rgb(0, 0, 255);">class</span> IServerSocketListener : <span style="color: rgb(0, 0, 255);">public</span> ISocketListener<br>{<br><span style="color: rgb(0, 0, 255);">public</span>:<br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 接收连接通知</span><span style="color: rgb(0, 128, 0);"><br></span>    <span style="color: rgb(0, 0, 255);">virtual</span> EnHandleResult OnAccept(DWORD dwConnectionID)    = <span style="color: rgb(128, 0, 128);">0</span>;<br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 服务关闭通知</span><span style="color: rgb(0, 128, 0);"><br></span>    <span style="color: rgb(0, 0, 255);">virtual</span> EnHandleResult OnServerShutdown()                = <span style="color: rgb(128, 0, 128);">0</span>;<br>};<br><br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 客户端组件监听器接口</span><span style="color: rgb(0, 128, 0);"><br></span><strong><span style="color: rgb(0, 0, 255);">class</span></strong> <strong>IClientSocketListener : <span style="color: rgb(0, 0, 255);">public</span> ISocketListener</strong><br>{<br><span style="color: rgb(0, 0, 255);">public</span>:<br>　　<strong><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 连接完成通知</span><span style="color: rgb(0, 128, 0);"><br></span>　　<span style="color: rgb(0, 0, 255);">virtual</span></strong> <strong>EnHandleResult OnConnect(DWORD dwConnectionID) = <span style="color: rgb(128, 0, 128);">0</span>;</strong><br>};<br><br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 服务端组件接口（暂时无视之）</span><span style="color: rgb(0, 128, 0);"><br></span><span style="color: rgb(0, 0, 255);">class</span> ISocketServer<br>{<br><span style="color: rgb(0, 0, 255);">public</span>:<br>    <span style="color: rgb(0, 0, 255);">enum</span> En_ISS_Error<br>    {<br>        ISS_OK                        = <span style="color: rgb(128, 0, 128);">0</span>,<br>        ISS_<b style="color: black; background-color: rgb(255, 153, 153);">SOCKET</b>_CREATE            = <span style="color: rgb(128, 0, 128);">1</span>,<br>        ISS_<b style="color: black; background-color: rgb(255, 153, 153);">SOCKET</b>_BIND                = <span style="color: rgb(128, 0, 128);">2</span>,<br>        ISS_<b style="color: black; background-color: rgb(255, 153, 153);">SOCKET</b>_LISTEN            = <span style="color: rgb(128, 0, 128);">3</span>,<br>        ISS_CP_CREATE                = <span style="color: rgb(128, 0, 128);">4</span>,<br>        ISS_WORKER_THREAD_CREATE    = <span style="color: rgb(128, 0, 128);">5</span>,<br>        ISS_SOCKE_ATTACH_TO_CP        = <span style="color: rgb(128, 0, 128);">6</span>,<br>        ISS_ACCEPT_THREAD_CREATE    = <span style="color: rgb(128, 0, 128);">7</span>,<br>    };<br><br><span style="color: rgb(0, 0, 255);">public</span>:<br>    <span style="color: rgb(0, 0, 255);">virtual</span> BOOL Start    (LPCTSTR pszBindAddress, USHORT usPort, <span style="color: rgb(0, 0, 255);">long</span> lThreadCount)            = <span style="color: rgb(128, 0, 128);">0</span>;<br>    <span style="color: rgb(0, 0, 255);">virtual</span> BOOL Stop    ()                                                                    = <span style="color: rgb(128, 0, 128);">0</span>;<br>    <span style="color: rgb(0, 0, 255);">virtual</span> BOOL Send    (DWORD dwConnID, <span style="color: rgb(0, 0, 255);">const</span> BYTE* pBuffer, <span style="color: rgb(0, 0, 255);">int</span> iLen)                        = <span style="color: rgb(128, 0, 128);">0</span>;<br>    <span style="color: rgb(0, 0, 255);">virtual</span> BOOL HasStarted                ()                                                    = <span style="color: rgb(128, 0, 128);">0</span>;<br>    <span style="color: rgb(0, 0, 255);">virtual</span> En_ISS_Error GetLastError    ()                                                    = <span style="color: rgb(128, 0, 128);">0</span>;<br>    <span style="color: rgb(0, 0, 255);">virtual</span> LPCTSTR        GetLastErrorDesc()                                                    = <span style="color: rgb(128, 0, 128);">0</span>;<br>    <span style="color: rgb(0, 0, 255);">virtual</span> BOOL GetConnectionAddress(DWORD dwConnID, CString&amp; strAddress, USHORT&amp; usPort)    = <span style="color: rgb(128, 0, 128);">0</span>;<br><br><br><span style="color: rgb(0, 0, 255);">public</span>:<br>    <span style="color: rgb(0, 0, 255);">virtual</span> ~ISocketServer() {}<br>};<br><br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 服务端组件接口智能指针</span><span style="color: rgb(0, 128, 0);"><br></span>typedef auto_ptr&lt;ISocketServer&gt;    ISocketServerPtr;<br><br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 客户端组件接口</span><span style="color: rgb(0, 128, 0);"><br></span><strong><span style="color: rgb(0, 0, 255);">class</span> ISocketClient</strong><br>{<br><span style="color: rgb(0, 0, 255);">public</span>:<br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 操作结果码</span><span style="color: rgb(0, 128, 0);"><br></span>    <span style="color: rgb(0, 0, 255);">enum</span> En_ISC_Error<br>    {<br>        ISC_OK                        = <span style="color: rgb(128, 0, 128);">0</span>,<br>        ISC_CLIENT_HAD_STARTED        = <span style="color: rgb(128, 0, 128);">1</span>,<br>        ISC_CLIENT_NOT_STARTED        = <span style="color: rgb(128, 0, 128);">2</span>,<br>        ISC_<b style="color: black; background-color: rgb(255, 153, 153);">SOCKET</b>_CREATE_FAIL        = <span style="color: rgb(128, 0, 128);">3</span>,<br>        ISC_<b style="color: white; background-color: rgb(136, 0, 0);">CONNECT</b>_SERVER_FAIL        = <span style="color: rgb(128, 0, 128);">4</span>,<br>        ISC_WORKER_CREATE_FAIL        = <span style="color: rgb(128, 0, 128);">5</span>,<br>        ISC_NETWORK_ERROR            = <span style="color: rgb(128, 0, 128);">6</span>,<br>        ISC_PROTOCOL_ERROR            = <span style="color: rgb(128, 0, 128);">7</span>,<br>    };<br><br><span style="color: rgb(0, 0, 255);">public</span>:<br><strong><span style="color: rgb(0, 128, 0);">　　//</span><span style="color: rgb(0, 128, 0);"> 启动通信</span><span style="color: rgb(0, 128, 0);"><br></span>　　<span style="color: rgb(0, 0, 255);">virtual</span> BOOL Start (LPCTSTR pszRemoteAddress, USHORT usPort) = <span style="color: rgb(128, 0, 128);">0</span>;</strong><br><strong><span style="color: rgb(0, 128, 0);">　　//</span><span style="color: rgb(0, 128, 0);"> 关闭通信</span><span style="color: rgb(0, 128, 0);"><br></span>　　<span style="color: rgb(0, 0, 255);">virtual</span> BOOL Stop () = <span style="color: rgb(128, 0, 128);">0</span>;</strong><br><strong>　　<span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 发送数据</span><span style="color: rgb(0, 128, 0);"><br></span><span style="color: rgb(0, 0, 255);">　　virtual</span> BOOL Send (DWORD dwConnID, <span style="color: rgb(0, 0, 255);">const</span> BYTE* pBuffer, <span style="color: rgb(0, 0, 255);">int</span> iLen) = <span style="color: rgb(128, 0, 128);">0</span>;</strong><br><strong>　　<span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 是否已启动</span><span style="color: rgb(0, 128, 0);"><br></span><span style="color: rgb(0, 0, 255);">　　virtual</span> BOOL HasStarted () = <span style="color: rgb(128, 0, 128);">0</span>;</strong><br><strong>　　<span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 获取错误码</span><span style="color: rgb(0, 128, 0);"><br></span>　　<span style="color: rgb(0, 0, 255);">virtual</span> En_ISC_Error GetLastError () = <span style="color: rgb(128, 0, 128);">0</span>;</strong><br><strong>　　<span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 获取错误描述</span><span style="color: rgb(0, 128, 0);"><br></span>　　<span style="color: rgb(0, 0, 255);">virtual</span> LPCTSTR GetLastErrorDesc() = <span style="color: rgb(128, 0, 128);">0</span>;</strong><br><br><span style="color: rgb(0, 0, 255);">public</span>:<br>    <span style="color: rgb(0, 0, 255);">virtual</span> ~ISocketClient() {}<br>};<br><br><strong><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 客户端组件接口智能指针</span><span style="color: rgb(0, 128, 0);"><br></span>typedef auto_ptr&lt;ISocketClient&gt; </strong>   <strong>ISocketClientPtr</strong>;</pre>
</div>
<p>　　</p>
<p>　　<strong>ISocketClient</strong> 接口主要有以下三个方法：</p>
<ul>
<li>Start()：启动通信</li>
<li>Send()：发送数据</li>
<li>Stop()：停止通信</li>
</ul>
<p>　　<strong>IClientSocketListener</strong> 接口有以下五个通知方法：</p>
<ul>
<li>OnConnect()</li>
<li>OnSend()</li>
<li>OnReceive()</li>
<li>OnClose()</li>
<li>OnError()&nbsp;</li>
</ul>
<p>&nbsp;　　够简单了吧^_^，使用者只需通过三个方法操作组件，然后处理五个组件通知。下面我们再看看组件的具体实现，先看组件类定义：</p>
<div class="cnblogs_code">
<pre><span style="color: rgb(0, 128, 0);">/*</span><span style="color: rgb(0, 128, 0);"> 组件实现类 </span><span style="color: rgb(0, 128, 0);">*/</span><br><strong><span style="color: rgb(0, 0, 255);">class</span> CSocketClient : <span style="color: rgb(0, 0, 255);">public</span> ISocketClient</strong><br>{<br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> ISocketClient 接口方法</span><span style="color: rgb(0, 128, 0);"><br></span><span style="color: rgb(0, 0, 255);">public</span>:<br><strong><span style="color: rgb(0, 0, 255);">　　virtual</span> BOOL Start (LPCTSTR pszRemoteAddress, USHORT usPortt);</strong><br><strong>　　<span style="color: rgb(0, 0, 255);">virtual</span> BOOL Stop ();</strong><br><strong><span style="color: rgb(0, 0, 255);">　　virtual</span> BOOL Send (DWORD dwConnID, <span style="color: rgb(0, 0, 255);">const</span> BYTE* pBuffer, <span style="color: rgb(0, 0, 255);">int</span> iLen);</strong><br><strong>　　<span style="color: rgb(0, 0, 255);">virtual</span> BOOL HasStarted () {<span style="color: rgb(0, 0, 255);">return</span> m_bStarted;}</strong><br><strong>　　<span style="color: rgb(0, 0, 255);">virtual</span> En_ISC_Error GetLastError () {<span style="color: rgb(0, 0, 255);">return</span> sm_enLastError;}</strong><br><strong>　　<span style="color: rgb(0, 0, 255);">virtual</span> LPCTSTR GetLastErrorDesc();</strong><br><br><span style="color: rgb(0, 0, 255);">private</span>:<br>    BOOL CreateClientSocket();<br>    BOOL ConnectToServer(LPCTSTR pszRemoteAddress, USHORT usPort);<br>    BOOL CreateWorkerThread();<br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 网络事件处理方法</span><span style="color: rgb(0, 128, 0);"><br></span>    BOOL ProcessNetworkEvent();<br>    <span style="color: rgb(0, 0, 255);">void</span> WaitForWorkerThreadEnd();<br>    BOOL ReadData();<br>    BOOL SendData();<br><br>    <span style="color: rgb(0, 0, 255);">void</span> SetLastError(En_ISC_Error code, LPCTSTR func, <span style="color: rgb(0, 0, 255);">int</span> ec);<br><br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 通信线程函数</span><span style="color: rgb(0, 128, 0);"><br></span><span style="color: rgb(0, 0, 255);">static</span> <br>#ifndef _WIN32_WCE<br>    UINT<br><span style="color: rgb(0, 0, 255);">#else</span><br>    DWORD<br><span style="color: rgb(0, 0, 255);">#endif</span><br>     WINAPI WorkerThreadProc(LPVOID pv);<br><br><span style="color: rgb(0, 0, 255);">private</span>:<br>    <span style="color: rgb(0, 0, 255);">static</span> <span style="color: rgb(0, 0, 255);">const</span> <span style="color: rgb(0, 0, 255);">int</span> RECEIVE_BUFFER_SIZE    = <span style="color: rgb(128, 0, 128);">8</span> * <span style="color: rgb(128, 0, 128);">1024</span>;<br>    <span style="color: rgb(0, 0, 255);">static</span> <span style="color: rgb(0, 0, 255);">const</span> <span style="color: rgb(0, 0, 255);">int</span> WORKER_THREAD_END_TIME    = <span style="color: rgb(128, 0, 128);">3</span> * <span style="color: rgb(128, 0, 128);">1000</span>;<br><br>    <span style="color: rgb(0, 0, 255);">static</span> <span style="color: rgb(0, 0, 255);">const</span> <span style="color: rgb(0, 0, 255);">long</span>    DEFALUT_KEEPALIVE_TIMES        = <span style="color: rgb(128, 0, 128);">3</span>;<br>    <span style="color: rgb(0, 0, 255);">static</span> <span style="color: rgb(0, 0, 255);">const</span> <span style="color: rgb(0, 0, 255);">long</span>    DEFALUT_KEEPALIVE_INTERVAL    = <span style="color: rgb(128, 0, 128);">10</span> * <span style="color: rgb(128, 0, 128);">1000</span>;<br><br><br><strong><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 构造函数</span><span style="color: rgb(0, 128, 0);"><br></span><span style="color: rgb(0, 0, 255);">public</span>:</strong><br><strong>　　CSocketClient(IClientSocketListener* pListener)</strong><br><strong>　　: m_pListener(pListener) <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 设置监听器对象</span><span style="color: rgb(0, 128, 0);"><br></span>　　, m_soClient(INVALID_<b style="color: black; background-color: rgb(255, 153, 153);">SOCKET</b>)</strong><br><strong>　　, m_evSocket(NULL)</strong><br><strong>　　, m_dwConnID(<span style="color: rgb(128, 0, 128);">0</span>)</strong><br><strong>　　, m_hWorker(NULL)</strong><br><strong>　　, m_dwWorkerID(<span style="color: rgb(128, 0, 128);">0</span>)</strong><br><strong>　　, m_bStarted(FALSE)</strong><br><strong>#ifdef _WIN32_WCE</strong><br><strong>　　, sm_enLastError(ISC_OK)</strong><br><strong><span style="color: rgb(0, 0, 255);">#endif</span></strong><br><strong>　　{</strong><br><strong>　　　　ASSERT(m_pListener);</strong><br><strong>　　}</strong><br><br>    <span style="color: rgb(0, 0, 255);">virtual</span> ~CSocketClient()    {<span style="color: rgb(0, 0, 255);">if</span>(HasStarted()) Stop();}<br><br><span style="color: rgb(0, 0, 255);">private</span>:<br>　　<strong><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 这是神马 ？？？</span><span style="color: rgb(0, 128, 0);"><br></span>　　CInitSocket m_wsSocket;</strong><br>    <br>    <b style="color: black; background-color: rgb(255, 153, 153);">SOCKET</b>            m_soClient;<br>    HANDLE            m_evSocket;<br>    DWORD            m_dwConnID;<br><br>    CCriSec            m_scStop;<br>    CEvt            m_evStop;<br>    HANDLE            m_hWorker;<br><br>#ifndef _WIN32_WCE<br>    UINT<br><span style="color: rgb(0, 0, 255);">#else</span><br>    DWORD<br><span style="color: rgb(0, 0, 255);">#endif</span><br>                    m_dwWorkerID;<br><br>    CBufferPtr        m_sndBuffer;<br>    CCriSec            m_scBuffer;<br>    CEvt            m_evBuffer;<br><br>    <span style="color: rgb(0, 0, 255);">volatile</span> BOOL    m_bStarted;<br><br><span style="color: rgb(0, 0, 255);">private</span>:<br>　　<span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 监听器对象指针</span><span style="color: rgb(0, 128, 0);"><br></span><strong>　　IClientSocketListener* m_pListener;</strong><br><br>#ifndef _WIN32_WCE<br>    __declspec(thread) <span style="color: rgb(0, 0, 255);">static</span> En_ISC_Error    sm_enLastError;<br><span style="color: rgb(0, 0, 255);">#else</span><br>    <span style="color: rgb(0, 0, 255);">volatile</span> En_ISC_Error                    sm_enLastError;<br><span style="color: rgb(0, 0, 255);">#endif</span><br>};</pre>
</div>
<p>&nbsp;</p>
<p>　　从上面的定义可以看出，组件实现类本身并没有提供额外的公共方法，它完全是可以被替换的。组件在构造函数中接收监听器对象，并且保存为其成员属性，因此可以在需要的时候向监听器发送事件通知。</p>
<p>　　另外，不知各位看官是否注意到<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>奇怪的成员属性：“<strong>CInitSocket m_wsSocket;</strong> ”，这个属性在其它地方从来都不会用到，那么它是干嘛的呢？在回答这个问题之前，首先想问问大家：<b style="color: black; background-color: rgb(153, 255, 153);">Windows</b> <b style="color: black; background-color: rgb(255, 153, 153);">Socket</b> 操作的整个操作过程中，第<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>以及最后<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>被调用的方法是什么？是 <b style="color: black; background-color: rgb(255, 153, 153);">socket</b>()、<b style="color: white; background-color: rgb(136, 0, 0);">connect</b>()、bind()、还是&nbsp;closesocket() 吗？都错！答案是 —— ::WSAStartup() 和 ::WSACleanup()。每个程序都要调用一下这两个方法确实是很烦的，又不雅观。&nbsp;其实，m_wsSocket 的唯一目的就是为了避免手工调用者两个方法，看看它的定义就明白了：</p>
<div class="cnblogs_code">
<pre><span style="color: rgb(0, 0, 255);">class</span> CInitSocket<br>{<br><span style="color: rgb(0, 0, 255);">public</span>:<br>    CInitSocket(LPWSADATA lpWSAData = NULL, BYTE minorVersion = <span style="color: rgb(128, 0, 128);">2</span>, BYTE majorVersion = <span style="color: rgb(128, 0, 128);">2</span>)<br>    {<br>        LPWSADATA lpTemp = lpWSAData;<br>        <span style="color: rgb(0, 0, 255);">if</span>(!lpTemp)<br>            lpTemp    = (LPWSADATA)_alloca(<span style="color: rgb(0, 0, 255);">sizeof</span>(WSADATA));<br><br>        m_iResult    = <strong>::WSAStartup(MAKEWORD(minorVersion, majorVersion), lpTemp)</strong>;<br>    }<br><br>    ~CInitSocket()<br>    {<br>        <span style="color: rgb(0, 0, 255);">if</span>(IsValid())<br>　　　　　　<strong>::WSACleanup()</strong>;<br>    }<br><br>    <span style="color: rgb(0, 0, 255);">int</span>        GetResult()    {<span style="color: rgb(0, 0, 255);">return</span> m_iResult;}<br>    BOOL    IsValid()    {<span style="color: rgb(0, 0, 255);">return</span> m_iResult == <span style="color: rgb(128, 0, 128);">0</span>;}<br><br><span style="color: rgb(0, 0, 255);">private</span>:<br>    <span style="color: rgb(0, 0, 255);">int</span>        m_iResult;<br>};</pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;　　现在我们看看组件类实现文件中几个重要方法的定义：</p>
<div class="cnblogs_code">
<pre><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 组件事件触发宏定义</span><span style="color: rgb(0, 128, 0);"><br></span><span style="color: rgb(0, 0, 255);">#define</span> <strong>FireConnect</strong>(id)                    m_pListener-&gt;OnConnect(id)<br><span style="color: rgb(0, 0, 255);">#define</span> <strong>FireSend</strong>(id, data, len)            (m_bStarted ? m_pListener-&gt;OnSend(id, data, len)    : ISocketListener::HR_IGNORE)<br><span style="color: rgb(0, 0, 255);">#define</span> <strong>FireReceive</strong>(id, data, len)        (m_bStarted ? m_pListener-&gt;OnReceive(id, data, len)    : ISocketListener::HR_IGNORE)<br><span style="color: rgb(0, 0, 255);">#define</span> <strong>FireClose</strong>(id)                    (m_bStarted ? m_pListener-&gt;OnClose(id)                : ISocketListener::HR_IGNORE)<br><span style="color: rgb(0, 0, 255);">#define</span> <strong>FireError</strong>(id, op, code)            (m_bStarted ? m_pListener-&gt;OnError(id, op, code)    : ISocketListener::HR_IGNORE)<br><br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 启动组件</span><span style="color: rgb(0, 128, 0);"><br></span>BOOL CSocketClient::Start(LPCTSTR pszRemoteAddress, USHORT usPort)<br>{<br>    BOOL isOK = FALSE;<br><br>    <span style="color: rgb(0, 0, 255);">if</span>(HasStarted())<br>    {<br>        SetLastError(ISC_CLIENT_HAD_STARTED, _T(__FUNCTION__), <span style="color: rgb(128, 0, 128);">0</span>);<br>        <span style="color: rgb(0, 0, 255);">return</span> isOK;<br>    }<br><br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 创建 <b style="color: black; background-color: rgb(255, 153, 153);">socket</b></span><span style="color: rgb(0, 128, 0);"><br></span>    <span style="color: rgb(0, 0, 255);">if</span>(CreateClientSocket())<br>    {<br>        <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 连接服务器（内部会调用 <strong>FireConnect()</strong> ）</span><span style="color: rgb(0, 128, 0);"><br></span>        <span style="color: rgb(0, 0, 255);">if</span>(ConnectToServer(pszRemoteAddress, usPort))<br>        {<br>            <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 创建工作线程</span><span style="color: rgb(0, 128, 0);"><br></span>            <span style="color: rgb(0, 0, 255);">if</span>(CreateWorkerThread())<br>                isOK = TRUE;<br>            <span style="color: rgb(0, 0, 255);">else</span><br>                SetLastError(ISC_WORKER_CREATE_FAIL, _T(__FUNCTION__), <span style="color: rgb(128, 0, 128);">0</span>);<br>        }<br>        <span style="color: rgb(0, 0, 255);">else</span><br>            SetLastError(ISC_<b style="color: white; background-color: rgb(136, 0, 0);">CONNECT</b>_SERVER_FAIL, _T(__FUNCTION__), ::WSAGetLastError());<br>    }<br>    <span style="color: rgb(0, 0, 255);">else</span><br>        SetLastError(ISC_<b style="color: black; background-color: rgb(255, 153, 153);">SOCKET</b>_CREATE_FAIL, _T(__FUNCTION__), ::WSAGetLastError());<br><br>    isOK ? m_bStarted = TRUE : Stop();<br><br>    <span style="color: rgb(0, 0, 255);">return</span> isOK;<br>}<br><br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 关闭组件</span><span style="color: rgb(0, 128, 0);"><br></span>BOOL CSocketClient::Stop()<br>{<br>    {<br>        CCriSecLock locallock(m_scStop);<br><br>        m_bStarted = FALSE;<br><br>        <span style="color: rgb(0, 0, 255);">if</span>(m_hWorker != NULL)<br>        {<br>            <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 停止工作线程</span><span style="color: rgb(0, 128, 0);"><br></span>            <span style="color: rgb(0, 0, 255);">if</span>(::GetCurrentThreadId() != m_dwWorkerID)<br>                WaitForWorkerThreadEnd();<br><br>            ::CloseHandle(m_hWorker);<br>            m_hWorker        = NULL;<br>            m_dwWorkerID    = <span style="color: rgb(128, 0, 128);">0</span>;<br>        }<br><br>        <span style="color: rgb(0, 0, 255);">if</span>(m_evSocket != NULL)<br>        {<br>            <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 关闭 WSAEvent</span><span style="color: rgb(0, 128, 0);"><br></span>            ::WSACloseEvent(m_evSocket);<br>            m_evSocket    = NULL;<br>        }<br><br>        <span style="color: rgb(0, 0, 255);">if</span>(m_soClient != INVALID_<b style="color: black; background-color: rgb(255, 153, 153);">SOCKET</b>)<br>        {<br>            <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 关闭<b style="color: black; background-color: rgb(255, 153, 153);">socket</b></span><span style="color: rgb(0, 128, 0);"><br></span>            shutdown(m_soClient, SD_SEND);<br>            closesocket(m_soClient);<br>            m_soClient    = INVALID_<b style="color: black; background-color: rgb(255, 153, 153);">SOCKET</b>;<br>        }<br><br>        m_dwConnID = <span style="color: rgb(128, 0, 128);">0</span>;<br>    }<br><br> <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 释放其它资源</span><span style="color: rgb(0, 128, 0);"><br></span>    m_sndBuffer.Free();<br>    m_evBuffer.Reset();<br>    m_evStop.Reset();<br><br>    <span style="color: rgb(0, 0, 255);">return</span> TRUE;<br>}<br><br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 发送数据</span><span style="color: rgb(0, 128, 0);"><br></span>BOOL CSocketClient::Send(DWORD dwConnID, <span style="color: rgb(0, 0, 255);">const</span> BYTE* pBuffer, <span style="color: rgb(0, 0, 255);">int</span> iLen)<br>{<br>    ASSERT(iLen &gt; <span style="color: rgb(128, 0, 128);">0</span>);<br><br>    <span style="color: rgb(0, 0, 255);">if</span>(!HasStarted())<br>    {<br>        SetLastError(ISC_CLIENT_NOT_STARTED, _T(__FUNCTION__), <span style="color: rgb(128, 0, 128);">0</span>);<br>        <span style="color: rgb(0, 0, 255);">return</span> FALSE;<br>    }<br><br>    CCriSecLock locallock(m_scBuffer);<br>    <br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 把数据存入缓冲器</span><span style="color: rgb(0, 128, 0);"><br></span>    m_sndBuffer.Cat(pBuffer, iLen);<br>　　<span style="color: rgb(0, 128, 0);">// 唤醒工作现场，发送数据</span><br>    m_evBuffer.Set();<br><br>    <span style="color: rgb(0, 0, 255);">return</span> TRUE;<br>}<br><br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 工作线程函数</span><span style="color: rgb(0, 128, 0);"><br></span>#ifndef _WIN32_WCE<br>    UINT<br><span style="color: rgb(0, 0, 255);">#else</span><br>    DWORD<br><span style="color: rgb(0, 0, 255);">#endif</span><br>    WINAPI CSocketClient::WorkerThreadProc(LPVOID pv)<br>{<br>    CSocketClient* pClient = (CSocketClient*)pv;<br><br>    TRACE0(<span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(128, 0, 0);">---------------&gt; 启动工作线程 &lt;---------------\n</span><span style="color: rgb(128, 0, 0);">"</span>);<br><br>    HANDLE hEvents[] = {pClient-&gt;m_evSocket, pClient-&gt;m_evBuffer, pClient-&gt;m_evStop};<br><br>    <span style="color: rgb(0, 0, 255);">while</span>(pClient-&gt;HasStarted())<br>    {<br>        <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 等待 <b style="color: black; background-color: rgb(255, 153, 153);">socket</b> 事件、发送数据事件和停止通信事件</span><span style="color: rgb(0, 128, 0);"><br></span>        DWORD retval = ::MsgWaitForMultipleObjectsEx(<span style="color: rgb(128, 0, 128);">3</span>, hEvents, WSA_INFINITE, QS_ALLINPUT, MWMO_INPUTAVAILABLE);<br><br>        <span style="color: rgb(0, 0, 255);">if</span>(retval == WSA_WAIT_EVENT_0)<br>        {<br>            <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 处理网络消息</span><span style="color: rgb(0, 128, 0);"><br></span>            <span style="color: rgb(0, 0, 255);">if</span>(!pClient-&gt;ProcessNetworkEvent())<br>            {<br>                <span style="color: rgb(0, 0, 255);">if</span>(pClient-&gt;HasStarted())<br>                    pClient-&gt;Stop();<br><br>                <span style="color: rgb(0, 0, 255);">break</span>;<br>            }<br>        }<br>        <span style="color: rgb(0, 0, 255);">else</span> <span style="color: rgb(0, 0, 255);">if</span>(retval == WSA_WAIT_EVENT_0 + <span style="color: rgb(128, 0, 128);">1</span>)<br>        {<br>            <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 发送数据（内部调用 <strong>FireSend()</strong> ）</span><span style="color: rgb(0, 128, 0);"><br></span>            <span style="color: rgb(0, 0, 255);">if</span>(!pClient-&gt;SendData())<br>            {<br>                <span style="color: rgb(0, 0, 255);">if</span>(pClient-&gt;HasStarted())<br>                    pClient-&gt;Stop();<br><br>                <span style="color: rgb(0, 0, 255);">break</span>;<br>            }<br>        }<br>        <span style="color: rgb(0, 0, 255);">else</span> <span style="color: rgb(0, 0, 255);">if</span>(retval == WSA_WAIT_EVENT_0 + <span style="color: rgb(128, 0, 128);">2</span>)<br>            <span style="color: rgb(0, 0, 255);">break</span>;<br>        <span style="color: rgb(0, 0, 255);">else</span> <span style="color: rgb(0, 0, 255);">if</span>(retval == WSA_WAIT_EVENT_0 + <span style="color: rgb(128, 0, 128);">3</span>)<br>            <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 消息循环</span><span style="color: rgb(0, 128, 0);"><br></span>            ::PeekMessageLoop();<br>        <span style="color: rgb(0, 0, 255);">else</span><br>            ASSERT(FALSE);<br>    }<br><br>    TRACE0(<span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(128, 0, 0);">---------------&gt; 退出工作线程 &lt;---------------\n</span><span style="color: rgb(128, 0, 0);">"</span>);<br><br>    <span style="color: rgb(0, 0, 255);">return</span> <span style="color: rgb(128, 0, 128);">0</span>;<br>}<br><br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 处理网络消息</span><span style="color: rgb(0, 128, 0);"><br></span>BOOL CSocketClient::ProcessNetworkEvent()<br>{<br>    ::WSAResetEvent(m_evSocket);<br><br>    WSANETWORKEVENTS events;<br>    <br>    <span style="color: rgb(0, 0, 255);">int</span> rc = ::WSAEnumNetworkEvents(m_soClient, m_evSocket, &amp;events);<br>    <br>    <span style="color: rgb(0, 0, 255);">if</span>(rc == <b style="color: black; background-color: rgb(255, 153, 153);">SOCKET</b>_ERROR)<br>    {<br>        <span style="color: rgb(0, 0, 255);">int</span> code = ::WSAGetLastError();<br>        SetLastError(ISC_NETWORK_ERROR, _T(__FUNCTION__), code);<br>　　　　　<strong>FireError</strong>(m_dwConnID, SO_UNKNOWN, code);<br><br>        <span style="color: rgb(0, 0, 255);">return</span> FALSE;<br>    }<br><br>    <span style="color: rgb(0, 128, 0);">/*</span><span style="color: rgb(0, 128, 0);"> 可读取 </span><span style="color: rgb(0, 128, 0);">*/</span><br>    <span style="color: rgb(0, 0, 255);">if</span>(events.lNetworkEvents &amp; FD_READ)<br>    {<br>        <span style="color: rgb(0, 0, 255);">int</span> iCode = events.iErrorCode[FD_READ_BIT];<br><br>        <span style="color: rgb(0, 0, 255);">if</span>(iCode == <span style="color: rgb(128, 0, 128);">0</span>)<br>            <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 读取数据（内部调用 <strong>FireReceive()</strong> ）</span><span style="color: rgb(0, 128, 0);"><br></span>            <span style="color: rgb(0, 0, 255);">return</span> ReadData();<br>        <span style="color: rgb(0, 0, 255);">else</span><br>　　　　 {<br>　　　　　　SetLastError(ISC_NETWORK_ERROR, _T(__FUNCTION__), iCode);<br><strong>　　　　　　FireError</strong>(m_dwConnID, SO_RECEIVE, iCode);<br>　　　　　　<span style="color: rgb(0, 0, 255);">return</span> FALSE;<br>        }<br>    }<br><br>    <span style="color: rgb(0, 128, 0);">/*</span><span style="color: rgb(0, 128, 0);"> 可发送 </span><span style="color: rgb(0, 128, 0);">*/</span><br>    <span style="color: rgb(0, 0, 255);">if</span>(events.lNetworkEvents &amp; FD_WRITE)<br>    {<br>        <span style="color: rgb(0, 0, 255);">int</span> iCode = events.iErrorCode[FD_WRITE_BIT];<br><br>        <span style="color: rgb(0, 0, 255);">if</span>(iCode == <span style="color: rgb(128, 0, 128);">0</span>)<br>            <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 发送数据（内部调用 <strong>FireSend()</strong> ）</span><span style="color: rgb(0, 128, 0);"><br></span>            <span style="color: rgb(0, 0, 255);">return</span> SendData();<br>        <span style="color: rgb(0, 0, 255);">else</span><br>        {<br>            SetLastError(ISC_NETWORK_ERROR, _T(__FUNCTION__), iCode);<br><strong>　　　　　　　　FireError</strong>(m_dwConnID, SO_SEND, iCode);<br>            <span style="color: rgb(0, 0, 255);">return</span> FALSE;<br>        }<br>    }<br><br>    <span style="color: rgb(0, 128, 0);">/*</span><span style="color: rgb(0, 128, 0);"> <b style="color: black; background-color: rgb(255, 153, 153);">socket</b> 已关闭 </span><span style="color: rgb(0, 128, 0);">*/</span><br>    <span style="color: rgb(0, 0, 255);">if</span>(events.lNetworkEvents &amp; FD_CLOSE)<br>    {<br>        <span style="color: rgb(0, 0, 255);">int</span> iCode = events.iErrorCode[FD_CLOSE_BIT];<br><br>        <span style="color: rgb(0, 0, 255);">if</span>(iCode == <span style="color: rgb(128, 0, 128);">0</span>)<br><strong>　　　　　　FireClose</strong>(m_dwConnID);<br>        <span style="color: rgb(0, 0, 255);">else</span><br>        {<br>            SetLastError(ISC_NETWORK_ERROR, _T(__FUNCTION__), iCode);<br>　　　　　　　　<strong>FireError</strong>(m_dwConnID, SO_UNKNOWN, iCode);<br>        }<br><br>        <span style="color: rgb(0, 0, 255);">return</span> FALSE;<br>    }<br><br>    <span style="color: rgb(0, 0, 255);">return</span> TRUE;<br>}</pre>
</div>
<p>　　</p>
<p>　　从上面的代码可以看出：通信过程中，组件的使用者不需要对通信过程进行任何干预，整个底层通信过程对使用者来说是透明的，使用只需集中精力处理好几个组件通知。下面来看看组件的<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>使用示例：</p>
<div class="cnblogs_code">
<pre><strong><span style="color: rgb(0, 128, 0);">/*</span><span style="color: rgb(0, 128, 0);"> 组件使用者：实现 IClientSocketListener </span></strong><span style="color: rgb(0, 128, 0);">*/</span><br><strong><span style="color: rgb(0, 0, 255);">class</span></strong> <strong>CMainClient : <span style="color: rgb(0, 0, 255);">public</span></strong> <strong>IClientSocketListener</strong><br>{<br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 这些方法会操作组件</span><span style="color: rgb(0, 128, 0);"><br></span><span style="color: rgb(0, 0, 255);">public</span>:<br>    <span style="color: rgb(0, 0, 255);">bool</span> Login(LPCTSTR pszAddress, USHORT usPort, <span style="color: rgb(0, 0, 255);">const</span> T_101_Data* pData);<br>    <span style="color: rgb(0, 0, 255);">bool</span> Logout(<span style="color: rgb(0, 0, 255);">const</span> T_201_Data* pData);<br>        BOOL SendData(EnCommandType enCmdType, <span style="color: rgb(0, 0, 255);">const</span> TCommandData* pCmdData, WORD wCmdDataLen);<br>    <span style="color: rgb(0, 0, 255);">long</span>    GetLastError();<br>    LPCTSTR    GetLastErrorDesc();<br><br><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 实现 IClientSocketListener</span><span style="color: rgb(0, 128, 0);"><br></span><span style="color: rgb(0, 0, 255);">public</span>:<br><strong>　　<span style="color: rgb(0, 0, 255);">virtual</span> EnHandleResult OnConnect(DWORD dwConnectionID);</strong><br><strong>　　<span style="color: rgb(0, 0, 255);">virtual</span> EnHandleResult OnSend(DWORD dwConnectionID, <span style="color: rgb(0, 0, 255);">const</span> BYTE* pData, <span style="color: rgb(0, 0, 255);">int</span> iLength);</strong><br><strong>　　<span style="color: rgb(0, 0, 255);">virtual</span> EnHandleResult OnReceive(DWORD dwConnectionID, <span style="color: rgb(0, 0, 255);">const</span> BYTE* pData, <span style="color: rgb(0, 0, 255);">int</span> iLen);</strong><br><strong>　　<span style="color: rgb(0, 0, 255);">virtual</span> EnHandleResult OnClose(DWORD dwConnectionID);</strong><br><strong>　　<span style="color: rgb(0, 0, 255);">virtual</span> EnHandleResult OnError(DWORD dwConnectionID, EnSocketOperation enOperation, <span style="color: rgb(0, 0, 255);">int</span> iErrorCode);</strong><br><br><span style="color: rgb(0, 0, 255);">private</span>:<br>    BOOL ParseReceiveBuffer();<br>    <br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 其它方法 。。。<br><br></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 构造函数</span><span style="color: rgb(0, 128, 0);"><br></span><span style="color: rgb(0, 0, 255);">public</span>:<br><strong>　　CMainClient()</strong><br><strong>　　<span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 创建组件，并把自己设置为组件的监听器</span><span style="color: rgb(0, 128, 0);"><br></span>　　: m_pscClient(<span style="color: rgb(0, 0, 255);">new</span> CSocketClient(<span style="color: rgb(0, 0, 255);">this</span>))</strong><br><strong>　　, m_dwConnID(<span style="color: rgb(128, 0, 128);">0</span>)</strong><br><strong>　　{</strong><br><strong>　　}</strong><br><br>    <span style="color: rgb(0, 0, 255);">virtual</span> ~CMainClient()    {}<br><br><span style="color: rgb(0, 0, 255);">private</span>:<br>　　<span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 组件属性</span><span style="color: rgb(0, 128, 0);"><br></span><strong>　　ISocketClientPtr m_pscClient;</strong><br>    DWORD               m_dwConnID;<br>    <br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 其它属性 。。。</span><span style="color: rgb(0, 128, 0);"><br></span>};</pre>
</div>
<p>&nbsp;</p>
<div class="cnblogs_code">
<pre>BOOL CMainClient::Login(LPCTSTR pszAddress, USHORT usPort, <span style="color: rgb(0, 0, 255);">const</span> T_101_Data* pData)<br>{<br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 启动通信</span><span style="color: rgb(0, 128, 0);"><br></span>    <span style="color: rgb(0, 0, 255);">return</span>    <strong>m_pscClient-&gt;Start</strong>(pszAddress, usPort) &amp;&amp;<br>            SendData(CS_C_LOGIN_REQ, pData, <span style="color: rgb(0, 0, 255);">sizeof</span>(T_101_Data));<br>}<br><br>BOOL CMainClient::Logout(<span style="color: rgb(0, 0, 255);">const</span> T_201_Data* pData)<br>{<br>    <span style="color: rgb(0, 0, 255);">if</span>(pData)<br>    {<br>        SendData(CS_C_SET_STATUS, pData, <span style="color: rgb(0, 0, 255);">sizeof</span>(T_201_Data));<br>        ::WaitWithMessageLoop(LOGOUT_WAIT_TIME);<br>    }<br><br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 停止通信</span><span style="color: rgb(0, 128, 0);"><br></span>    <span style="color: rgb(0, 0, 255);">return</span> <strong>m_pscClient-&gt;Stop()</strong>;<br>}<br><br>BOOL CMainClient::SendData(EnCommandType enCmdType, <span style="color: rgb(0, 0, 255);">const</span> TCommandData* pCmdData, WORD wCmdDataLen)<br>{<br>    <span style="color: rgb(0, 0, 255);">const</span> WORD wBufferLen    = CMD_ADDITIVE_SIZE + wCmdDataLen;<br>    CPrivateHeapByteBuffer buffer(m_hpPrivate, wBufferLen);<br>    BYTE* pBuffer    = buffer;<br><br>    memcpy(pBuffer, &amp;wBufferLen, CMD_LEN_SIZE);<br>    pBuffer += CMD_LEN_SIZE;<br>    memcpy(pBuffer, &amp;enCmdType, CMD_TYPE_SIZE);<br>    pBuffer += CMD_TYPE_SIZE;<br>    memcpy(pBuffer, pCmdData, wCmdDataLen);<br>    pBuffer += wCmdDataLen;<br>    memcpy(pBuffer, &amp;CMD_FLAG, CMD_FLAG_SIZE);<br><br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 发送数据</span><span style="color: rgb(0, 128, 0);"><br></span>    <span style="color: rgb(0, 0, 255);">return</span> <strong>m_pscClient-&gt;Send(m_dwConnID, buffer, wBufferLen)</strong>;<br>}<br><br><span style="color: rgb(0, 0, 255);">long</span> CMainClient::GetLastError()<br>{<br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 获取通信错误码</span><span style="color: rgb(0, 128, 0);"><br></span>    <span style="color: rgb(0, 0, 255);">return</span> <strong>m_pscClient-&gt;GetLastError()</strong>;<br>}<br><br>LPCTSTR CMainClient::GetLastErrorDesc()<br>{<br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 获取通信错误描述</span><span style="color: rgb(0, 128, 0);"><br></span>    <span style="color: rgb(0, 0, 255);">return</span> <strong>m_pscClient-&gt;GetLastErrorDesc()</strong>;<br>}<br><br><strong><span style="color: rgb(0, 128, 0);">/*</span><span style="color: rgb(0, 128, 0);"> 处理连接成功事件 </span><span style="color: rgb(0, 128, 0);">*/</span></strong><br><strong>ISocketListener::EnHandleResult CMainClient::OnConnect(DWORD dwConnectionID)</strong><br>{<br>    TRACE1(<span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(128, 0, 0);">&lt;CNNID: %d&gt; 已连接\n</span><span style="color: rgb(128, 0, 0);">"</span>, dwConnectionID);<br>    m_dwConnID = dwConnectionID;<br>    <span style="color: rgb(0, 0, 255);">return</span> HR_OK;<br>}<br><br><strong><span style="color: rgb(0, 128, 0);">/*</span><span style="color: rgb(0, 128, 0);"> 处理数据已发出事件 </span><span style="color: rgb(0, 128, 0);">*/</span></strong><br><strong>ISocketListener::EnHandleResult CMainClient::OnSend(DWORD dwConnectionID, <span style="color: rgb(0, 0, 255);">const</span> BYTE* pData, <span style="color: rgb(0, 0, 255);">int</span> iLength)</strong><br>{<br>    TRACE2(<span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(128, 0, 0);">&lt;CNNID: %d&gt; 发出数据包 (%d bytes)\n</span><span style="color: rgb(128, 0, 0);">"</span>, dwConnectionID, iLength);<br>    <span style="color: rgb(0, 0, 255);">return</span> HR_OK;<br>}<br><br><strong><span style="color: rgb(0, 128, 0);">/*</span><span style="color: rgb(0, 128, 0);"> 处理接收到数据事件</span></strong><strong><span style="color: rgb(0, 128, 0);">*/</span></strong><br><strong>ISocketListener::EnHandleResult CMainClient::OnReceive(DWORD dwConnectionID, <span style="color: rgb(0, 0, 255);">const</span> BYTE* pData, <span style="color: rgb(0, 0, 255);">int</span> iLen)</strong><br>{<br>    TRACE2(<span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(128, 0, 0);">&lt;CNNID: %d&gt; 接收数据包 (%d bytes)\n</span><span style="color: rgb(128, 0, 0);">"</span>, dwConnectionID, iLen);<br><br>    ASSERT(pData != NULL &amp;&amp; iLen &gt; <span style="color: rgb(128, 0, 128);">0</span>);<br><br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 保存数据</span><span style="color: rgb(0, 128, 0);"><br></span>    m_rcBuffer.Cat(pData, iLen);<br><br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 解析数据</span><span style="color: rgb(0, 128, 0);"><br></span>    <span style="color: rgb(0, 0, 255);">return</span> ParseReceiveBuffer() ? HR_OK : HR_ERROR;;<br>}<br><br><strong><span style="color: rgb(0, 128, 0);">/*</span><span style="color: rgb(0, 128, 0);"> 处理通信关闭事件</span></strong><strong><span style="color: rgb(0, 128, 0);">*/</span></strong><br><strong>ISocketListener::EnHandleResult CMainClient::OnClose(DWORD dwConnectionID)</strong><br>{<br>    TRACE1(<span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(128, 0, 0);">CNNID: %d&gt; 关闭连接\n</span><span style="color: rgb(128, 0, 0);">"</span>, dwConnectionID);<br><br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 清理缓冲区</span><span style="color: rgb(0, 128, 0);"><br></span>    m_rcBuffer.Realloc(<span style="color: rgb(128, 0, 128);">0</span>);<br>    <span style="color: rgb(0, 0, 255);">return</span> HR_OK;<br>}<br><br><strong><span style="color: rgb(0, 128, 0);">/*</span><span style="color: rgb(0, 128, 0);"> 处理通信错误事件 </span></strong><span style="color: rgb(0, 128, 0);">*/</span><br><strong>ISocketListener::EnHandleResult CMainClient::OnError(DWORD dwConnectionID, EnSocketOperation enOperation, <span style="color: rgb(0, 0, 255);">int</span> iErrorCode)</strong><br>{<br>    TRACE3(<span style="color: rgb(128, 0, 0);">"</span><span style="color: rgb(128, 0, 0);">&lt;CNNID: %d&gt; 网络错误 (OP: %d, CO: %d)\n</span><span style="color: rgb(128, 0, 0);">"</span>, dwConnectionID, enOperation, iErrorCode);<br><br>    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> 清理缓冲区</span><span style="color: rgb(0, 128, 0);"><br></span>    m_rcBuffer.Realloc(<span style="color: rgb(128, 0, 128);">0</span>);<br><br>    <span style="color: rgb(0, 0, 255);">return</span> HR_OK;<br>}</pre>
</div>
<p>&nbsp;</p>
<p>　　好了，码了<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>晚上的字，累啊！到此为止吧，感谢收看~</p>
<p>　　敬请继续收看《<a href="http://www.cnblogs.com/ldcsaa/archive/2012/02/25/2367409.html" target="_top"><strong>基于 IOCP 的通用异步 <b style="color: black; background-color: rgb(153, 255, 153);">Windows</b> <b style="color: black; background-color: rgb(255, 153, 153);">Socket</b> TCP 高性能服务端组件的设计与实现</strong></a>》，晚安 ^_^</p>
<p>&nbsp;</p>
<p>　　（<a href="http://files.cnblogs.com/ldcsaa/socket.zip" target="_top">想看源代码的朋友请狂点这里</a>）<br>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div id="MySignature"><strong style="color: rgb(128, 0, 0);">原文出处：</strong><a href="http://www.cnblogs.com/ldcsaa" target="_top"><strong>怪兽的博客</strong></a><strong>&nbsp;&nbsp;</strong><a href="http://weibo.com/u/1402935851" target="_top"><strong>怪兽的微博</strong></a></div>

<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag">标签: <a href="http://www.cnblogs.com/ldcsaa/tag/c%2B%2B/">c++</a>, <a href="http://www.cnblogs.com/ldcsaa/tag/windows/"><b style="color: black; background-color: rgb(153, 255, 153);">windows</b></a>, <a href="http://www.cnblogs.com/ldcsaa/tag/socket/"><b style="color: black; background-color: rgb(255, 153, 153);">socket</b></a>, <a href="http://www.cnblogs.com/ldcsaa/tag/TCP/">TCP</a>, <a href="http://www.cnblogs.com/ldcsaa/tag/%E5%AE%A2%E6%88%B7%E7%AB%AF/">客户端</a></div>
<div id="green_channel" style="display: none;">
绿色通道：<a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(cb_entryId,cb_blogId,1);green_channel_success(this,'谢谢推荐！');">好文要顶</a><a id="green_channel_follow" onclick="c_follow();" href="javascript:void(0);">关注我</a><a id="green_channel_favorite" onclick="AddToWz(2351756);return false;" href="javascript:void(0);">收藏该文</a><a id="green_channel_contact" href="http://space.cnblogs.com/msg/send/%7e%e6%80%aa%5e_*%e5%85%bd%7e" target="_top">与我联系</a>
<a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="icon_sina.gif" alt=""></a>
</div>
<div id="digg_block">
<div id="author_profile">
<div id="author_profile_info" class="author_profile_info">
<div id="author_profile_detail" class="author_profile_info">
</div>
</div>
<div class="clear"></div>
<div id="author_profile_honor"></div>
<div id="author_profile_follow"></div>
</div>
<div id="div_digg" style="display: none;">										
	<div class="diggit" onclick="DiggIt(cb_entryId,cb_blogId,1)"> 
		<span class="diggnum" id="digg_count"></span>
	</div>
	<div class="buryit" onclick="DiggIt(cb_entryId,cb_blogId,2)"> 
		<span class="burynum" id="bury_count"></span>
	</div>
	<div class="clear"></div>	
	<div class="diggword" id="digg_tips"></div>	
</div>
</div>
<div class="clear"></div>
<div id="post_next_prev">
</div>
</div>





		<p class="postfoot">
			posted on 2012-02-15 01:26 <a href="http://www.cnblogs.com/ldcsaa/">~怪^_*兽~</a> 阅读(1850) <a href="#commentform">评论(16)</a>  <a href="http://www.cnblogs.com/ldcsaa/admin/EditPosts.aspx?postid=2351756" rel="nofollow">编辑</a> <a href="#" onclick="AddToWz(2351756);return false;">收藏</a>
		</p>
	</div>
	<img src="2351756.html" alt="" height="1px" width="1px">
	
	<a name="pagedcomment"></a>
<a name="评论">
</a><div id="comments"><a name="评论">
<h3>评论</h3>
<span id="span_comment_maxid" style="display: none;">2317371</span>

		</a><h4><a name="评论">
			</a><a href="#2308973">#1楼</a><a name="2308973" id="comment_anchor_2308973"></a>
				<span>
					<span class="comment_date">2012-02-15 10:19</span>
				</span>
			<a id="Comments1_CommentList_NameLink_0" rel="nofllow" href="http://home.cnblogs.com/u/292797/" target="_top">Stephen_Liu</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/Stephen_Liu" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2308973" class="blog_comment_body">看来楼主写程序不喜欢考虑平台迁移的问题。</span>
			　<a onclick='ReplyComment("Stephen_Liu",2308973,"Lx6qd1qqdCh/HEwBgiIq+B3lwM+oTfoI23JY7CPg3EC9HXhSc7YnaQ==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2308973,"Lx6qd1qqdCh/HEwBgiIq+B3lwM+oTfoI23JY7CPg3EC9HXhSc7YnaQ==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=Stephen_Liu" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_0" href="javascript:__doPostBack('Comments1$CommentList$ctl00$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_0"></a>
		</p>
	
		<h4>
			<a href="#2309060">#2楼</a><a name="2309060" id="comment_anchor_2309060"></a>
				<span>
					<span class="comment_date">2012-02-15 11:14</span>
				</span>
			<a id="Comments1_CommentList_NameLink_1" rel="nofllow" href="http://home.cnblogs.com/u/148166/" target="_top">忆民</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/%e5%bf%86%e6%b0%91" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2309060" class="blog_comment_body">不错，顶<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>，希望能把这个模块代码全部出来，呵呵</span>
			　<a onclick='ReplyComment("忆民",2309060,"WN31eEmP5tsYi1ho0nUAarLdk9e2Zh7mPiiCcg1aFCumlZy3tLsAkg==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2309060,"WN31eEmP5tsYi1ho0nUAarLdk9e2Zh7mPiiCcg1aFCumlZy3tLsAkg==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=%e5%bf%86%e6%b0%91" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_1" href="javascript:__doPostBack('Comments1$CommentList$ctl01$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_1"></a>
		</p>
	
		<h4>
			<a href="#2309159">#3楼</a><a name="2309159" id="comment_anchor_2309159"></a>[<span class="louzhu">楼主</span>]
				<span>
					<span class="comment_date">2012-02-15 12:30</span>
				</span>
			<a id="Comments1_CommentList_NameLink_2" rel="nofllow" href="http://home.cnblogs.com/u/373909/" target="_top">~怪^_*兽~</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/%7e%e6%80%aa%5e_*%e5%85%bd%7e" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2309159" class="blog_comment_body"><a href="#2308973" title="查看所回复的评论">@</a>Stephen_Liu<br>哈哈，这样说吧：<br>1、标题已经说清楚是针对<b style="color: black; background-color: rgb(153, 255, 153);">Windows</b> <b style="color: black; background-color: rgb(255, 153, 153);">Socket</b>的通信组件，只适合<b style="color: black; background-color: rgb(153, 255, 153);">WIndows</b> 和 <b style="color: black; background-color: rgb(153, 255, 153);">Windows</b> CE，但不能因为本座专门针对<b style="color: black; background-color: rgb(153, 255, 153);">Windows</b>写了些东西就说本座不喜欢考虑平台移植哦。<br>2、对于这个组件来说，移植其实不复杂：a、组件用Template模式实现，公共高层方法封装到父类，底层通信细节在子类实现；b、组件的使用方式可以采用Strategy模式或者Bridge模式。<br>3、最重要一点：考虑移植是否有必要，就本座说接触的大部分C++写的应用程序来说（系统工具除外），绝大部分是不需要考虑移植的。例如：给你<b style="color: black; background-color: rgb(153, 255, 153);">Windows</b>的服务器和Sql Server数据库，要你写<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>在线教育系统，你会不会想：“哇塞，以后服务器换成Linux或Mac下用MySQL怎么办，那我必须写可以移植的服务器；哇塞，客户端以后用Mac、iPad甚至Kingdle怎么办，那我必须写可以移植的客户端。”要知道系统的负责性是几何级数增长的，其实设计过度的危害更大于设计不足，轻则超资、项目延期，重则项目终止。而这点通常是我们这些所谓“技术流”的通病。</span>
			　<a onclick='ReplyComment("~怪^_*兽~",2309159,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2309159,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=%7e%e6%80%aa%5e_*%e5%85%bd%7e" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_2" href="javascript:__doPostBack('Comments1$CommentList$ctl02$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_2"></a>
		</p>
	
		<h4>
			<a href="#2309161">#4楼</a><a name="2309161" id="comment_anchor_2309161"></a>[<span class="louzhu">楼主</span>]
				<span>
					<span class="comment_date">2012-02-15 12:31</span>
				</span>
			<a id="Comments1_CommentList_NameLink_3" rel="nofllow" href="http://home.cnblogs.com/u/373909/" target="_top">~怪^_*兽~</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/%7e%e6%80%aa%5e_*%e5%85%bd%7e" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2309161" class="blog_comment_body"><a href="#2309060" title="查看所回复的评论">@</a>忆民<br>不是已经发了么，没看到？</span>
			　<a onclick='ReplyComment("~怪^_*兽~",2309161,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2309161,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=%7e%e6%80%aa%5e_*%e5%85%bd%7e" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_3" href="javascript:__doPostBack('Comments1$CommentList$ctl03$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_3"></a>
		</p>
	
		<h4>
			<a href="#2309173">#5楼</a><a name="2309173" id="comment_anchor_2309173"></a>
				<span>
					<span class="comment_date">2012-02-15 12:42</span>
				</span>
			<a id="Comments1_CommentList_NameLink_4" rel="nofllow" href="http://home.cnblogs.com/u/292797/" target="_top">Stephen_Liu</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/Stephen_Liu" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2309173" class="blog_comment_body"><a href="#2309159" title="查看所回复的评论">@</a>~怪^_*兽~<br>首先说一下跨平台问题，基于C/C++实现跨平台时，并不是几个设计模式或者模板可以解决的，支持的平台越多细节越多。至于楼主给出的这些例证，我想很多都是基于小项目或者是小产品的，对于<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>成熟的中/大型项目或产品来说，系统平台和数据库平台的可迁移性是需要在架构设计期间予以充分考虑的，特别是平板电脑和移动智能设备蒸蒸日上的今天，这个技术问题就更加显而易见了。至于刚才的评论，楼主不用多想，只是个人的一点儿建议而已，因为我认为<b style="color: black; background-color: rgb(255, 153, 153);">socket</b> client的设计可简可繁，事实上它对平台的依赖性是比较低的，除非使用iocp或者重叠io这样的win32特有技术。</span>
			　<a onclick='ReplyComment("Stephen_Liu",2309173,"Lx6qd1qqdCh/HEwBgiIq+B3lwM+oTfoI23JY7CPg3EC9HXhSc7YnaQ==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2309173,"Lx6qd1qqdCh/HEwBgiIq+B3lwM+oTfoI23JY7CPg3EC9HXhSc7YnaQ==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=Stephen_Liu" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_4" href="javascript:__doPostBack('Comments1$CommentList$ctl04$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_4"></a>
		</p>
	
		<h4>
			<a href="#2309186">#6楼</a><a name="2309186" id="comment_anchor_2309186"></a>[<span class="louzhu">楼主</span>]
				<span>
					<span class="comment_date">2012-02-15 12:52</span>
				</span>
			<a id="Comments1_CommentList_NameLink_5" rel="nofllow" href="http://home.cnblogs.com/u/373909/" target="_top">~怪^_*兽~</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/%7e%e6%80%aa%5e_*%e5%85%bd%7e" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2309186" class="blog_comment_body"><a href="#2309173" title="查看所回复的评论">@</a>Stephen_Liu<br>哈哈，建议不错，本座接受。不过再讨论下去得开一篇先博文专门谈论移植了，还是围绕本文的主题吧。</span>
			　<a onclick='ReplyComment("~怪^_*兽~",2309186,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2309186,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=%7e%e6%80%aa%5e_*%e5%85%bd%7e" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_5" href="javascript:__doPostBack('Comments1$CommentList$ctl05$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_5"></a>
		</p>
	
		<h4>
			<a href="#2314578">#7楼</a><a name="2314578" id="comment_anchor_2314578"></a>
				<span>
					<span class="comment_date">2012-02-22 17:04</span>
				</span>
			<a id="Comments1_CommentList_NameLink_6" rel="nofllow" href="http://home.cnblogs.com/u/142322/" target="_top">WillMyPower</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/WillMyPower" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2314578" class="blog_comment_body">我自己也写了<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>和楼主类似功能的TCP通信组件，封装成DLL组件(函数接口)，不过基于select查询模式构建，另外加入了可选的包头包尾的封包解析(算是和上层掺合了，用于自己的C/S小项目)。只是服务器端的多连接的运行效率有些问题，看楼主的代码，获益匪浅啊，楼主的知识面不是我这种民工能比的，有时间看看能不能将服务器端改造成楼主的IOCP模式。不过还是有些疑虑想和楼主探讨一下，<br><br>1，有没有考虑过异常断线的情况？比例拔网线，网络断了等等，你的代码基于事件机制，这种情况下是收不到任何事件的(我试过select和WSAAsyncSelect都检测不到)，例如服务器接收到<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>连接，分配了<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>连接资源，结果客户端异常断线，但服务器却不知道，这种情况需不需要在组件内部解决？还是让调用者去考虑？ 如果调用者没有考虑这个问题，在网络环境不佳的时候，这将导致服务器端越来越多的无效连接，导致内存泄漏。<br><br>2，关于可用性问题。这个问题其实和上面也是有些关系的，上面问题可以让调用者通过两端发送自定义的心跳包的形式来解决，多长时间没有接收到心跳包，认为异常断线，释放相关资源。还有封包解包需不需要在组件内部实现？但在上层协议处理解包封包和异常断线的问题，目前有2个缺陷<br><br>第<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>缺陷:易用性已经很差了，调用者需要考虑很多和他业务逻辑无关的东西了。封包解包，需要调用者对字节内存方面的知识需要较强掌握，字节对齐新手是不懂的，包头包尾，校验，以及粘包问题这都需要比较多的编程经验，要是NET和VB程序员那更是艰难了(我的组件是DLL形式，方便其他编程语言的程序员调用)，稍有不慎就会有BUG，当然对于楼主这种高水平的大侠当然没问题，但对于那些新手来说刚写个一两年C++程序(我手下是NET程序员)，这却是有些难了。还有异常断线的处理也是和功能逻辑无关的东西，但要是在调用端写的话，需要写很多的代码和考虑。想要做到完善，调用方没有较高水平是很难处理好。<br><br>第二个缺陷:性能问题，让调用者处理封包解包和异常断线问题，对性能有很大损失，调用层处理这些问题，除非你开放更多的接口函数，否则会有重复内存申请，<a name="baidusnap4"></a><b style="color: black; background-color: rgb(255, 102, 255);">多次</b>的对象构造和解析，甚至线程的开启关闭，但如果将这两个工作放到组件内部的话，能少很多工作，性能也行得到大大的提升<br><br>针对上面的问题，我的组件中在内部加入了封包解包过程，当然这影响易用性，但可以做成可选形式，并加入定时发送检测心跳包的功能，当然这也是可选择的。<br>  <br>   我的水平有限，如果我的问题在楼主那里都不是问题，还望不吝指教，呵呵。</span>
			　<a onclick='ReplyComment("WillMyPower",2314578,"s8rylR9fK2PTf89JDIeKjKel9T7wxT3Yy6jMYNny3WpfEsrZUyq3RQ==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2314578,"s8rylR9fK2PTf89JDIeKjKel9T7wxT3Yy6jMYNny3WpfEsrZUyq3RQ==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=WillMyPower" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_6" href="javascript:__doPostBack('Comments1$CommentList$ctl06$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_6"></a>
		</p>
	
		<h4>
			<a href="#2314784">#8楼</a><a name="2314784" id="comment_anchor_2314784"></a>[<span class="louzhu">楼主</span>]
				<span>
					<span class="comment_date">2012-02-22 22:57</span>
				</span>
			<a id="Comments1_CommentList_NameLink_7" rel="nofllow" href="http://home.cnblogs.com/u/373909/" target="_top">~怪^_*兽~</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/%7e%e6%80%aa%5e_*%e5%85%bd%7e" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2314784" class="blog_comment_body"><a href="#2314578" title="查看所回复的评论">@</a>WillMyPower<br>1，有没有考虑过异常断线的情况？<br>答：客户端和服务器同时用setsockopt()设置心跳，断线时自动接收到 <b style="color: black; background-color: rgb(255, 153, 153);">socket</b> error 事件。其实已经有了，请看官下载代码看看。看这里的定义就知道：DEFALUT_KEEPALIVE_TIMES = 3;DEFALUT_KEEPALIVE_INTERVAL = 10 * 1000;<br><br>2、心跳包不用自定义（同上），<b style="color: black; background-color: rgb(255, 153, 153);">socket</b>本身支持。<br><br>3、封解包完全是上层协议，由上层处理。另外，在实际应用中有<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>非常有效的方法：直接把<b style="color: black; background-color: rgb(255, 255, 102);">一个</b> struct 当作缓冲区发送出去，接收到后把指针强制转换为 struct，这样会省去你很多烦恼，也不用管什么字节对齐，也不用转来转去，其实这些本来就不用考虑的，<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>sizeof(T)就行了。<br><br>4、封包解包由谁处理对整体性能没影响，纯粹和零游戏。<br><br>5、总结你的问题：1、上层协议没有定义得足够好；2、封解包的算法或实现方法有待优化；</span>
			　<a onclick='ReplyComment("~怪^_*兽~",2314784,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2314784,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=%7e%e6%80%aa%5e_*%e5%85%bd%7e" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_7" href="javascript:__doPostBack('Comments1$CommentList$ctl07$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_7"></a>
		</p>
	
		<h4>
			<a href="#2314994">#9楼</a><a name="2314994" id="comment_anchor_2314994"></a>
				<span>
					<span class="comment_date">2012-02-23 10:40</span>
				</span>
			<a id="Comments1_CommentList_NameLink_8" rel="nofllow" href="http://home.cnblogs.com/u/142322/" target="_top">WillMyPower</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/WillMyPower" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2314994" class="blog_comment_body"><a href="#2314784" title="查看所回复的评论">@</a>~怪^_*兽~<br>1，<b style="color: black; background-color: rgb(255, 153, 153);">socket</b>内置心跳包功能是我学识浅陋了，多谢<br>2,封包解包的问题，我不太认同你的看法(貌似这个和楼主的议题无关了)，<br>第<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>问题，包大小一，就会有不同大小的struct，来了一段数据你准备强制转为哪种struct？这个问题我目前有两个处理方法， <br>1，定义<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>指定struct类型的type字段，但有了这个字段又必须要有个包头了，否则你无法知道这个指定类型的字段在哪里，你的封包解包简单化想法行不通。<br>2，通过将所有struct分解成统一大小的struct，貌似电驴就是这个方式，实现起来比较复杂，<br>第二个问题,丢包，错误包问题，TCP协议虽然说是可靠传输协议，但可靠是首先建立在连接可靠的情况下，如果连接不可靠，数据也是不可靠的，实际中TCP也是有丢包和错误包的情况(网上下载的大文件比如游戏都会建议你校验MD5码)，尤其网络环境不好的情况(当年在学校网络时断时连，经常下到错误文件)，这些情况是简单的处理方法行不通的。</span>
			　<a onclick='ReplyComment("WillMyPower",2314994,"s8rylR9fK2PTf89JDIeKjKel9T7wxT3Yy6jMYNny3WpfEsrZUyq3RQ==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2314994,"s8rylR9fK2PTf89JDIeKjKel9T7wxT3Yy6jMYNny3WpfEsrZUyq3RQ==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=WillMyPower" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_8" href="javascript:__doPostBack('Comments1$CommentList$ctl08$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_8"></a>
		</p>
	
		<h4>
			<a href="#2315104">#10楼</a><a name="2315104" id="comment_anchor_2315104"></a>
				<span>
					<span class="comment_date">2012-02-23 12:02</span>
				</span>
			<a id="Comments1_CommentList_NameLink_9" rel="nofllow" href="http://home.cnblogs.com/u/142322/" target="_top">WillMyPower</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/WillMyPower" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2315104" class="blog_comment_body">呵呵，不讨论上层协议的问题了，看了你的代码，其实大同小异。<br>仔细看了一下你的代码，发现一些其他的问题<br>1，virtual BOOL GetConnectionAddress(DWORD dwConnID, CString&amp; strAddress, USHORT&amp; usPort)	= 0;<br>为何用CString？和MFC掺合在一起？<br><br>2，通过虚函数实现事件通知接口是否是最好的方法？<br>   我个人更喜欢函数指针方式，因为更简洁。而且可以跨语言<br><br>3，CSocketClient::Send貌似可能导致死锁，<br>   由于楼主源代码缺少一些文件，我将我的想象情况说一下<br>   SendData完成后调用<br>    FireSend(m_dwConnID, m_sndBuffer, total - left);<br>   此时m_scBuffer未解锁，如果调用者在FireSend的实现函数中调用   send，需要锁定m_scBuffer，此时还在SendData函数，这时候是不是已经死锁了？未测试，只是推测。</span>
			　<a onclick='ReplyComment("WillMyPower",2315104,"s8rylR9fK2PTf89JDIeKjKel9T7wxT3Yy6jMYNny3WpfEsrZUyq3RQ==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2315104,"s8rylR9fK2PTf89JDIeKjKel9T7wxT3Yy6jMYNny3WpfEsrZUyq3RQ==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=WillMyPower" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_9" href="javascript:__doPostBack('Comments1$CommentList$ctl09$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_9"></a>
		</p>
	
		<h4>
			<a href="#2315251">#11楼</a><a name="2315251" id="comment_anchor_2315251"></a>[<span class="louzhu">楼主</span>]
				<span>
					<span class="comment_date">2012-02-23 14:13</span>
				</span>
			<a id="Comments1_CommentList_NameLink_10" rel="nofllow" href="http://home.cnblogs.com/u/373909/" target="_top">~怪^_*兽~</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/%7e%e6%80%aa%5e_*%e5%85%bd%7e" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2315251" class="blog_comment_body"><a href="#2315104" title="查看所回复的评论">@</a>WillMyPower<br>1、谁说CString 就一定是 mfc？参考：atlstr.h。<br>2、函数指针确实可以做很多工作，但既然用C++就用它的面向对象和安全性，如果要跨语言最好写成 COM 组件，也是用 virtual 实现，其他语言调用起来更方便。<br>3、首先，OnSend 通常只做记录，不在起中发数据，另外即使要发数据也没问题，CriticalSession 是线程可重入的。</span>
			　<a onclick='ReplyComment("~怪^_*兽~",2315251,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2315251,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=%7e%e6%80%aa%5e_*%e5%85%bd%7e" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_10" href="javascript:__doPostBack('Comments1$CommentList$ctl10$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_10"></a>
		</p>
	
		<h4>
			<a href="#2315277">#12楼</a><a name="2315277" id="comment_anchor_2315277"></a>[<span class="louzhu">楼主</span>]
				<span>
					<span class="comment_date">2012-02-23 14:36</span>
				</span>
			<a id="Comments1_CommentList_NameLink_11" rel="nofllow" href="http://home.cnblogs.com/u/373909/" target="_top">~怪^_*兽~</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/%7e%e6%80%aa%5e_*%e5%85%bd%7e" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2315277" class="blog_comment_body"><a href="#2315104" title="查看所回复的评论">@</a>WillMyPower<br>对于 OnSend 方法这里多说明一下：基于一般的使用情形，不会在 OnSend 方法中发数据，所以这里做了优化，直接使用 m_sndBuffer 的指针作为 OnSend 参数。如果真的要在 OnSend 中发数据可以这样修改：<br>1、复制<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>缓冲区作为 OnSend 的参数<br>2、调用 m_sndBuffer.Realloc(left)<br>3、调用 FireSend(m_dwConnID, myBuffer, size);</span>
			　<a onclick='ReplyComment("~怪^_*兽~",2315277,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2315277,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=%7e%e6%80%aa%5e_*%e5%85%bd%7e" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_11" href="javascript:__doPostBack('Comments1$CommentList$ctl11$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_11"></a>
		</p>
	
		<h4>
			<a href="#2315314">#13楼</a><a name="2315314" id="comment_anchor_2315314"></a>
				<span>
					<span class="comment_date">2012-02-23 15:12</span>
				</span>
			<a id="Comments1_CommentList_NameLink_12" rel="nofllow" href="http://home.cnblogs.com/u/142322/" target="_top">WillMyPower</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/WillMyPower" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2315314" class="blog_comment_body"><a href="#2315277" title="查看所回复的评论">@</a>~怪^_*兽~<br>受教了</span>
			　<a onclick='ReplyComment("WillMyPower",2315314,"s8rylR9fK2PTf89JDIeKjKel9T7wxT3Yy6jMYNny3WpfEsrZUyq3RQ==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2315314,"s8rylR9fK2PTf89JDIeKjKel9T7wxT3Yy6jMYNny3WpfEsrZUyq3RQ==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=WillMyPower" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_12" href="javascript:__doPostBack('Comments1$CommentList$ctl12$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_12"></a>
		</p>
	
		<h4>
			<a href="#2315341">#14楼</a><a name="2315341" id="comment_anchor_2315341"></a>[<span class="louzhu">楼主</span>]
				<span>
					<span class="comment_date">2012-02-23 15:36</span>
				</span>
			<a id="Comments1_CommentList_NameLink_13" rel="nofllow" href="http://home.cnblogs.com/u/373909/" target="_top">~怪^_*兽~</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/%7e%e6%80%aa%5e_*%e5%85%bd%7e" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2315341" class="blog_comment_body"><a href="#2315314" title="查看所回复的评论">@</a>WillMyPower<br>U R Well Come ^_^</span>
			　<a onclick='ReplyComment("~怪^_*兽~",2315341,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2315341,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=%7e%e6%80%aa%5e_*%e5%85%bd%7e" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_13" href="javascript:__doPostBack('Comments1$CommentList$ctl13$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_13"></a>
		</p>
	
		<h4>
			<a href="#2317240">#15楼</a><a name="2317240" id="comment_anchor_2317240"></a>
				<span>
					<span class="comment_date">2012-02-26 20:20</span>
				</span>
			<a id="Comments1_CommentList_NameLink_14" rel="nofllow" href="http://home.cnblogs.com/u/379435/" target="_top">driftflys</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/driftflys" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2317240" class="blog_comment_body">顶。<br>提个建议：对于客户端应用而言，线程是个非常珍贵的资源，其实哪都是&lt;:)。所以是否可以诞生CSocketReactor的概念，在里面完成多个<b style="color: black; background-color: rgb(255, 153, 153);">socket</b>的事件监听。</span>
			　<a onclick='ReplyComment("driftflys",2317240,"hFSd2DVg2trCFjahD2fgZT+m6WGmDiS/yGAU/953zMqp8gJDswY0ow==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2317240,"hFSd2DVg2trCFjahD2fgZT+m6WGmDiS/yGAU/953zMqp8gJDswY0ow==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=driftflys" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_14" href="javascript:__doPostBack('Comments1$CommentList$ctl14$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_14"></a>
		</p>
	
		<h4>
			<a href="#2317371">#16楼</a><a name="2317371" id="comment_anchor_2317371"></a>[<span class="louzhu">楼主</span>]<a name="Post"></a>
				<span>
					<span class="comment_date">2012-02-26 23:49</span>
				</span>
			<a id="Comments1_CommentList_NameLink_15" rel="nofllow" href="http://home.cnblogs.com/u/373909/" target="_top">~怪^_*兽~</a>&nbsp;<a href="http://space.cnblogs.com/msg/send/%7e%e6%80%aa%5e_*%e5%85%bd%7e" title="给此人发送站内短消息" class="sendMsg2This">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
		</h4>
		<p>
			<span id="comment_body_2317371" class="blog_comment_body"><a href="#2317240" title="查看所回复的评论">@</a>driftflys<br><b style="color: black; background-color: rgb(255, 255, 102);">一个</b>线程监听多个sock原理似乎很简单，在 WaitForMultiObjects 中等待多几个HANDLE 就是了，但真正实现起来不是那么简单的，首先要在组件内部维护多个sock的状态，向上层通知时也要上层管理和辨别是哪个连接，增加了使用者的复杂性，另外组件还要处理部分sock关闭的情形。再来结合一般应用的实际使用情况，<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>客户端连接3个以上服务器的情形不多，即使有也是独立管理的，而<b style="color: black; background-color: rgb(255, 255, 102);">一个</b>客户端通过多个sock连接同一台服务器的情形就更少了。最后，其实对于现代计算机来说，线程根本不是什么稀缺资源，看看那些下载软件，动不动就十几二十个线程。</span>
			　<a onclick='ReplyComment("~怪^_*兽~",2317371,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">回复</a>　<a onclick='QuoteComment(2317371,"CxhQKcjjw5tvAoSjCvAoFDyzp9zG7HQwnWYCjuQHWEtzKDerVG9sDw==")' href="http://www.cnblogs.com/ldcsaa/archive/2012/02/15/2351756.html#commentform">引用</a>　<a title="查看该作者发表过的评论" href="http://www.cnblogs.com/CommentsByAuthor.aspx?author=%7e%e6%80%aa%5e_*%e5%85%bd%7e" target="_top">查看</a>　<a id="Comments1_CommentList_DeleteLink_15" href="javascript:__doPostBack('Comments1$CommentList$ctl15$DeleteLink','')"></a>&nbsp;&nbsp;<a id="Comments1_CommentList_EditLink_15"></a>
		</p>
	
</div>
<div id="comment_form" class="commentform">
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="#" onclick="return RefreshCommentList(cb_entryId);" name="commentform" id="lnk_RefreshComments">刷新评论列表</a><a href="#" onclick="return RefreshPage();">刷新页面</a><a href="#top">返回顶部</a></div>
<div id="comment_form_container"></div>



<div class="ad_text_commentbox"><a href="http://q.cnblogs.com/" target="_top">程序员问答社区，解决您的IT难题</a></div>
<div id="clear_read_link"></div>

<div id="site_nav_under">
<a href="http://www.cnblogs.com/" target="_top" title="程序员的网上家园">网站首页</a><a href="http://q.cnblogs.com/" target="_top" title="程序员问答社区">博问</a><a href="http://news.cnblogs.com/" target="_top" title="IT新闻">新闻</a><a href="http://home.cnblogs.com/ing/" target="_top">闪存</a><a href="http://job.cnblogs.com/" target="_top">程序员招聘</a><a href="http://kb.cnblogs.com/" target="_top">知识库</a> 
<div id="site_editor_opt"></div>

</div>






<div id="google_ad_c1" class="c_ad_block">
<!-- cnblogs_blogpost_C1 -->
<div id="div-gpt-ad-1320933818841-0" style="width: 300px; height: 250px;">

</div>
</div>

<div class="itnews c_ad_block">
<b>最新IT新闻</b>:<br>

          ·  <a href="http://news.cnblogs.com/n/141168/" target="_top">甲骨文拒绝就安腾芯片诉讼与惠普和解</a><br>
	
          ·  <a href="http://news.cnblogs.com/n/141167/" target="_top">硅谷科技达人新爱好：自制遥控无人机</a><br>
	
          ·  <a href="http://news.cnblogs.com/n/141166/" target="_top">惠普企业集团重组 符标榜接管大中华区业务</a><br>
	
          ·  <a href="http://news.cnblogs.com/n/141164/" target="_top">乔布斯曾在Mac机内部广告片中扮演罗斯福</a><br>
	
          ·  <a href="http://news.cnblogs.com/n/141163/" target="_top">雅虎发布致股东公开信：仍愿与股东公开对话</a><br>
	
» <a href="http://news.cnblogs.com/" title="IT新闻" target="_top">更多新闻...</a>
</div>


<div class="itnews c_ad_block" id="kb_block">
<b>最新知识库文章</b>:<br>
<div id="kb_recent">

·  <a href="http://kb.cnblogs.com/page/140612/" target="_top">版本控制入门简介</a><br>

·  <a href="http://kb.cnblogs.com/page/140870/" target="_top">Javascript 编程风格</a><br>

·  <a href="http://kb.cnblogs.com/page/140950/" target="_top">通天塔导游 - 细数各种编程语言优缺点</a><br>

·  <a href="http://kb.cnblogs.com/page/140015/" target="_top">中文编码杂谈</a><br>

·  <a href="http://kb.cnblogs.com/page/133920/" target="_top">有效进行软件重用的小提示</a><br>

</div>
» <a href="http://kb.cnblogs.com/" target="_top">更多知识库文章...</a>
</div>

<div id="google_ad_c2" class="c_ad_block">
<!-- cnblogs_blogpost_C2 -->
<div id="div-gpt-ad-1320933818841-1" style="width: 468px; height: 60px;">

</div>
</div>
<div id="ad_under_comment2" class="c_ad_block" style="display: none;">
<a href="http://www.china-pub.com/STATIC07/1204/mz_qhwk/mz_qhwk.asp" target="_top" rel="nofollow"><img src="china-pub-20120419.jpg" alt="" style="border: 0px none;"></a><br>
<a href="http://www.china-pub.com/sale/usedbook.aspx" target="_top" rel="nofollow">China-Pub 低价书精选</a><br>
<a href="http://www.china-pub.com/static07/0901/zh_jueba_090121.asp" target="_top" rel="nofollow">China-Pub 计算机绝版图书按需印刷服务</a><br>
</div>


<div id="HistoryToday" class="c_ad_block">
</div>

</div>




			
</div>

<p id="footer">
	Powered by: 
	<br>
	
	<a id="Footer1_Hyperlink3" name="Hyperlink1" href="http://www.cnblogs.com/"><font face="Verdana">博客园</font></a>
	<br>
	Copyright © ~怪^_*兽~
</p>


</form> 






</div>



</body>
</html>
